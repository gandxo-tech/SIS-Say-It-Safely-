<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Chat anonyme — Discutez en toute confidentialité | SIS Say-It-Safely</title>
<meta name="description" content="Rejoignez le chat anonyme de SIS Say-It-Safely et discutez en toute sécurité et confidentialité avec d’autres utilisateurs.">
<meta name="keywords" content="chat anonyme, discussion privée, messages anonymes, sécurisé, confidentiel, SIS, Say-It-Safely">
<link rel="canonical" href="https://sis-say-it-safely-pi.vercel.app/chatanonyme.html">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body { font-family: Arial, sans-serif; background-color: #b6e5f7; margin:0; padding:0; display:flex; flex-direction:column; align-items:center; height:100vh;}
  h1 { margin:20px 0; color:#004d99; text-shadow:1px 1px 2px #a0c4e8;}
  #onlineUsers,#statusMessage { background:#fff; padding:10px 20px; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.2); margin-bottom:10px; font-size:16px; color:#004d99; text-align:center;}
  #statusMessage span { animation: blink 1s infinite;} @keyframes blink {0%,100%{opacity:1;}50%{opacity:0;}}
  #discuterBtn, #uploadAvatarBtn, #quitBtn { background:#004d99; color:#fff; border:none; border-radius:12px; padding:12px 20px; font-size:16px; cursor:pointer; margin-bottom:10px;}
  #discuterBtn:hover, #uploadAvatarBtn:hover, #quitBtn:hover { background:#003366; }
  #quitBtn { background:#cc0000; margin-top:10px; display:none; }
  #quitBtn:hover { background:#990000; }
  #avatarPreview { width:50px; height:50px; border-radius:50%; margin-bottom:10px; object-fit:cover; display:none; }
  #chatSection { display:none; flex-direction:column; justify-content:space-between; width:100%; max-width:500px; height:70%; background:#fff; border-radius:16px; box-shadow:0 4px 12px rgba(0,0,0,0.2); overflow:hidden; animation:fadeIn 0.5s ease;}
  @keyframes fadeIn { from{opacity:0} to{opacity:1} }
  #messages { flex:1; padding:15px; overflow-y:auto; display:flex; flex-direction:column; gap:10px;}
  .message-container { display:flex; align-items:flex-end; animation:pop 0.2s ease; position:relative;}
  @keyframes pop { from{transform:scale(0.8);opacity:0} to{transform:scale(1);opacity:1} }
  .message-container.me { flex-direction: row-reverse; }
  .message-container img { width:35px; height:35px; border-radius:50%; margin:0 8px;}
  .message-text { border-radius:20px; padding:10px 15px; line-height:1.4; position:relative; max-width:70%; word-wrap:break-word; box-shadow:0 2px 5px rgba(0,0,0,0.1);}
  .me .message-text { background:#004d99; color:#fff; }
  .other .message-text { background:#e0e0e0; color:#000; }
  .message-time { font-size:10px; color:#ccc; margin-top:4px; text-align:right;}
  .seen { font-size:10px; color:#0a0; margin-left:5px; }
  .system { background:#f0f0f0; color:#555; font-style:italic; text-align:center; align-self:center; border-radius:12px; padding:6px 12px; box-shadow:0 1px 3px rgba(0,0,0,0.1);}
  #inputSection { display:flex; flex-direction:column; padding:10px; background:#f9f9f9; border-top:1px solid #ddd;}
  #replyPreview { display:none; padding:8px 12px; background:#e0e0e0; border-left:4px solid #004d99; border-radius:12px; margin-bottom:5px; font-size:14px; color:#000; position:relative;}
  #cancelReply { cursor:pointer; position:absolute; top:4px; right:8px; color:#004d99; font-weight:bold;}
  #messageInput { flex:1; resize:none; padding:10px; border-radius:12px; border:1px solid #ccc; outline:none; min-height:40px; max-height:120px; overflow-y:auto; font-size:14px;}
  #sendBtn { background:#004d99; color:#fff; border:none; border-radius:12px; padding:10px 15px; cursor:pointer; margin-top:5px; align-self:flex-end;}
  #sendBtn:hover { background:#003366; }
  #typingStatus { font-style:italic; font-size:12px; color:#004d99; margin-top:5px;}
  /* Petits écrans (smartphones ≤ 480px) */
@media only screen and (max-width: 480px) {
  body { height: 100%; padding: 5px; }
  h1 { font-size: 18px; margin: 15px 0; }
  #onlineUsers, #statusMessage, #discuterBtn, #quitBtn, #uploadAvatarBtn { font-size: 14px; padding: 8px 12px; }
  #chatSection { max-width: 100%; height: 60vh; border-radius: 12px; }
  #messages { padding: 10px; gap: 6px; }
  .message-container img { width: 28px; height: 28px; }
  .message-text { max-width: 80%; padding: 8px 10px; font-size: 13px; }
  #messageInput { font-size: 13px; min-height: 35px; max-height: 100px; }
  #sendBtn { padding: 8px 12px; font-size: 14px; }
  #avatarPreview { width: 40px; height: 40px; }
}

/* Tablettes (481px à 768px) */
@media only screen and (min-width: 481px) and (max-width: 768px) {
  h1 { font-size: 22px; }
  #onlineUsers, #statusMessage { font-size: 15px; padding: 10px 15px; }
  #chatSection { max-width: 90%; height: 65vh; }
  .message-text { font-size: 14px; }
  #messageInput { font-size: 14px; min-height: 40px; max-height: 120px; }
  #sendBtn { padding: 10px 15px; font-size: 15px; }
  #avatarPreview { width: 45px; height: 45px; }
}

/* Grands écrans (>768px) */
@media only screen and (min-width: 769px) {
  h1 { font-size: 26px; }
  #onlineUsers, #statusMessage { font-size: 16px; padding: 12px 20px; }
  #chatSection { max-width: 500px; height: 70vh; }
  .message-text { font-size: 15px; }
  #messageInput { font-size: 14px; min-height: 40px; max-height: 120px; }
  #sendBtn { font-size: 16px; }
  #avatarPreview { width: 50px; height: 50px; }
}
</style>
</head>
<body>

<h1>SIS CHAT ANONYME</h1>
<img id="avatarPreview" src="" alt="Avatar">
<input type="file" id="avatarInput" accept="image/*" style="margin-bottom:10px;">
<button id="uploadAvatarBtn">Téléverser Avatar</button>
<div id="onlineUsers">En ligne : 0</div>
<div id="statusMessage"></div>
<button id="discuterBtn">Discuter</button>
<button id="quitBtn">Quitter</button>

<div id="chatSection">
  <div id="messages"></div>
  <div id="typingStatus"></div>
  <div id="inputSection">
    <div id="replyPreview">
      <strong id="replySender"></strong>: <span id="replyText"></span>
      <span id="cancelReply">✖</span>
    </div>
    <textarea id="messageInput" placeholder="Écrire un message..."></textarea>
    <button id="sendBtn">➤</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDUf-Rf6fhQXBmtJJ4R9K1IXBFdTl34Z5s",
  authDomain: "chat-anonyme.firebaseapp.com",
  databaseURL: "https://chat-anonyme-default-rtdb.firebaseio.com",
  projectId: "chat-anonyme",
  storageBucket: "chat-anonyme.firebasestorage.app",
  messagingSenderId: "93366459642",
  appId: "1:93366459642:web:a2421c9478909b33667d43",
  measurementId: "G-MF8RGP29LN"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const userId = db.ref().push().key;
let avatarURL = `https://ui-avatars.com/api/?name=U&background=${Math.floor(Math.random()*16777215).toString(16)}&color=ffffff`;
db.ref("avatars/"+userId).set(avatarURL);

const userRef = db.ref("onlineUsers").child(userId);
userRef.set(true);
userRef.onDisconnect().remove();

const onlineUsersDiv = document.getElementById("onlineUsers");
const statusMessage = document.getElementById("statusMessage");
const discuterBtn = document.getElementById("discuterBtn");
const quitBtn = document.getElementById("quitBtn");
const chatSection = document.getElementById("chatSection");
const messagesDiv = document.getElementById("messages");
const messageInput = document.getElementById("messageInput");
const sendBtn = document.getElementById("sendBtn");
const typingStatus = document.getElementById("typingStatus");

const avatarInput = document.getElementById("avatarInput");
const uploadAvatarBtn = document.getElementById("uploadAvatarBtn");
const avatarPreview = document.getElementById("avatarPreview");

const replyPreview = document.getElementById("replyPreview");
const replySender = document.getElementById("replySender");
const replyText = document.getElementById("replyText");
const cancelReply = document.getElementById("cancelReply");

let roomRef = null;
let roomId = null;
let partnerLeft = false;
let matchmakingTimeout = null;
let typingTimeout = null;
let replyToMessageId = null;

// Fonction drapeau
function countryEmoji(code){
  if(!code) return "";
  return code.toUpperCase().replace(/./g, c => String.fromCodePoint(127397 + c.charCodeAt()));
}

// Détecter pays
let userCountry = "FR";
fetch('https://get.geojs.io/v1/ip/country.json')
  .then(res => res.json())
  .then(data => { if(data && data.country) userCountry = data.country; })
  .catch(()=>{});

// Affichage nombre utilisateurs en ligne
db.ref("onlineUsers").on("value", snap=>{
  const users = snap.val()||{};
  onlineUsersDiv.textContent = "En ligne : "+Object.keys(users).length;
});

// Upload avatar
uploadAvatarBtn.addEventListener("click", ()=>{
  const file = avatarInput.files[0];
  if(!file) return alert("Veuillez choisir une image");
  const reader = new FileReader();
  reader.onload = function(e){
    avatarURL = e.target.result;
    db.ref("avatars/"+userId).set(avatarURL);
    avatarPreview.src = avatarURL;
    avatarPreview.style.display = "block";
  }
  reader.readAsDataURL(file);
});

// Matchmaking
discuterBtn.addEventListener("click", ()=>{
  discuterBtn.disabled = true;
  statusMessage.innerHTML='Recherche en cours<span>...</span>';
  joinQueue();
  matchmakingTimeout = setTimeout(()=>{
    statusMessage.textContent = "Aucun partenaire trouvé, veuillez réessayer.";
    discuterBtn.disabled = false;
    db.ref("queue/"+userId).remove();
  },20000);
});

function joinQueue(){
  const queueRef = db.ref("queue");
  queueRef.once("value").then(snapshot=>{
    const queue = snapshot.val()||{};
    const partnerKey = Object.keys(queue).find(id=>id!==userId);

    if(partnerKey){
      clearTimeout(matchmakingTimeout);
      roomId = db.ref("rooms").push().key;
      const roomData = { users:{ [userId]:true, [partnerKey]:true }, lastActive: Date.now() };
      db.ref("rooms/"+roomId).set(roomData);
      db.ref("queue/"+partnerKey).remove();
      db.ref("rooms/"+roomId+"/joined/"+userId).set(true);
      db.ref("rooms/"+roomId+"/joined/"+partnerKey).set(true);
      openChat(roomId);
    }else{
      db.ref("queue/"+userId).set(true);
      statusMessage.innerHTML='En attente d’un partenaire<span>...</span>';

      db.ref("rooms").on("child_added", snap=>{
        const room = snap.val();
        if(room.users && room.users[userId] && !room.joined?.[userId]){
          db.ref("rooms/"+snap.key+"/joined/"+userId).set(true);
          roomId = snap.key;
          openChat(roomId);
        }
      });
    }
  });
}

// Ouvrir le chat
function openChat(rid){
  statusMessage.textContent="";
  discuterBtn.style.display="none";
  quitBtn.style.display="inline-block";
  chatSection.style.display="flex";
  roomRef = db.ref("rooms/"+rid+"/messages");

  addSystemMessage("BIENVENUE, VOUS POUVEZ DISCUTER 🎉");

  // Ajouter messages
  roomRef.on("child_added", snap=>{
    const data = snap.val();
    addMessage(data.text, data.sender===userId?'me':'other', data.sender, data.time, data.seen||false, data.replyTo||null, data.country||userCountry);

    if(data.sender!==userId && !data.seen){
      roomRef.child(snap.key).update({seen:true});
    }
  });

  monitorTyping(rid);

  const usersRef = db.ref("rooms/"+rid+"/users");
  usersRef.on("child_removed", snap=>{
    if(snap.key!==userId && !partnerLeft){
      partnerLeft = true;
      alert("Votre partenaire s'est déconnecté 😔");
      addSystemMessage("Votre partenaire a quitté la discussion.");
    }
  });

  window.addEventListener("beforeunload", ()=>{
    quitRoom();
  });
}

// Ajouter messages
function addMessage(text,type,senderId,time,seen,replyId,country){
  const container = document.createElement("div");
  container.classList.add("message-container", type);

  container.addEventListener("click", ()=>{
    replyToMessageId = time;
    replySender.textContent = type==='me' ? "Vous" : "Partenaire";
    replyText.textContent = text;
    replyPreview.style.display = "block";
  });

  const avatarImg = document.createElement("img");
  db.ref("avatars/"+senderId).once("value").then(snap=>{
    avatarImg.src = snap.exists()?snap.val():"";
  });

  const textDiv = document.createElement("div");
  textDiv.classList.add("message-text");

  if(replyId){
    const replyDiv = document.createElement("div");
    replyDiv.style.fontSize="12px";
    replyDiv.style.background="#f0f0f0";
    replyDiv.style.padding="4px 8px";
    replyDiv.style.borderLeft="3px solid #004d99";
    replyDiv.style.marginBottom="4px";
    replyDiv.textContent = "Réponse à ce message";
    textDiv.appendChild(replyDiv);
  }

  textDiv.appendChild(document.createTextNode(text));

  if(time){
    const timeDiv=document.createElement("div");
    timeDiv.classList.add("message-time");

    const date=new Date(time);
    timeDiv.textContent=date.getHours().toString().padStart(2,'0')+":"+date.getMinutes().toString().padStart(2,'0');
    if(type==='me' && seen) {
      const seenSpan=document.createElement("span");
      seenSpan.classList.add("seen");
      seenSpan.textContent=" vu ✔";
      timeDiv.appendChild(seenSpan);
    }

    if(country){
      const flagSpan = document.createElement("span");
      flagSpan.style.marginRight="6px";
      flagSpan.textContent = countryEmoji(country);
      timeDiv.prepend(flagSpan);
    }

    textDiv.appendChild(timeDiv);
  }

  container.appendChild(avatarImg);
  container.appendChild(textDiv);
  messagesDiv.appendChild(container);
  messagesDiv.scrollTop=messagesDiv.scrollHeight;
}

// Message système
function addSystemMessage(text){
  const div=document.createElement("div");
  div.classList.add("system");
  div.textContent=text;
  messagesDiv.appendChild(div);
  messagesDiv.scrollTop=messagesDiv.scrollHeight;
}

// Envoyer message
sendBtn.addEventListener("click",sendMessage);
function sendMessage(){
  const text=messageInput.value.trim();
  if(text!=="" && roomRef){
    const msgData={ 
      sender:userId, 
      text, 
      time:Date.now(), 
      seen:false,
      replyTo: replyToMessageId,
      country: userCountry
    };
    roomRef.push(msgData);
    db.ref("rooms/"+roomId).child("lastActive").set(Date.now());

    messageInput.value="";
    messageInput.style.height="auto";
    typingStatus.textContent="";

    replyToMessageId=null;
    replyPreview.style.display="none";
  }
}

// Annuler réponse
cancelReply.addEventListener("click", ()=>{
  replyToMessageId = null;
  replyPreview.style.display="none";
});

// Typing
messageInput.addEventListener("input", ()=>{
  messageInput.style.height="auto";
  messageInput.style.height=messageInput.scrollHeight+"px";
  sendTypingStatus();
});

function sendTypingStatus(){
  if(!roomId) return;
  const typingRef = db.ref("rooms/"+roomId+"/typing/"+userId);
  typingRef.set(true);
  clearTimeout(typingTimeout);
  typingTimeout = setTimeout(()=>{ typingRef.set(false); },1000);
}
function monitorTyping(rid){
  const otherTypingRef = db.ref("rooms/"+rid+"/typing");
  otherTypingRef.on("value", snap=>{
    const data = snap.val()||{};
    const othersTyping = Object.keys(data).filter(id=>id!==userId && data[id]);
    typingStatus.textContent = othersTyping.length ? "Votre partenaire est en train d'écrire..." : "";
  });
}

// Fonction quitter
quitBtn.addEventListener("click", quitRoom);
function quitRoom(){
  if(!roomId) return;
  const usersRef = db.ref("rooms/"+roomId+"/users");
  usersRef.child(userId).remove();

  usersRef.once("value").then(snap=>{
    if(!snap.exists()){ 
      db.ref("rooms/"+roomId).remove(); 
    }
  });

  db.ref("queue/"+userId).remove();
  chatSection.style.display="none";
  discuterBtn.style.display="inline-block";
  discuterBtn.disabled = false;
  quitBtn.style.display="none";
  statusMessage.textContent="Vous avez quitté la discussion.";
  roomId=null;
  roomRef=null;
}

// Supprimer rooms inactives toutes les 5 min
setInterval(()=>{
  db.ref("rooms").once("value").then(snap=>{
    const rooms=snap.val();
    if(!rooms) return;
    const now=Date.now();
    const TIMEOUT=5*60*1000;
    Object.keys(rooms).forEach(rid=>{
      if(rooms[rid].lastActive && now-rooms[rid].lastActive>TIMEOUT){
        db.ref("rooms/"+rid).remove();
      }
    });
  });
},5*60*1000);
</script>
</body>
</html>