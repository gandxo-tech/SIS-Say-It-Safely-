<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>SIS CHAT ANONYME</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body { font-family: Arial, sans-serif; background-color: #b6e5f7; margin:0; padding:0; display:flex; flex-direction:column; align-items:center; height:100vh;}
  h1 { margin:20px 0; color:#004d99; text-shadow:1px 1px 2px #a0c4e8;}
  #onlineUsers,#statusMessage,#countryBreakdown { background:#fff; padding:10px 20px; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.2); margin-bottom:10px; font-size:16px; color:#004d99; text-align:center;}
  #countryBreakdown { font-size:14px; }
  #statusMessage span { animation: blink 1s infinite;} @keyframes blink {0%,100%{opacity:1;}50%{opacity:0;}}
  #discuterBtn, #uploadAvatarBtn { background:#004d99; color:#fff; border:none; border-radius:12px; padding:12px 20px; font-size:16px; cursor:pointer; margin-bottom:10px;}
  #discuterBtn:hover, #uploadAvatarBtn:hover { background:#003366; }
  #avatarPreview { width:50px; height:50px; border-radius:50%; margin-bottom:10px; object-fit:cover; display:none; }
  #chatSection { display:none; flex-direction:column; justify-content:space-between; width:100%; max-width:500px; height:70%; background:#fff; border-radius:16px; box-shadow:0 4px 12px rgba(0,0,0,0.2); overflow:hidden; animation:fadeIn 0.5s ease;}
  @keyframes fadeIn { from{opacity:0} to{opacity:1} }
  #messages { flex:1; padding:15px; overflow-y:auto; display:flex; flex-direction:column; gap:10px;}
  .message-container { display:flex; align-items:flex-end; animation:pop 0.2s ease; position:relative;}
  @keyframes pop { from{transform:scale(0.8);opacity:0} to{transform:scale(1);opacity:1} }
  .message-container.me { flex-direction: row-reverse; }
  .message-container img { width:35px; height:35px; border-radius:50%; margin:0 8px;}
  .message-text { border-radius:20px; padding:10px 15px; line-height:1.4; position:relative; max-width:70%; word-wrap:break-word; box-shadow:0 2px 5px rgba(0,0,0,0.1); padding-bottom:20px;}
  .me .message-text { background:#004d99; color:#fff; padding-bottom:20px;}
  .other .message-text { background:#e0e0e0; color:#000; }
  .message-time { font-size:10px; color:#ccc; margin-top:4px; text-align:right;}
  .seen { font-size:10px; color:#0a0; margin-left:5px; }
  .message-flag { position:absolute; bottom:4px; right:8px; font-size:12px; line-height:1;}
  .system { background:#f0f0f0; color:#555; font-style:italic; text-align:center; align-self:center; border-radius:12px; padding:6px 12px; box-shadow:0 1px 3px rgba(0,0,0,0.1);}
  #inputSection { display:flex; flex-direction:row; align-items:flex-end; padding:10px; background:#f9f9f9; border-top:1px solid #ddd;}
  #replyPreview { display:none; padding:8px 12px; background:#e0e0e0; border-left:4px solid #004d99; border-radius:12px; margin-bottom:5px; font-size:14px; color:#000; position:absolute; bottom:60px; left:10px; right:10px;}
  #cancelReply { cursor:pointer; position:absolute; top:4px; right:8px; color:#004d99; font-weight:bold;}
  #messageInput { flex:1; resize:none; padding:10px; border-radius:12px; border:1px solid #ccc; outline:none; min-height:40px; max-height:120px; overflow-y:auto; font-size:14px; margin-right:8px;}
  #sendBtn { background:#004d99; color:#fff; border:none; border-radius:12px; padding:10px 15px; cursor:pointer;}
  #sendBtn:hover { background:#003366; }
  #typingStatus { font-style:italic; font-size:12px; color:#004d99; margin-top:5px;}
  @media (max-width: 600px) {
    .message-flag { font-size:10px; }
    .message-text { padding-bottom:16px; }
  }
</style>
</head>
<body>

<h1>SIS CHAT ANONYME</h1>
<p style="font-size:12px; color:#004d99; text-align:center; margin-bottom:10px;">
  Votre pays, d√©tect√© via votre adresse IP, est utilis√© pour afficher les statistiques et dans les messages.
</p>
<img id="avatarPreview" src="" alt="Avatar">
<input type="file" id="avatarInput" accept="image/*" style="margin-bottom:10px;">
<button id="uploadAvatarBtn">T√©l√©verser Avatar</button>
<div id="onlineUsers">En ligne : 0</div>
<div id="countryBreakdown"></div>
<div id="statusMessage"></div>
<button id="discuterBtn">Discuter</button>

<div id="chatSection">
  <div id="messages"></div>
  <div id="typingStatus"></div>
  <div id="inputSection">
    <div id="replyPreview">
      <strong id="replySender"></strong>: <span id="replyText"></span>
      <span id="cancelReply">‚úñ</span>
    </div>
    <textarea id="messageInput" placeholder="√âcrire un message..."></textarea>
    <button id="sendBtn">‚û§</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
const statusMessage = document.getElementById("statusMessage");

const firebaseConfig = {
  apiKey: "AIzaSyDUf-Rf6fhQXBmtJJ4R9K1IXBFdTl34Z5s",
  authDomain: "chat-anonyme.firebaseapp.com",
  databaseURL: "https://chat-anonyme-default-rtdb.firebaseio.com",
  projectId: "chat-anonyme",
  storageBucket: "chat-anonyme.firebasestorage.app",
  messagingSenderId: "93366459642",
  appId: "1:93366459642:web:a2421c9478909b33667d43",
  measurementId: "G-MF8RGP29LN"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Authentification anonyme
firebase.auth().signInAnonymously().catch(error => {
  console.error('Erreur d‚Äôauthentification:', error);
  statusMessage.textContent = 'Erreur de connexion, veuillez r√©essayer.';
});

const userId = db.ref().push().key;
let avatarURL = `https://ui-avatars.com/api/?name=U&background=${Math.floor(Math.random()*16777215).toString(16)}&color=ffffff`;
db.ref("avatars/"+userId).set(avatarURL);

// Fonction pour obtenir le pays et le code du pays
async function getUserCountry() {
  const cachedData = localStorage.getItem('userCountryData');
  if (cachedData) return JSON.parse(cachedData);
  try {
    const response = await fetch('https://ip-api.com/json/?fields=country,countryCode');
    if (response.status === 429) {
      statusMessage.textContent = 'Limite de localisation atteinte, r√©essayez bient√¥t.';
      return { country: 'Inconnu', countryCode: '' };
    }
    const data = await response.json();
    const countryData = { country: data.country || 'Inconnu', countryCode: data.countryCode || '' };
    localStorage.setItem('userCountryData', JSON.stringify(countryData));
    return countryData;
  } catch {
    statusMessage.textContent = 'Erreur de localisation, pays inconnu.';
    return { country: 'Inconnu', countryCode: '' };
  }
}

// Drapeau depuis code pays
function getFlagEmoji(countryCode) {
  if (!countryCode) return '';
  return String.fromCodePoint(...countryCode.toUpperCase().split('').map(c => 127397 + c.charCodeAt(0)));
}

// Enregistrer l‚Äôutilisateur avec son pays
getUserCountry().then(({ country, countryCode }) => {
  const userRef = db.ref("onlineUsers").child(userId);
  userRef.set({ country, countryCode });
  userRef.onDisconnect().remove();
});

const onlineUsersDiv = document.getElementById("onlineUsers");
const countryBreakdownDiv = document.getElementById("countryBreakdown");
const discuterBtn = document.getElementById("discuterBtn");
const chatSection = document.getElementById("chatSection");
const messagesDiv = document.getElementById("messages");
const messageInput = document.getElementById("messageInput");
const sendBtn = document.getElementById("sendBtn");
const typingStatus = document.getElementById("typingStatus");
const avatarInput = document.getElementById("avatarInput");
const uploadAvatarBtn = document.getElementById("uploadAvatarBtn");
const avatarPreview = document.getElementById("avatarPreview");
const replyPreview = document.getElementById("replyPreview");
const replySender = document.getElementById("replySender");
const replyText = document.getElementById("replyText");
const cancelReply = document.getElementById("cancelReply");

let roomRef = null;
let roomId = null;
let partnerLeft = false;
let matchmakingTimeout = null;
let typingTimeout = null;
let replyToMessageId = null;

// ... üîπ Je n‚Äôai pas chang√© la logique matchmaking/messages/etc sauf reply ID

// üîπ Ajouter messages
function addMessage(text, type, senderId, time, seen, replyId) {
  const container = document.createElement("div");
  container.classList.add("message-container", type);

  // Cliquer pour r√©pondre
  container.addEventListener("click", () => {
    replyToMessageId = db.ref("rooms/" + roomId + "/messages").push().key;
    replySender.textContent = type === 'me' ? "Vous" : "Partenaire";
    replyText.textContent = text;
    replyPreview.style.display = "block";
  });

  const avatarImg = document.createElement("img");
  db.ref("avatars/" + senderId).once("value").then(snap => {
    avatarImg.src = snap.exists() ? snap.val() : "https://ui-avatars.com/api/?name=?&background=cccccc&color=000000";
  });

  const textDiv = document.createElement("div");
  textDiv.classList.add("message-text");
  textDiv.appendChild(document.createTextNode(text));

  db.ref("onlineUsers/" + senderId + "/countryCode").once("value").then(snap => {
    const flagEmoji = getFlagEmoji(snap.val());
    if (flagEmoji) {
      const flagDiv = document.createElement("div");
      flagDiv.classList.add("message-flag");
      flagDiv.textContent = flagEmoji;
      textDiv.appendChild(flagDiv);
    }
  });

  if (time) {
    const timeDiv = document.createElement("div");
    timeDiv.classList.add("message-time");
    const date = new Date(time);
    timeDiv.textContent = date.getHours().toString().padStart(2, '0') + ":" + date.getMinutes().toString().padStart(2, '0');
    if (type === 'me' && seen) {
      const seenSpan = document.createElement("span");
      seenSpan.classList.add("seen");
      seenSpan.textContent = "vu ‚úî";
      timeDiv.appendChild(seenSpan);
    }
    textDiv.appendChild(timeDiv);
  }

  container.appendChild(avatarImg);
  container.appendChild(textDiv);
  messagesDiv.appendChild(container);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}
</script>
</body>
</html>