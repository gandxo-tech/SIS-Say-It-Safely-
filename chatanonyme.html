<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>SIS CHAT ANONYME</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
  font-family: Arial, sans-serif;
  background-color: #b6e5f7;
  margin:0; padding:0;
  display:flex; flex-direction:column; align-items:center;
  min-height:100vh;
}
h1 { margin:20px 0; color:#004d99; text-shadow:1px 1px 2px #a0c4e8; text-align:center; }
#onlineUsers, #statusMessage, #discuterBtn, #quitBtn, #uploadAvatarBtn, #muteSoundContainer {
  width:90%; max-width:500px; margin-bottom:10px; text-align:center; box-sizing:border-box;
}
#discuterBtn, #uploadAvatarBtn, #quitBtn, #sendBtn {
  padding:12px 20px; font-size:16px; border:none; border-radius:12px; cursor:pointer;
}
#discuterBtn:hover, #uploadAvatarBtn:hover, #quitBtn:hover, #sendBtn:hover { opacity:0.9; }
#quitBtn { background:#cc0000; }
#quitBtn:hover { background:#990000; }
#avatarPreview { width:50px; height:50px; border-radius:50%; object-fit:cover; display:block; margin:0 auto 10px; }
#chatSection { display:none; flex-direction:column; justify-content:space-between; width:90%; max-width:500px; height:70vh; background:#fff; border-radius:16px; box-shadow:0 4px 12px rgba(0,0,0,0.2); overflow:hidden; }
#messages { flex:1; padding:10px; overflow-y:auto; display:flex; flex-direction:column; gap:10px; }
.message-container { display:flex; align-items:flex-end; animation:pop 0.2s ease; position:relative; }
.message-container.me { flex-direction: row-reverse; }
.message-container img { width:35px; height:35px; border-radius:50%; margin:0 8px; }
.message-text { border-radius:20px; padding:10px 15px; line-height:1.4; max-width:70%; word-wrap:break-word; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
.me .message-text { background:#004d99; color:#fff; }
.other .message-text { background:#e0e0e0; color:#000; }
#inputSection { display:flex; flex-direction:column; padding:8px; background:#f9f9f9; border-top:1px solid #ddd; }
#messageInput { width:100%; resize:none; padding:10px; border-radius:12px; border:1px solid #ccc; min-height:40px; max-height:120px; overflow-y:auto; font-size:14px; box-sizing:border-box; }
#sendBtn { align-self:flex-end; margin-top:5px; background:#004d99; color:#fff; padding:10px 15px; border-radius:12px; }
#typingStatus { font-style:italic; font-size:12px; color:#004d99; margin-top:5px; }
#replyPreview { display:none; padding:8px 12px; background:#e0e0e0; border-left:4px solid #004d99; border-radius:12px; margin-bottom:5px; font-size:14px; position:relative; }
#cancelReply { cursor:pointer; position:absolute; top:4px; right:8px; color:#004d99; font-weight:bold; }
.system { background:#f0f0f0; color:#555; font-style:italic; text-align:center; align-self:center; border-radius:12px; padding:6px 12px; box-shadow:0 1px 3px rgba(0,0,0,0.1); }
@keyframes pop { from{transform:scale(0.8);opacity:0} to{transform:scale(1);opacity:1} }
@media (max-width:600px){
  #chatSection { height:65vh; }
  #messageInput { font-size:13px; }
  .message-text { max-width:80%; padding:8px 12px; }
  #discuterBtn, #quitBtn, #uploadAvatarBtn { font-size:14px; padding:10px 15px; }
}
</style>
</head>
<body>

<h1>SIS CHAT ANONYME</h1>
<img id="avatarPreview" src="" alt="Avatar">
<input type="file" id="avatarInput" accept="image/*" style="margin-bottom:10px;">
<button id="uploadAvatarBtn">TÃ©lÃ©verser Avatar</button>
<div id="muteSoundContainer">
  <input type="checkbox" id="muteSound" checked> <label for="muteSound">Activer le son des messages</label>
</div>
<div id="onlineUsers">En ligne : 0</div>
<div id="statusMessage"></div>
<button id="discuterBtn">Discuter</button>
<button id="quitBtn">Quitter</button>

<div id="chatSection">
  <div id="messages"></div>
  <div id="typingStatus"></div>
  <div id="inputSection">
    <div id="replyPreview">
      <strong id="replySender"></strong>: <span id="replyText"></span>
      <span id="cancelReply">âœ–</span>
    </div>
    <textarea id="messageInput" placeholder="Ã‰crire un message..."></textarea>
    <button id="sendBtn">âž¤</button>
  </div>
</div>

<audio id="messageSound" src="https://www.soundjay.com/button/sounds/button-3.mp3" preload="auto"></audio>

<!-- Firebase JS -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// --- CONFIG FIREBASE ---
const firebaseConfig = {
  apiKey: "AIzaSyDUf-Rf6fhQXBmtJJ4R9K1IXBFdTl34Z5s",
  authDomain: "chat-anonyme.firebaseapp.com",
  databaseURL: "https://chat-anonyme-default-rtdb.firebaseio.com",
  projectId: "chat-anonyme",
  storageBucket: "chat-anonyme.firebasestorage.app",
  messagingSenderId: "93366459642",
  appId: "1:93366459642:web:a2421c9478909b33667d43",
  measurementId: "G-MF8RGP29LN"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// --- USER ---
const userId = db.ref().push().key;
let avatarURL = `https://ui-avatars.com/api/?name=U&background=${Math.floor(Math.random()*16777215).toString(16)}&color=ffffff`;
db.ref("avatars/" + userId).set(avatarURL);

// --- ONLINE ---
const userRef = db.ref("onlineUsers").child(userId);
userRef.set(true);
userRef.onDisconnect().remove();
const onlineUsersDiv = document.getElementById("onlineUsers");
db.ref("onlineUsers").on("value", snap => {
  const users = snap.val() || {};
  onlineUsersDiv.textContent = "En ligne : " + Object.keys(users).length;
});

// --- DOM ---
const statusMessage = document.getElementById("statusMessage");
const discuterBtn = document.getElementById("discuterBtn");
const quitBtn = document.getElementById("quitBtn");
const chatSection = document.getElementById("chatSection");
const messagesDiv = document.getElementById("messages");
const messageInput = document.getElementById("messageInput");
const sendBtn = document.getElementById("sendBtn");
const typingStatus = document.getElementById("typingStatus");
const avatarInput = document.getElementById("avatarInput");
const uploadAvatarBtn = document.getElementById("uploadAvatarBtn");
const avatarPreview = document.getElementById("avatarPreview");
const replyPreview = document.getElementById("replyPreview");
const replySender = document.getElementById("replySender");
const replyText = document.getElementById("replyText");
const cancelReply = document.getElementById("cancelReply");
const messageSound = document.getElementById("messageSound");
const muteSound = document.getElementById("muteSound");

let roomRef=null, roomId=null, partnerLeft=false, matchmakingTimeout=null, replyToMessageId=null, lastMessageTime=0;

// --- AVATAR ---
uploadAvatarBtn.addEventListener("click", () => {
  const file = avatarInput.files[0];
  if(!file) return alert("Veuillez choisir une image");
  if(file.size>1024*1024) return alert("Image max 1 Mo");
  if(!file.type.startsWith("image/")) return alert("SÃ©lectionnez une image valide");
  const reader = new FileReader();
  reader.onload = e => {
    const img = new Image();
    img.src=e.target.result;
    img.onload = ()=>{
      const canvas=document.createElement("canvas");
      const ctx=canvas.getContext("2d");
      canvas.width=100; canvas.height=100;
      ctx.drawImage(img,0,0,100,100);
      avatarURL=canvas.toDataURL("image/jpeg",0.7);
      db.ref("avatars/"+userId).set(avatarURL).then(()=>{
        avatarPreview.src=avatarURL; avatarPreview.style.display="block";
      });
    };
  };
  reader.readAsDataURL(file);
});

// --- MATCHMAKING ---
discuterBtn.addEventListener("click", ()=>{
  discuterBtn.disabled=true;
  statusMessage.innerHTML='Recherche en cours<span>...</span>';
  joinQueue();
  matchmakingTimeout=setTimeout(()=>{
    statusMessage.textContent="Aucun partenaire trouvÃ©, rÃ©essayez.";
    discuterBtn.disabled=false;
    db.ref("queue/"+userId).remove();
  },20000);
});
function joinQueue(){
  const queueRef=db.ref("queue");
  queueRef.once("value").then(snapshot=>{
    const queue=snapshot.val()||{};
    const partnerKey=Object.keys(queue).find(id=>id!==userId);
    if(partnerKey){
      clearTimeout(matchmakingTimeout);
      roomId=db.ref("rooms").push().key;
      const roomData={ users:{[userId]:true,[partnerKey]:true}, lastActive:Date.now() };
      db.ref("rooms/"+roomId).set(roomData);
      db.ref("queue/"+partnerKey).remove();
      db.ref("rooms/"+roomId+"/joined/"+userId).set(true);
      db.ref("rooms/"+roomId+"/joined/"+partnerKey).set(true);
      openChat(roomId);
    }else{
      db.ref("queue/"+userId).set(true);
      statusMessage.innerHTML='En attente dâ€™un partenaire<span>...</span>';
      db.ref("rooms").on("child_added", snap=>{
        const room = snap.val();
        if(room.users && room.users[userId] && !room.joined?.[userId]){
          clearTimeout(matchmakingTimeout);
          db.ref("rooms/"+snap.key+"/joined/"+userId).set(true);
          roomId=snap.key; openChat(roomId);
        }
      });
    }
  });
}

// --- CHAT ---
function openChat(rid){
  statusMessage.textContent="";
  discuterBtn.style.display="none";
  quitBtn.style.display="inline-block";
  chatSection.style.display="flex";
  roomRef=db.ref("rooms/"+rid+"/messages");
  addSystemMessage("BIENVENUE, VOUS POUVEZ DISCUTER ðŸŽ‰");

  roomRef.on("child_added", snap=>{
    const data=snap.val();
    addMessage(data.text,data.sender===userId?"me":"other",data.sender,data.time,data.seen||false,data.replyTo||null,data.country||"FR");
    if(data.sender!==userId && muteSound.checked){ messageSound.play().catch(()=>{}); }
    if(data.sender!==userId && !data.seen){ roomRef.child(snap.key).update({seen:true}); }
  });

  db.ref("rooms/"+rid+"/users").on("child_removed", snap=>{
    if(snap.key!==userId && !partnerLeft){ partnerLeft=true; alert("Votre partenaire s'est dÃ©connectÃ© ðŸ˜”"); addSystemMessage("Votre partenaire a quittÃ© la discussion."); }
  });

  window.addEventListener("beforeunload", ()=>{ quitRoom(); });
}

// --- MESSAGE ---
function addMessage(text,type,senderId,time,seen,replyId,country){
  const container=document.createElement("div");
  container.classList.add("message-container",type);
  container.addEventListener("click", ()=>{
    replyToMessageId=time;
    replySender.textContent=type==="me"?"Vous":"Partenaire";
    replyText.textContent=text;
    replyPreview.style.display="block";
  });

  const avatarImg=document.createElement("img");
  db.ref("avatars/"+senderId).once("value").then(snap=>{ avatarImg.src=snap.exists()?snap.val():""; });

  const textDiv=document.createElement("div");
  textDiv.classList.add("message-text");
  if(replyId){ const replyDiv=document.createElement("div"); replyDiv.style.fontSize="12px"; replyDiv.style.background="#f0f0f0"; replyDiv.style.padding="4px 8px"; replyDiv.style.borderLeft="3px solid #004d99"; replyDiv.style.marginBottom="4px"; replyDiv.textContent="RÃ©ponse Ã  ce message"; textDiv.appendChild(replyDiv); }
  textDiv.appendChild(document.createTextNode(text));

  if(time){
    const timeDiv=document.createElement("div");
    timeDiv.classList.add("message-time");
    const date=new Date(time);
    timeDiv.textContent=date.getHours().toString().padStart(2,"0")+":"+date.getMinutes().toString().padStart(2,"0");
    if(type==="me" && seen){ const seenSpan=document.createElement("span"); seenSpan.classList.add("seen"); seenSpan.textContent=" vu âœ”"; timeDiv.appendChild(seenSpan); }
    if(country){ const flagSpan=document.createElement("span"); flagSpan.style.marginRight="6px"; flagSpan.textContent=countryEmoji(country); timeDiv.prepend(flagSpan); }
    textDiv.appendChild(timeDiv);
  }

  container.appendChild(avatarImg);
  container.appendChild(textDiv);
  messagesDiv.appendChild(container);
  messagesDiv.scrollTop=messagesDiv.scrollHeight;
}

function addSystemMessage(text){
  const div=document.createElement("div");
  div.classList.add("system"); div.textContent=text;
  messagesDiv.appendChild(div); messagesDiv.scrollTop=messagesDiv.scrollHeight;
}

sendBtn.addEventListener("click",sendMessage);
function sendMessage(){
  const now=Date.now();
  if(now-lastMessageTime<1000){ statusMessage.textContent="Veuillez attendre 1 seconde."; setTimeout(()=>{ statusMessage.textContent=""; },2000); return; }
  let text=messageInput.value.trim();
  if(text!=="" && roomRef){
    if(text.length>500){ statusMessage.textContent="Message trop long (max 500 caractÃ¨res)"; setTimeout(()=>{ statusMessage.textContent=""; },2000); return; }
    text=text.replace(/<[^>]+>/g,"");
    lastMessageTime=now;
    const msgData={ sender:userId,text,time:now,seen:false,replyTo:replyToMessageId,country:"FR" };
    roomRef.push(msgData).then(()=>{ messageInput.value=""; replyToMessageId=null; replyPreview.style.display="none"; typingStatus.textContent=""; });
  }
}

// Cancel reply
cancelReply.addEventListener("click", ()=>{ replyToMessageId=null; replyPreview.style.display="none"; });

// Typing
let typingDebounce=null;
messageInput.addEventListener("input", ()=>{
  messageInput.style.height="auto";
  messageInput.style.height=messageInput.scrollHeight+"px";
  sendTypingStatus();
});

function sendTypingStatus(){
  if(!roomId) return;
  clearTimeout(typingDebounce);
  typingDebounce=setTimeout(()=>{
    const typingRef=db.ref("rooms/"+roomId+"/typing/"+userId);
    typingRef.set(true);
    setTimeout(()=>{ typingRef.set(false); },1000);
  },300);
}

db.ref("rooms").on("child_added", snap=>{
  if(!roomId) return;
  const typingRef=db.ref("rooms/"+roomId+"/typing");
  typingRef.on("value", snap=>{
    const data=snap.val()||{};
    const othersTyping=Object.keys(data).filter(id=>id!==userId && data[id]);
    typingStatus.textContent=othersTyping.length?"Votre partenaire Ã©crit...":"";
  });
});

// Quit
quitBtn.addEventListener("click",quitRoom);
function quitRoom(){
  if(!roomId) return;
  db.ref("rooms/"+roomId+"/users").child(userId).remove();
  db.ref("rooms/"+roomId).once("value").then(snap=>{ if(!snap.exists()) db.ref("rooms/"+roomId).remove(); });
  chatSection.style.display="none";
  discuterBtn.style.display="inline-block";
  quitterBtn.disabled=false;
  roomId=null;
}
function countryEmoji(code){ return code.toUpperCase().replace(/./g, c => String.fromCodePoint(127397 + c.charCodeAt())); }
</script>
</body>
</html>