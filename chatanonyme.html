
<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>SIS CHAT ANONYME - Version AmÃ©liorÃ©e</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
/* [Tous les styles CSS prÃ©cÃ©dents restent inchangÃ©s] */
/* ... */
</style>
</head>
<body>

<div class="container">
  <h1>ğŸ”’ SIS Chat SÃ©curisÃ©</h1>

  <!-- Auth Section -->
  <div id="authSection">
    <h2 id="authTitle">Connexion</h2>
    <div class="error-msg" id="authError"></div>
    <div class="success-msg" id="authSuccess"></div>

    <div id="loginForm">
      <input type="email" id="loginEmail" placeholder="Email" autocomplete="email">
      <input type="password" id="loginPassword" placeholder="Mot de passe" autocomplete="current-password">
      <button class="btn-primary" id="loginBtn">Se connecter</button>

      <div class="divider">OU</div>

      <button id="googleLoginBtn">Continuer avec Google</button>

      <div class="auth-toggle">
        Pas de compte ? <span id="showRegister">S'inscrire</span>
      </div>
    </div>

    <div id="registerForm" style="display:none;">
      <input type="text" id="registerUsername" placeholder="Nom d'utilisateur" autocomplete="username">
      <input type="email" id="registerEmail" placeholder="Email" autocomplete="email">
      <input type="password" id="registerPassword" placeholder="Mot de passe (min. 6 caractÃ¨res)" autocomplete="new-password">
      <button class="btn-primary" id="registerBtn">CrÃ©er un compte</button>

      <div class="auth-toggle">
        DÃ©jÃ  un compte ? <span id="showLogin">Se connecter</span>
      </div>
    </div>
  </div>

  <!-- Dashboard Section -->
  <div id="dashboardSection">
    <div class="user-info">
      <div class="user-profile">
        <img id="userAvatar" class="user-avatar" src="" alt="Avatar">
        <div class="user-details">
          <h3 id="userName">Utilisateur</h3>
          <p id="userEmail">email@example.com</p>
          <div class="user-badges" id="userBadges"></div>
        </div>
      </div>
      <div class="user-actions">
        <button class="btn-admin" id="adminPanelBtn" style="display:none;">ğŸ‘‘ Panel Admin</button>
        <button class="btn-primary" id="editProfileBtn">Modifier le profil</button>
        <button class="btn-secondary" id="logoutBtn">DÃ©connexion</button>
      </div>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel">
      <h3>ğŸ‘‘ Tableau de bord Admin</h3>

      <div class="admin-stats">
        <div class="admin-stat-card">
          <div class="admin-stat-number" id="totalUsers">0</div>
          <div class="admin-stat-label">Utilisateurs</div>
        </div>
        <div class="admin-stat-card">
          <div class="admin-stat-number" id="totalRooms">0</div>
          <div class="admin-stat-label">Salons</div>
        </div>
        <div class="admin-stat-card">
          <div class="admin-stat-number" id="totalMessages">0</div>
          <div class="admin-stat-label">Messages</div>
        </div>
        <div class="admin-stat-card">
          <div class="admin-stat-number" id="bannedUsers">0</div>
          <div class="admin-stat-label">Bannis</div>
        </div>
      </div>

      <div class="admin-actions">
        <button class="btn-admin" id="viewAllMessagesBtn">ğŸ‘ï¸ Voir tous les messages</button>
        <button class="btn-admin" id="sendAnnouncementBtn">ğŸ”” Envoyer une annonce</button>
        <button class="btn-admin" id="manageUsersBtn">ğŸ‘¥ GÃ©rer les utilisateurs</button>
        <button class="btn-admin" id="manageBadgesBtn">ğŸ¨ GÃ©rer les badges</button>
      </div>
    </div>

    <div class="dashboard-grid">
      <div class="card">
        <h3>ğŸ² Chat AlÃ©atoire</h3>
        <p>Rencontrez des personnes au hasard pour discuter anonymement.</p>
        <div class="stats">
          <div class="stat-number" id="onlineUsers">0</div>
          <div class="stat-label">En ligne</div>
        </div>
        <button class="btn-primary" id="randomChatBtn">Commencer</button>
      </div>

      <div class="card">
        <h3>â• CrÃ©er un Salon</h3>
        <p>CrÃ©ez votre propre salon public ou privÃ©.</p>
        <button class="btn-primary" id="createRoomBtn">CrÃ©er un Salon</button>
      </div>

      <div class="card">
        <h3>ğŸ”— Rejoindre un Salon</h3>
        <p>Rejoignez via un lien partagÃ©.</p>
        <p style="font-size:12px;color:#94a3b8;">Les salons privÃ©s sont accessibles uniquement par lien d'invitation</p>
      </div>
    </div>

    <!-- CatÃ©gories -->
    <div class="category-tabs">
      <button class="category-tab active" data-category="all">Tous</button>
      <button class="category-tab" data-category="general">ğŸ’¬ GÃ©nÃ©ral</button>
      <button class="category-tab" data-category="gaming">ğŸ® Gaming</button>
      <button class="category-tab" data-category="tech">ğŸ’» Tech</button>
      <button class="category-tab" data-category="music">ğŸµ Musique</button>
      <button class="category-tab" data-category="sport">âš½ Sport</button>
      <button class="category-tab" data-category="education">ğŸ“š Ã‰ducation</button>
      <button class="category-tab" data-category="other">ğŸ—¾ Mangas</button>
    </div>

    <!-- Mes Salons -->
    <div class="room-list">
      <h3>ğŸ“‹ Mes Salons <span class="room-count" id="myRoomsCount">0</span></h3>
      <div id="myRoomsList">
        <p style="color:#94a3b8;text-align:center;padding:20px;">Aucun salon pour le moment</p>
      </div>
    </div>

    <!-- Salons Publics -->
    <div class="room-list">
      <h3>ğŸŒ Salons Publics <span class="room-count" id="publicRoomsCount">0</span></h3>
      <div id="publicRoomsList">
        <p style="color:#94a3b8;text-align:center;padding:20px;">Aucun salon public</p>
      </div>
    </div>

    <!-- Historique -->
    <div class="room-list">
      <h3>ğŸ“œ Historique <span class="room-count" id="historyCount">0</span></h3>
      <div id="historyRoomsList">
        <p style="color:#94a3b8;text-align:center;padding:20px;">Aucun historique</p>
      </div>
    </div>
  </div>

  <!-- Chat Section -->
  <div id="chatSection">
    <div class="chat-header">
      <div>
        <h3 id="chatRoomName">Salon</h3>
        <div class="online-indicator">
          <div class="online-dot"></div>
          <span id="chatOnlineCount">0 en ligne</span>
        </div>
      </div>
      <div class="chat-header-buttons">
        <button id="shareRoomBtn">ğŸ”— Partager</button>
        <button id="lockRoomBtn" style="display:none;">ğŸ”’ Verrouiller</button>
        <button id="backBtn">â† Retour</button>
      </div>
    </div>

    <div id="messages"></div>

    <div class="typing-indicator" id="typingStatus"></div>

    <div id="inputSection">
      <div id="replyPreview">
        <strong id="replySender"></strong>: <span id="replyText"></span>
        <span id="cancelReply">Ã—</span>
      </div>

      <div class="upload-progress" id="uploadProgress">
        <div>ğŸ“¤ Envoi en cours...</div>
        <div class="upload-progress-bar">
          <div class="upload-progress-fill" id="uploadProgressFill"></div>
        </div>
      </div>

      <div class="recording-indicator" id="recordingIndicator">
        ğŸ”´ Enregistrement en cours<span class="recording-timer" id="recordingTimer">0:00</span>
      </div>

      <div class="media-preview" id="mediaPreview">
        <img id="imagePreview" src="" alt="Preview">
        <button class="media-preview-close" id="cancelMediaPreview">Ã—</button>
      </div>

      <div class="input-wrapper">
        <div class="input-controls">
          <button class="input-control-btn" id="imageBtn" title="Envoyer une image">
            ğŸ“·
          </button>
          <button class="input-control-btn" id="audioBtn" title="Enregistrer un audio">
            ğŸ¤
          </button>
        </div>
        <textarea id="messageInput" placeholder="Ã‰crire un message..." rows="1"></textarea>
        <button id="sendBtn">â¤</button>
      </div>

      <input type="file" id="imageInput" accept="image/*" style="display:none;">
    </div>
  </div>
</div>

<!-- Create Room Modal -->
<div id="createRoomModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>CrÃ©er un Salon</h3>
      <span class="close-modal" id="closeCreateRoom">Ã—</span>
    </div>
    <input type="text" id="newRoomName" placeholder="Nom du salon" maxlength="50">
    <textarea id="newRoomDesc" placeholder="Description (optionnelle)" rows="3" maxlength="200"></textarea>

    <div class="form-group">
      <label>CatÃ©gorie</label>
      <select id="roomCategory">
        <option value="general">ğŸ’¬ GÃ©nÃ©ral</option>
        <option value="gaming">ğŸ® Gaming</option>
        <option value="tech">ğŸ’» Tech</option>
        <option value="music">ğŸµ Musique</option>
        <option value="sport">âš½ Sport</option>
        <option value="education">ğŸ“š Ã‰ducation</option>
        <option value="other">ğŸ—¾ Mangas</option>
      </select>
    </div>

    <div class="form-group">
      <label style="display:block;margin-bottom:8px;">Type de salon</label>
      <label style="margin-bottom:8px;">
        <input type="radio" name="roomType" value="public" checked> Public (visible par tous)
      </label>
      <label>
        <input type="radio" name="roomType" value="private"> PrivÃ© (accessible uniquement par lien)
      </label>
    </div>

    <button class="btn-primary" id="confirmCreateRoom">CrÃ©er</button>
  </div>
</div>

<!-- Edit Profile Modal -->
<div id="editProfileModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Modifier le Profil</h3>
      <span class="close-modal" id="closeEditProfile">Ã—</span>
    </div>

    <div class="avatar-upload">
      <img id="editAvatarPreview" class="avatar-preview" src="" alt="Avatar">
      <label class="file-input-label" for="avatarFileInput">
        ğŸ“· Choisir une photo
      </label>
      <input type="file" id="avatarFileInput" accept="image/*" style="display:none;">
    </div>

    <input type="text" id="editUsername" placeholder="Nom d'utilisateur" maxlength="30">
    <button class="btn-primary" id="confirmEditProfile">Enregistrer</button>
  </div>
</div>

<!-- Share Room Modal -->
<div id="shareRoomModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Partager le Salon</h3>
      <span class="close-modal" id="closeShareRoom">Ã—</span>
    </div>

    <p style="margin-bottom:12px;color:#64748b;font-size:14px;">Partagez ce lien pour inviter des personnes :</p>
    <div class="share-link" id="shareLink"></div>

    <button class="btn-primary" id="copyLinkBtn">ğŸ“‹ Copier le lien</button>
  </div>
</div>

<!-- Send Announcement Modal -->
<div id="announcementModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ğŸ”” Envoyer une Annonce</h3>
      <span class="close-modal" id="closeAnnouncement">Ã—</span>
    </div>

    <p style="margin-bottom:16px;color:#64748b;font-size:14px;">Cette annonce sera visible par tous les utilisateurs dans tous les salons.</p>

    <textarea id="announcementText" placeholder="Votre annonce..." rows="4" maxlength="300"></textarea>

    <button class="btn-admin" id="confirmAnnouncement">Envoyer l'annonce</button>
  </div>
</div>

<!-- Manage Users Modal -->
<div id="manageUsersModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ğŸ‘¥ GÃ©rer les Utilisateurs</h3>
      <span class="close-modal" id="closeManageUsers">Ã—</span>
    </div>

    <input type="text" id="searchUser" placeholder="Rechercher un utilisateur..." style="margin-bottom:20px;">

    <div id="usersList" style="max-height:400px;overflow-y:auto;">
      <!-- Liste des utilisateurs -->
    </div>
  </div>
</div>

<!-- Manage Badges Modal -->
<div id="manageBadgesModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ğŸ¨ GÃ©rer les Badges</h3>
      <span class="close-modal" id="closeManageBadges">Ã—</span>
    </div>

    <div class="form-group">
      <label>SÃ©lectionner un utilisateur</label>
      <select id="badgeUserId">
        <option value="">-- Choisir un utilisateur --</option>
      </select>
    </div>

    <div class="form-group">
      <label>Type de badge</label>
      <select id="badgeType">
        <option value="veteran">ğŸ† VÃ©tÃ©ran</option>
        <option value="active">âš¡ Actif</option>
        <option value="new">ğŸ†• Nouveau</option>
        <option value="custom">ğŸ¨ PersonnalisÃ©</option>
      </select>
    </div>

    <div class="form-group" id="customBadgeGroup" style="display:none;">
      <label>Texte du badge</label>
      <input type="text" id="customBadgeText" placeholder="Ex: VIP" maxlength="20">

      <label>Couleur du badge</label>
      <input type="color" id="customBadgeColor" value="#2563eb">
    </div>

    <button class="btn-admin" id="confirmBadge">Attribuer le badge</button>
  </div>
</div>

<!-- View All Messages Modal -->
<div id="allMessagesModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ğŸ‘ï¸ Tous les Messages</h3>
      <span class="close-modal" id="closeAllMessages">Ã—</span>
    </div>

    <div class="form-group">
      <label>Filtrer par salon</label>
      <select id="filterRoomId">
        <option value="all">Tous les salons</option>
      </select>
    </div>

    <div id="allMessagesList" style="max-height:500px;overflow-y:auto;background:#f8fafc;padding:16px;border-radius:10px;margin-top:16px;">
      <!-- Liste des messages -->
    </div>
 </div>
</div>

<!-- Image Modal -->
<div id="imageModal" class="image-modal">
  <span class="image-modal-close" id="closeImageModal">Ã—</span>
  <img class="image-modal-content" id="modalImage">
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<script>
// Configuration Firebase
const firebaseConfig = {
  apiKey: "AIzaSyDUf-Rf6fhQXBmtJJ4R9K1IXBFdTl34Z5s",
  authDomain: "chat-anonyme.firebaseapp.com",
  databaseURL: "https://chat-anonyme-default-rtdb.firebaseio.com",
  projectId: "chat-anonyme",
  storageBucket: "chat-anonyme.firebasestorage.app",
  messagingSenderId: "93366459642",
  appId: "1:93366459642:web:a2421c9478909b33667d43"
};

// Initialisation Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();
const storage = firebase.storage();

const ADMIN_EMAIL = "gbaguidiexauce@gmail.com";

// Variables globales
let currentUser = null;
let currentRoom = null;
let currentCategory = 'all';
let replyingTo = null;
let typingTimeout = null;
let messagesRef = null;
let usersRef = null;
let roomsRef = null;
let onlineRef = null;
let mediaRecorder = null;
let audioChunks = [];
let recordingStartTime = null;
let recordingInterval = null;
let selectedImage = null;

const categoryEmojis = {
  'general': 'ğŸ’¬', 'gaming': 'ğŸ®', 'tech': 'ğŸ’»',
  'music': 'ğŸµ', 'sport': 'âš½', 'education': 'ğŸ“š', 'other': 'ğŸ—¾'
};

// ===== INITIALISATION =====

document.addEventListener('DOMContentLoaded', () => {
  initializeAuthListeners();
  initializeUIListeners();
  initializeMediaListeners();
  
  // VÃ©rifier l'URL pour les invitations de salon
  const urlParams = new URLSearchParams(window.location.search);
  const roomIdParam = urlParams.get('room');
  
  auth.onAuthStateChanged(user => {
    if (user) {
      currentUser = user;
      loadUserProfile();
      showDashboard();
      setupPresence();
      loadRooms();
      
      // Rejoindre automatiquement depuis l'URL
      if (roomIdParam) {
        setTimeout(() => joinRoomViaLink(roomIdParam), 1000);
      }
    } else {
      currentUser = null;
      showAuth();
    }
  });
});

// ===== AUTH FUNCTIONS =====

function initializeAuthListeners() {
  document.getElementById('showRegister').addEventListener('click', () => {
    document.getElementById('loginForm').style.display = 'none';
    document.getElementById('registerForm').style.display = 'block';
    document.getElementById('authTitle').textContent = 'Inscription';
    clearAuthMessages();
  });

  document.getElementById('showLogin').addEventListener('click', () => {
    document.getElementById('registerForm').style.display = 'none';
    document.getElementById('loginForm').style.display = 'block';
    document.getElementById('authTitle').textContent = 'Connexion';
    clearAuthMessages();
  });

  document.getElementById('loginBtn').addEventListener('click', handleLogin);
  document.getElementById('loginPassword').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') handleLogin();
  });

  document.getElementById('registerBtn').addEventListener('click', handleRegister);
  document.getElementById('registerPassword').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') handleRegister();
  });

  document.getElementById('googleLoginBtn').addEventListener('click', handleGoogleLogin);
  document.getElementById('logoutBtn').addEventListener('click', handleLogout);
}

async function handleLogin() {
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value;

  if (!email || !password) {
    showAuthError('Veuillez remplir tous les champs');
    return;
  }

  const btn = document.getElementById('loginBtn');
  btn.disabled = true;
  btn.textContent = 'Connexion...';

  try {
    await auth.signInWithEmailAndPassword(email, password);
    showAuthSuccess('Connexion rÃ©ussie !');
  } catch (error) {
    console.error('Erreur login:', error);
    showAuthError(getErrorMessage(error.code));
  } finally {
    btn.disabled = false;
    btn.textContent = 'Se connecter';
  }
}

async function handleRegister() {
  const username = document.getElementById('registerUsername').value.trim();
  const email = document.getElementById('registerEmail').value.trim();
  const password = document.getElementById('registerPassword').value;

  if (!username || !email || !password) {
    showAuthError('Veuillez remplir tous les champs');
    return;
  }

  if (username.length < 3) {
    showAuthError('Le nom d\'utilisateur doit contenir au moins 3 caractÃ¨res');
    return;
  }

  if (password.length < 6) {
    showAuthError('Le mot de passe doit contenir au moins 6 caractÃ¨res');
    return;
  }

  const btn = document.getElementById('registerBtn');
  btn.disabled = true;
  btn.textContent = 'CrÃ©ation...';

  try {
    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
    const user = userCredential.user;

    await db.ref('users/' + user.uid).set({
      uid: user.uid,
      username: username,
      email: email,
      avatar: 'https://ui-avatars.com/api/?name=' + encodeURIComponent(username) + '&background=2563eb&color=fff',
      createdAt: firebase.database.ServerValue.TIMESTAMP,
      isAdmin: email === ADMIN_EMAIL,
      badges: email === ADMIN_EMAIL ? ['admin'] : ['new']
    });

    showAuthSuccess('Compte crÃ©Ã© avec succÃ¨s !');
  } catch (error) {
    console.error('Erreur register:', error);
    showAuthError(getErrorMessage(error.code));
  } finally {
    btn.disabled = false;
    btn.textContent = 'CrÃ©er un compte';
  }
}

async function handleGoogleLogin() {
  const provider = new firebase.auth.GoogleAuthProvider();
  const btn = document.getElementById('googleLoginBtn');
  btn.disabled = true;
  btn.textContent = 'Connexion...';

  try {
    const result = await auth.signInWithPopup(provider);
    const user = result.user;

    const userSnapshot = await db.ref('users/' + user.uid).once('value');
    
    if (!userSnapshot.exists()) {
      await db.ref('users/' + user.uid).set({
        uid: user.uid,
        username: user.displayName || 'Utilisateur',
        email: user.email,
        av