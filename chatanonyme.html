<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>SIS CHAT ANONYME</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
  font-family: Arial, sans-serif;
  background-color: #b6e5f7;
  margin: 0;
  padding: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  height: 100vh;
}
h1 {
  margin: 20px 0;
  color: #004d99;
  text-shadow: 1px 1px 2px #a0c4e8;
}
#onlineUsers,#statusMessage {
  background: #fff;
  padding: 10px 20px;
  border-radius: 12px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  margin-bottom: 10px;
  font-size: 16px;
  color: #004d99;
  text-align: center;
}
#statusMessage span {
  animation: blink 1s infinite;
}
@keyframes blink {
  0%,100%{opacity:1;}
  50%{opacity:0;}
}
#discuterBtn, #uploadAvatarBtn {
  background: #004d99;
  color: #fff;
  border: none;
  border-radius: 12px;
  padding: 12px 20px;
  font-size: 16px;
  cursor: pointer;
  margin-bottom: 10px;
}
#discuterBtn:hover, #uploadAvatarBtn:hover { background: #003366; }
#avatarPreview { width: 50px; height: 50px; border-radius: 50%; margin-bottom: 10px; object-fit: cover; display: none; }
#chatSection {
  display: none;
  flex-direction: column;
  justify-content: space-between;
  width: 100%;
  max-width: 500px;
  height: 70%;
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  overflow: hidden;
  animation: fadeIn 0.5s ease;
}
@keyframes fadeIn { from{opacity:0} to{opacity:1} }
#messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
.message-container { display: flex; align-items: flex-end; animation: pop 0.2s ease; position: relative; }
@keyframes pop { from{transform: scale(0.8);opacity:0;} to{transform: scale(1);opacity:1;} }
.message-container.me { flex-direction: row-reverse; }
.message-container img { width: 35px; height: 35px; border-radius: 50%; margin: 0 8px; }
.message-text {
  border-radius: 20px;
  padding: 10px 15px;
  line-height: 1.4;
  position: relative;
  max-width: 70%;
  word-wrap: break-word;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
.me .message-text { background: #004d99; color: #fff; }
.other .message-text { background: #e0e0e0; color: #000; }
.seen { font-size: 10px; color: #0a0; margin-left: 5px; }
.system { background: #f0f0f0; color: #555; font-style: italic; text-align: center; align-self: center; border-radius: 12px; padding: 6px 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);}
#inputSection { display: flex; flex-direction: column; padding: 10px; background: #f9f9f9; border-top: 1px solid #ddd; }
#replyPreview { display: none; padding: 8px 12px; background: #e0e0e0; border-left: 4px solid #004d99; border-radius: 12px; margin-bottom: 5px; font-size: 14px; color: #000; position: relative; }
#cancelReply { cursor: pointer; position: absolute; top: 4px; right: 8px; color: #004d99; font-weight: bold; }
#messageInput { flex: 1; resize: none; padding: 10px; border-radius: 12px; border: 1px solid #ccc; outline: none; min-height: 40px; max-height: 120px; overflow-y: auto; font-size: 14px; }
#sendBtn { background: #004d99; color: #fff; border: none; border-radius: 12px; padding: 10px 15px; cursor: pointer; margin-top: 5px; align-self: flex-end; }
#sendBtn:hover { background: #003366; }
#typingStatus { font-style: italic; font-size: 12px; color: #004d99; margin-top: 5px; }

/* Emoji flag bas gauche */
.message-footer {
  position: relative;
  margin-top: 0;
  height: 0;
}
.message-flag {
  position: absolute;
  bottom: 4px;
  left: 4px;
  font-size: 18px;
  line-height: 1;
}
.message-time { font-size: 10px; color: #888; margin-left: 6px; }
.me .message-time { color: #cce0ff; }
</style>
</head>
<body>

<h1>SIS CHAT ANONYME</h1>
<img id="avatarPreview" src="" alt="Avatar">
<input type="file" id="avatarInput" accept="image/*" style="margin-bottom:10px;">
<button id="uploadAvatarBtn">Téléverser Avatar</button>
<div id="onlineUsers">En ligne : 0</div>
<div id="statusMessage"></div>
<button id="discuterBtn">Discuter</button>

<div id="chatSection">
  <div id="messages"></div>
  <div id="typingStatus"></div>
  <div id="inputSection">
    <div id="replyPreview">
      <strong id="replySender"></strong>: <span id="replyText"></span>
      <span id="cancelReply">✖</span>
    </div>
    <textarea id="messageInput" placeholder="Écrire un message..."></textarea>
    <button id="sendBtn">➤</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDUf-Rf6fhQXBmtJJ4R9K1IXBFdTl34Z5s",
  authDomain: "chat-anonyme.firebaseapp.com",
  databaseURL: "https://chat-anonyme-default-rtdb.firebaseio.com",
  projectId: "chat-anonyme",
  storageBucket: "chat-anonyme.firebasestorage.app",
  messagingSenderId: "93366459642",
  appId: "1:93366459642:web:a2421c9478909b33667d43",
  measurementId: "G-MF8RGP29LN"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const userId = db.ref().push().key;
let avatarURL = `https://ui-avatars.com/api/?name=U&background=${Math.floor(Math.random()*16777215).toString(16)}&color=ffffff`;
db.ref("avatars/"+userId).set(avatarURL);

let userCountryCode = null;
fetch('https://get.geojs.io/v1/ip/country.json')
  .then(res => res.json())
  .then(data => { if(data && data.country) userCountryCode = data.country; })
  .catch(console.error);

const userRef = db.ref("onlineUsers").child(userId);
userRef.set(true);
userRef.onDisconnect().remove();

const onlineUsersDiv = document.getElementById("onlineUsers");
const statusMessage = document.getElementById("statusMessage");
const discuterBtn = document.getElementById("discuterBtn");
const chatSection = document.getElementById("chatSection");
const messagesDiv = document.getElementById("messages");
const messageInput = document.getElementById("messageInput");
const sendBtn = document.getElementById("sendBtn");
const typingStatus = document.getElementById("typingStatus");
const avatarInput = document.getElementById("avatarInput");
const uploadAvatarBtn = document.getElementById("uploadAvatarBtn");
const avatarPreview = document.getElementById("avatarPreview");
const replyPreview = document.getElementById("replyPreview");
const replySender = document.getElementById("replySender");
const replyText = document.getElementById("replyText");
const cancelReply = document.getElementById("cancelReply");
let roomRef = null;
let roomId = null;
let partnerLeft = false;
let matchmakingTimeout = null;
let typingTimeout = null;
let replyToMessageId = null;

const countryToEmoji = (countryCode) => {
  return countryCode ? countryCode.toUpperCase().replace(/./g, c => String.fromCodePoint(0x1F1E6 + c.charCodeAt(0) - 65)) : '';
}

db.ref("onlineUsers").on("value", snap=>{
  const users = snap.val()||{};
  onlineUsersDiv.textContent = "En ligne : "+Object.keys(users).length;
});

uploadAvatarBtn.addEventListener("click", ()=>{
  const file = avatarInput.files[0];
  if(!file) return alert("Veuillez choisir une image");
  const reader = new FileReader();
  reader.onload = function(e){
    avatarURL = e.target.result;
    db.ref("avatars/"+userId).set(avatarURL);
    avatarPreview.src = avatarURL;
    avatarPreview.style.display = "block";
  }
  reader.readAsDataURL(file);
});

discuterBtn.addEventListener("click", ()=>{
  discuterBtn.disabled = true;
  statusMessage.innerHTML='Recherche en cours<span>...</span>';
  joinQueue();
  matchmakingTimeout = setTimeout(()=>{
    statusMessage.textContent = "Aucun partenaire trouvé, veuillez réessayer.";
    discuterBtn.disabled = false;
    db.ref("queue/"+userId).remove();
  },20000);
});

// --- Fonctions pour rejoindre la queue, ouvrir chat et envoyer message ---
function joinQueue(){ /* … implémentation … */ }
function openChat(roomId){ /* … implémentation … */ }
function addMessage(text, type, senderId, time, seen, replyId, country){
  const container = document.createElement("div");
  container.classList.add("message-container", type);
  const textDiv = document.createElement("div");
  textDiv.classList.add("message-text");
  textDiv.appendChild(document.createTextNode(text));
  
  const footerDiv = document.createElement("div");
  footerDiv.classList.add("message-footer");
  const flagSpan = document.createElement("span");
  flagSpan.classList.add("message-flag");
  flagSpan.textContent = country ? countryToEmoji(country) : '';
  footerDiv.appendChild(flagSpan);
  
  textDiv.appendChild(footerDiv);
  container.appendChild(textDiv);
  messagesDiv.appendChild(container);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}
</script>
</body>
</html>