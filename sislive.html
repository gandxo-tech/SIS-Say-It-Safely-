<!DOCTYPE html>
<html lang="fr" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIS Live Audio</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&family=JetBrains+Mono:wght@600&display=swap" rel="stylesheet">
    <style>
:root{--sis-blue:#4A90E2;--sis-purple:#9B59B6;--sis-gradient:linear-gradient(135deg,#4A90E2,#9B59B6);--bg-primary:#fff;--bg-secondary:#f8f9fb;--bg-tertiary:#f0f2f5;--bg-card:#fff;--text-primary:#1a1a2e;--text-secondary:#6b7280;--text-muted:#9ca3af;--border:#e5e7eb;--shadow:0 4px 20px rgba(0,0,0,.08);--success:#10b981;--error:#ef4444;--warning:#f59e0b;--live-red:#ff3b30;--radius:16px}
[data-theme=dark]{--bg-primary:#0a0a14;--bg-secondary:#12121e;--bg-tertiary:#1a1a2e;--bg-card:#1a1a2e;--text-primary:#fff;--text-secondary:#a0a0b8;--text-muted:#6e6e88;--border:rgba(255,255,255,.08);--shadow:0 8px 32px rgba(0,0,0,.4)}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Outfit,sans-serif;background:var(--bg-primary);color:var(--text-primary);line-height:1.6;transition:all .3s}
.container{max-width:1400px;margin:0 auto;padding:20px}
.hidden{display:none!important}
.header{display:flex;justify-content:space-between;align-items:center;padding:1.5rem 0;margin-bottom:2rem}
.logo-container{display:flex;align-items:center;gap:.75rem}
.logo-img{width:48px;height:48px}
.logo-text{font-size:1.5rem;font-weight:800;background:var(--sis-gradient);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.theme-toggle{background:var(--bg-card);border:1px solid var(--border);border-radius:50px;padding:.5rem;cursor:pointer;display:flex;gap:.5rem}
.theme-option{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .3s}
.theme-option.active{background:var(--sis-gradient)}
.btn{padding:.75rem 1.5rem;border-radius:12px;font-weight:600;font-size:.95rem;border:none;cursor:pointer;transition:all .3s;display:inline-flex;align-items:center;gap:.5rem;font-family:Outfit,sans-serif}
.btn-primary{background:var(--sis-gradient);color:#fff;box-shadow:0 4px 12px rgba(74,144,226,.3)}
.btn-primary:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(74,144,226,.5)}
.btn-secondary{background:var(--bg-card);color:var(--text-primary);border:1px solid var(--border)}
.btn-ghost{background:0 0;color:var(--text-secondary)}
.btn-danger{background:var(--error);color:#fff}
.btn-sm{padding:.5rem 1rem;font-size:.875rem}
.btn:disabled{opacity:.5;cursor:not-allowed}
.fab{position:fixed;bottom:2rem;right:2rem;width:64px;height:64px;border-radius:50%;background:var(--sis-gradient);color:#fff;font-size:2rem;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 24px rgba(74,144,226,.4);cursor:pointer;z-index:1000;border:none}
.fab:hover{transform:scale(1.1) rotate(90deg)}
.card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:1.5rem;transition:all .3s}
.card:hover{transform:translateY(-2px);box-shadow:var(--shadow)}
.badge{display:inline-flex;align-items:center;gap:.375rem;padding:.375rem .75rem;border-radius:50px;font-size:.875rem;font-weight:600}
.badge-live{background:var(--live-red);color:#fff;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
.badge-live::before{content:'';width:8px;height:8px;background:#fff;border-radius:50%;animation:blink 1.5s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
.input{width:100%;padding:.75rem 1rem;background:var(--bg-tertiary);border:1px solid var(--border);border-radius:12px;color:var(--text-primary);font-size:1rem;font-family:Outfit,sans-serif}
.input:focus{outline:0;border-color:var(--sis-blue);box-shadow:0 0 0 3px rgba(74,144,226,.1)}
.input-group{margin-bottom:1.5rem}
.input-label{display:block;margin-bottom:.5rem;font-weight:600}
.lives-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:1.5rem;margin-top:2rem}
.live-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;cursor:pointer;transition:all .3s}
.live-card:hover{transform:translateY(-4px);box-shadow:var(--shadow);border-color:var(--sis-blue)}
.live-card-cover{width:100%;height:180px;background:var(--sis-gradient);position:relative;display:flex;align-items:center;justify-content:center;font-size:3rem}
.live-card-cover img{width:100%;height:100%;object-fit:cover}
.live-card-status{position:absolute;top:1rem;left:1rem}
.live-card-visibility{position:absolute;top:1rem;right:1rem;width:36px;height:36px;background:rgba(0,0,0,.5);backdrop-filter:blur(10px);border-radius:50%;display:flex;align-items:center;justify-content:center}
.live-card-body{padding:1.25rem}
.live-card-host{display:flex;align-items:center;gap:.75rem;margin-bottom:1rem}
.live-card-host-avatar{width:40px;height:40px;border-radius:50%;background:var(--sis-gradient);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
.live-card-title{font-size:1.1rem;font-weight:700;margin-bottom:.5rem}
.wizard-progress{display:flex;justify-content:center;gap:1rem;margin:2rem 0}
.wizard-step-number{width:40px;height:40px;border-radius:50%;background:var(--bg-tertiary);border:2px solid var(--border);display:flex;align-items:center;justify-content:center;font-weight:700}
.wizard-step.active .wizard-step-number{background:var(--sis-gradient);color:#fff;border:none}
.wizard-content{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:2rem;margin-bottom:2rem}
.choice-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1rem;margin-top:1rem}
.choice-card{background:var(--bg-tertiary);border:2px solid var(--border);border-radius:var(--radius);padding:2rem;text-align:center;cursor:pointer;transition:all .3s}
.choice-card:hover{border-color:var(--sis-blue)}
.choice-card.selected{border-color:var(--sis-blue);background:rgba(74,144,226,.1)}
.choice-card-icon{font-size:3rem;margin-bottom:1rem}
.toggle-switch{position:relative;width:52px;height:28px;background:var(--bg-secondary);border-radius:50px;cursor:pointer;border:2px solid var(--border)}
.toggle-switch::after{content:'';position:absolute;width:20px;height:20px;background:var(--text-muted);border-radius:50%;top:2px;left:2px;transition:all .3s}
.toggle-switch.active{background:var(--sis-gradient);border:none}
.toggle-switch.active::after{left:26px;background:#fff}
.toggle-item{display:flex;justify-content:space-between;align-items:center;padding:1rem;background:var(--bg-tertiary);border-radius:12px;margin-bottom:.75rem}
.live-room{position:fixed;top:0;left:0;right:0;bottom:0;background:var(--bg-primary);z-index:2000;display:flex;flex-direction:column}
.live-room-header{padding:1rem 1.5rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;background:var(--bg-card)}
.live-room-stage{flex:1;padding:2rem;overflow-y:auto}
.speaker-avatar{position:relative;margin-bottom:1rem}
.speaker-avatar-img{width:120px;height:120px;border-radius:50%;background:var(--sis-gradient);display:flex;align-items:center;justify-content:center;color:#fff;font-size:2.5rem;font-weight:700}
.speaker-avatar.speaking .audio-wave{animation:wave-pulse 1.5s ease-out infinite}
.audio-waves{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none}
.audio-wave{position:absolute;width:100%;height:100%;border-radius:50%;border:3px solid var(--sis-blue);opacity:0}
@keyframes wave-pulse{0%{transform:scale(1);opacity:.6}100%{transform:scale(1.8);opacity:0}}
.live-room-chat{height:400px;background:var(--bg-secondary);display:flex;flex-direction:column}
.chat-tabs{display:flex;border-bottom:1px solid var(--border)}
.chat-tab{flex:1;padding:1rem;text-align:center;font-weight:600;cursor:pointer;color:var(--text-secondary);border-bottom:3px solid transparent}
.chat-tab.active{color:var(--text-primary);border-color:var(--sis-blue)}
.chat-messages{flex:1;overflow-y:auto;padding:1rem}
.chat-message{display:flex;gap:.75rem;margin-bottom:1rem}
.chat-message-avatar{width:36px;height:36px;border-radius:50%;background:var(--sis-gradient);color:#fff;font-weight:700;display:flex;align-items:center;justify-content:center;font-size:.875rem}
.chat-input-container{padding:1rem;border-top:1px solid var(--border);background:var(--bg-card)}
.chat-input-wrapper{display:flex;gap:.75rem}
.chat-input{flex:1;padding:.75rem 1rem;background:var(--bg-tertiary);border:1px solid var(--border);border-radius:50px;color:var(--text-primary)}
.chat-send-btn{width:40px;height:40px;border-radius:50%;background:var(--sis-gradient);color:#fff;border:none;display:flex;align-items:center;justify-content:center;cursor:pointer}
.reaction-btn{width:44px;height:44px;border-radius:50%;background:var(--bg-tertiary);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:1.5rem;cursor:pointer}
.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;z-index:3000}
.modal{background:var(--bg-card);border:1px solid var(--border);border-radius:24px;max-width:500px;width:90%;max-height:90vh;overflow-y:auto}
.modal-header{padding:1.5rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between}
.modal-body{padding:1.5rem}
.modal-footer{padding:1.5rem;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:1rem}
.toast{position:fixed;bottom:2rem;left:50%;transform:translateX(-50%);background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:1rem 1.5rem;box-shadow:0 20px 60px rgba(0,0,0,.3);z-index:4000;display:flex;gap:.75rem}
.code-input-box{width:50px;height:60px;text-align:center;font-family:'JetBrains Mono',monospace;font-size:1.5rem;font-weight:700;background:var(--bg-tertiary);border:2px solid var(--border);border-radius:12px;color:var(--text-primary);text-transform:uppercase}
@media (max-width:768px){.lives-grid{grid-template-columns:1fr}.choice-cards{grid-template-columns:1fr}}
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo-container">
                <img src="/unnamed-3-removebg-preview-1.png" alt="SIS" class="logo-img">
                <div class="logo-text">SIS Live Audio</div>
            </div>
            <div class="theme-toggle" id="themeToggle">
                <div class="theme-option" data-theme="light">‚òÄÔ∏è</div>
                <div class="theme-option active" data-theme="dark">üåô</div>
            </div>
        </header>

        <!-- EXPLORER SECTION -->
        <section id="explorerSection">
            <h1>Explorez les Lives Audio</h1>
            <p style="color:var(--text-secondary)">Rejoignez des conversations en direct ou programm√©es</p>
            <div id="livesGrid" class="lives-grid"></div>
            <div id="emptyState" class="hidden" style="text-align:center;padding:4rem 2rem">
                <div style="font-size:4rem;opacity:.3">üéôÔ∏è</div>
                <h3>Aucun live disponible</h3>
                <button class="btn btn-primary" onclick="showCreate()">Cr√©er un Live</button>
            </div>
        </section>

        <!-- CREATE SECTION -->
        <section id="createSection" class="hidden">
            <h1 style="text-align:center">Cr√©er un Live Audio</h1>
            <div class="wizard-progress">
                <div class="wizard-step active"><div class="wizard-step-number">1</div></div>
                <div style="width:60px;height:2px;background:var(--border);margin:0 .5rem"></div>
                <div class="wizard-step"><div class="wizard-step-number">2</div></div>
                <div style="width:60px;height:2px;background:var(--border);margin:0 .5rem"></div>
                <div class="wizard-step"><div class="wizard-step-number">3</div></div>
                <div style="width:60px;height:2px;background:var(--border);margin:0 .5rem"></div>
                <div class="wizard-step"><div class="wizard-step-number">4</div></div>
            </div>

            <div id="step1" class="wizard-content">
                <h2>üìù Informations de base</h2>
                <div class="input-group">
                    <label class="input-label">Titre <span style="color:var(--error)">*</span></label>
                    <input type="text" id="liveTitle" class="input" placeholder="Ex: Discussion Tech 2025" maxlength="100">
                </div>
                <div class="input-group">
                    <label class="input-label">Description</label>
                    <textarea id="liveDescription" class="input" style="min-height:120px" maxlength="500"></textarea>
                </div>
                <div class="input-group">
                    <label class="input-label">Cat√©gorie <span style="color:var(--error)">*</span></label>
                    <select id="liveCategory" class="input">
                        <option value="">S√©lectionnez</option>
                        <option value="education">üìö √âducation</option>
                        <option value="discussion">üí¨ Discussion</option>
                        <option value="qa">‚ùì Q&A</option>
                        <option value="music">üéµ Musique</option>
                        <option value="tech">üíª Technologie</option>
                        <option value="news">üì∞ Actualit√©s</option>
                        <option value="art">üé® Art & Cr√©ativit√©</option>
                        <option value="gaming">üéÆ Gaming</option>
                    </select>
                </div>
            </div>

            <div id="step2" class="wizard-content hidden">
                <h2>üìÖ Planification</h2>
                <div class="choice-cards">
                    <div class="choice-card selected" data-timing="now">
                        <div class="choice-card-icon">üî¥</div>
                        <h3>D√©marrer maintenant</h3>
                        <p style="color:var(--text-secondary)">Commencer imm√©diatement</p>
                    </div>
                    <div class="choice-card" data-timing="schedule">
                        <div class="choice-card-icon">üìÖ</div>
                        <h3>Programmer</h3>
                        <p style="color:var(--text-secondary)">Planifier pour plus tard</p>
                    </div>
                </div>
                <div id="scheduleOptions" class="hidden" style="margin-top:2rem">
                    <div class="input-group">
                        <label class="input-label">Date</label>
                        <input type="date" id="scheduleDate" class="input">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Heure</label>
                        <input type="time" id="scheduleTime" class="input">
                    </div>
                </div>
            </div>

            <div id="step3" class="wizard-content hidden">
                <h2>üîí Confidentialit√©</h2>
                <div class="choice-cards">
                    <div class="choice-card selected" data-visibility="public">
                        <div class="choice-card-icon">üåç</div>
                        <h3>Public</h3>
                        <p style="color:var(--text-secondary)">Tout le monde peut rejoindre</p>
                    </div>
                    <div class="choice-card" data-visibility="private">
                        <div class="choice-card-icon">üîí</div>
                        <h3>Priv√©</h3>
                        <p style="color:var(--text-secondary)">Avec code d'acc√®s</p>
                    </div>
                </div>
                <div id="accessCodeSection" class="hidden" style="background:var(--bg-tertiary);border:2px dashed var(--sis-blue);border-radius:16px;padding:1.5rem;margin-top:1rem;text-align:center">
                    <div style="font-family:'JetBrains Mono';font-size:2rem;font-weight:700;color:var(--sis-blue);margin:1rem 0" id="accessCode">AB4X7K</div>
                    <button class="btn btn-secondary btn-sm" onclick="regenerateCode()">üîÑ R√©g√©n√©rer</button>
                </div>
                <h3 style="margin-top:2rem">Param√®tres</h3>
                <div class="toggle-item">
                    <div>
                        <h4>Activer le chat</h4>
                        <p style="color:var(--text-secondary);font-size:.875rem">Messages activ√©s</p>
                    </div>
                    <div class="toggle-switch active" data-setting="chat"></div>
                </div>
                <div class="toggle-item">
                    <div>
                        <h4>Autoriser demandes de parole</h4>
                        <p style="color:var(--text-secondary);font-size:.875rem">Lever la main</p>
                    </div>
                    <div class="toggle-switch active" data-setting="handRaise"></div>
                </div>
            </div>

            <div id="step4" class="wizard-content hidden">
                <h2>‚úÖ Confirmation</h2>
                <div id="summary" style="background:var(--bg-tertiary);border-radius:16px;padding:2rem">
                    <h3 id="summaryTitle">Titre du Live</h3>
                    <p id="summaryDesc" style="color:var(--text-secondary)">Description...</p>
                    <div style="margin-top:1.5rem">
                        <p><strong>Cat√©gorie:</strong> <span id="summaryCat">-</span></p>
                        <p><strong>D√©marrage:</strong> <span id="summaryTime">Imm√©diatement</span></p>
                        <p><strong>Visibilit√©:</strong> <span id="summaryVis">Public</span></p>
                    </div>
                </div>
            </div>

            <div style="display:flex;justify-content:space-between;gap:1rem">
                <button id="prevBtn" class="btn btn-ghost hidden" onclick="prevStep()">‚Üê Retour</button>
                <div style="flex:1"></div>
                <button id="nextBtn" class="btn btn-primary" onclick="nextStep()" disabled>Suivant ‚Üí</button>
                <button id="createBtn" class="btn btn-primary hidden" onclick="createLive()">üöÄ Cr√©er le Live</button>
            </div>
        </section>

        <button class="fab" onclick="showCreate()">+</button>
    </div>

    <!-- LIVE ROOM -->
    <div id="liveRoom" class="live-room hidden">
        <div class="live-room-header">
            <button class="btn btn-ghost btn-sm" onclick="leaveLive()">‚Üê Quitter</button>
            <div>
                <h2 id="roomTitle" style="font-size:1.25rem">Live Audio</h2>
                <span class="badge badge-live">EN DIRECT</span>
            </div>
            <div></div>
        </div>
        
        <div class="live-room-stage">
            <div style="text-align:center">
                <div class="speaker-avatar speaking">
                    <div class="speaker-avatar-img">JD</div>
                    <div class="audio-waves">
                        <div class="audio-wave"></div>
                        <div class="audio-wave" style="animation-delay:.5s"></div>
                        <div class="audio-wave" style="animation-delay:1s"></div>
                    </div>
                </div>
                <div style="font-weight:700;margin-top:1rem">John Doe</div>
                <div style="color:var(--text-secondary)">üëë H√¥te</div>
            </div>
        </div>

        <div style="padding:1rem;border-top:1px solid var(--border);text-align:center">
            <div style="display:inline-flex;gap:2rem">
                <div>üë• <strong id="listenersCount">0</strong> auditeurs</div>
                <div>‚è±Ô∏è <strong id="liveTimer">00:00</strong></div>
            </div>
        </div>

        <div class="live-room-chat">
            <div class="chat-tabs">
                <div class="chat-tab active">üí¨ Chat</div>
                <div class="chat-tab">üë• Participants</div>
            </div>
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input-container">
                <div style="display:flex;justify-content:center;gap:.5rem;margin-bottom:.75rem">
                    <button class="reaction-btn" onclick="sendReaction('üëè')">üëè</button>
                    <button class="reaction-btn" onclick="sendReaction('‚ù§Ô∏è')">‚ù§Ô∏è</button>
                    <button class="reaction-btn" onclick="sendReaction('üî•')">üî•</button>
                </div>
                <div class="chat-input-wrapper">
                    <input id="chatInput" class="chat-input" placeholder="Message..." maxlength="280">
                    <button id="chatSendBtn" class="chat-send-btn" onclick="sendMessage()">‚û§</button>
                </div>
            </div>
        </div>

        <div style="padding:1.5rem;border-top:1px solid var(--border);text-align:center">
            <button class="btn btn-primary" onclick="toggleMute()">
                <span id="muteIcon">üé§</span> <span id="muteLabel">Micro</span>
            </button>
        </div>
    </div>

    <script type="module">
import{initializeApp}from'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import{getAuth,signInAnonymously}from'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
import{getFirestore,collection,doc,addDoc,getDocs,query,orderBy,onSnapshot,serverTimestamp}from'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
import{getDatabase,ref,set,update,onValue,push}from'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

const app=initializeApp({
apiKey:"AIzaSyDRnYDiLKaTI-97Vb6bwGr6Kpvx_Ej2xOg",
authDomain:"sis-say-it-safely-pi.firebaseapp.com",
projectId:"sis-say-it-safely-pi",
databaseURL:"https://sis-say-it-safely-pi-default-rtdb.firebaseio.com",
storageBucket:"sis-say-it-safely-pi.firebasestorage.app",
messagingSenderId:"332914268472",
appId:"1:332914268472:web:aee3804481d7aee0e20e93"
});

const auth=getAuth(app);
const db=getFirestore(app);
const rtdb=getDatabase(app);

let currentUser=null;
let currentLive=null;
let step=1;
let liveData={title:'',description:'',category:'',timing:'now',visibility:'public',accessCode:generateCode(),settings:{chat:true,handRaise:true}};

signInAnonymously(auth).then(()=>{
currentUser={uid:auth.currentUser.uid,name:'User'+Math.random().toString(36).slice(2,8)};
loadLives();
});

window.showCreate=()=>{
document.getElementById('explorerSection').classList.add('hidden');
document.getElementById('createSection').classList.remove('hidden');
step=1;updateWizard();
};

window.showExplorer=()=>{
document.getElementById('explorerSection').classList.remove('hidden');
document.getElementById('createSection').classList.add('hidden');
};

window.nextStep=()=>{if(step<4){step++;updateWizard();}};
window.prevStep=()=>{if(step>1){step--;updateWizard();}};

function updateWizard(){
for(let i=1;i<=4;i++){
document.getElementById('step'+i).classList.toggle('hidden',i!==step);
document.querySelectorAll('.wizard-step')[i-1].classList.toggle('active',i===step);
}
document.getElementById('prevBtn').classList.toggle('hidden',step===1);
document.getElementById('nextBtn').classList.toggle('hidden',step===4);
document.getElementById('createBtn').classList.toggle('hidden',step!==4);
if(step===4)updateSummary();
validateStep();
}

function validateStep(){
let valid=false;
if(step===1)valid=liveData.title&&liveData.category;
else if(step===2)valid=liveData.timing==='now'||( liveData.scheduledDate&&liveData.scheduledTime);
else valid=true;
document.getElementById('nextBtn').disabled=!valid;
}

function updateSummary(){
document.getElementById('summaryTitle').textContent=liveData.title||'Sans titre';
document.getElementById('summaryDesc').textContent=liveData.description||'Pas de description';
document.getElementById('summaryCat').textContent=liveData.category||'-';
document.getElementById('summaryTime').textContent=liveData.timing==='now'?'Imm√©diatement':'Programm√©';
document.getElementById('summaryVis').textContent=liveData.visibility==='public'?'Public':'Priv√©';
}

document.getElementById('liveTitle').addEventListener('input',e=>{liveData.title=e.target.value;validateStep();});
document.getElementById('liveDescription').addEventListener('input',e=>{liveData.description=e.target.value;});
document.getElementById('liveCategory').addEventListener('change',e=>{liveData.category=e.target.value;validateStep();});

document.querySelectorAll('[data-timing]').forEach(el=>el.addEventListener('click',function(){
document.querySelectorAll('[data-timing]').forEach(e=>e.classList.remove('selected'));
this.classList.add('selected');
liveData.timing=this.dataset.timing;
document.getElementById('scheduleOptions').classList.toggle('hidden',liveData.timing!=='schedule');
validateStep();
}));

document.querySelectorAll('[data-visibility]').forEach(el=>el.addEventListener('click',function(){
document.querySelectorAll('[data-visibility]').forEach(e=>e.classList.remove('selected'));
this.classList.add('selected');
liveData.visibility=this.dataset.visibility;
document.getElementById('accessCodeSection').classList.toggle('hidden',liveData.visibility!=='private');
}));

document.querySelectorAll('.toggle-switch').forEach(el=>el.addEventListener('click',function(){
this.classList.toggle('active');
const setting=this.dataset.setting;
liveData.settings[setting]=this.classList.contains('active');
}));

window.regenerateCode=()=>{
liveData.accessCode=generateCode();
document.getElementById('accessCode').textContent=liveData.accessCode;
};

window.createLive=async()=>{
try{
const liveDoc=await addDoc(collection(db,'lives'),{
...liveData,
hostId:currentUser.uid,
hostName:currentUser.name,
status:liveData.timing==='now'?'live':'scheduled',
createdAt:serverTimestamp(),
stats:{currentListeners:0,peakListeners:0}
});
currentLive=liveDoc.id;
if(liveData.timing==='now'){
await set(ref(rtdb,`lives/${currentLive}`),{
host:{uid:currentUser.uid,name:currentUser.name,isMuted:false},
speakers:{},
listeners:{},
chat:{},
stats:{currentListeners:0}
});
joinLive(currentLive,false);
}else{
alert('Live programm√© avec succ√®s!');
showExplorer();
}
}catch(e){
alert('Erreur: '+e.message);
}
};

async function loadLives(){
const q=query(collection(db,'lives'),orderBy('createdAt','desc'));
onSnapshot(q,snapshot=>{
const lives=[];
snapshot.forEach(doc=>lives.push({id:doc.id,...doc.data()}));
renderLives(lives);
});
}

function renderLives(lives){
const grid=document.getElementById('livesGrid');
const empty=document.getElementById('emptyState');
if(lives.length===0){
grid.innerHTML='';
empty.classList.remove('hidden');
return;
}
empty.classList.add('hidden');
grid.innerHTML=lives.map(l=>`
<div class="live-card" onclick="joinLive('${l.id}',${!l.isPublic})">
<div class="live-card-cover">
${l.category?getCatIcon(l.category):'üéôÔ∏è'}
<div class="live-card-status">
${l.status==='live'?'<span class="badge badge-live">EN DIRECT</span>':'<span class="badge" style="background:var(--warning);color:#fff">üìÖ Programm√©</span>'}
</div>
<div class="live-card-visibility">${l.visibility==='public'?'üåç':'üîí'}</div>
</div>
<div class="live-card-body">
<div class="live-card-host">
<div class="live-card-host-avatar">${l.hostName.slice(0,2).toUpperCase()}</div>
<div>${l.hostName}</div>
</div>
<div class="live-card-title">${l.title}</div>
${l.status==='live'?`<div>üë• ${l.stats?.currentListeners||0}</div>`:''}
</div>
</div>
`).join('');
}

window.joinLive=async(liveId,isPrivate)=>{
if(isPrivate){
const code=prompt('Entrez le code d\'acc√®s:');
const liveDoc=await getDocs(query(collection(db,'lives')));
const live=liveDoc.docs.find(d=>d.id===liveId)?.data();
if(!live||live.accessCode!==code.toUpperCase()){
alert('Code incorrect');
return;
}
}
currentLive=liveId;
document.getElementById('liveRoom').classList.remove('hidden');
document.querySelector('.container').style.display='none';

const liveRef=ref(rtdb,`lives/${liveId}/listeners/${currentUser.uid}`);
await set(liveRef,{name:currentUser.name,joinedAt:Date.now()});

onValue(ref(rtdb,`lives/${liveId}/stats/currentListeners`),snap=>{
document.getElementById('listenersCount').textContent=snap.val()||0;
});

onValue(ref(rtdb,`lives/${liveId}/chat`),snap=>{
const messages=[];
snap.forEach(child=>messages.push(child.val()));
renderMessages(messages);
});

startTimer();
};

window.leaveLive=async()=>{
if(currentLive){
await set(ref(rtdb,`lives/${currentLive}/listeners/${currentUser.uid}`),null);
}
document.getElementById('liveRoom').classList.add('hidden');
document.querySelector('.container').style.display='block';
stopTimer();
};

window.sendMessage=async()=>{
const input=document.getElementById('chatInput');
if(!input.value.trim())return;
await push(ref(rtdb,`lives/${currentLive}/chat`),{
userId:currentUser.uid,
userName:currentUser.name,
message:input.value,
timestamp:Date.now()
});
input.value='';
};

window.sendReaction=async(emoji)=>{
await push(ref(rtdb,`lives/${currentLive}/reactions`),{
userId:currentUser.uid,
emoji:emoji,
timestamp:Date.now()
});
};

function renderMessages(messages){
const container=document.getElementById('chatMessages');
container.innerHTML=messages.map(m=>`
<div class="chat-message">
<div class="chat-message-avatar">${m.userName.slice(0,2).toUpperCase()}</div>
<div>
<div><strong>${m.userName}</strong></div>
<div>${m.message}</div>
</div>
</div>
`).join('');
container.scrollTop=container.scrollHeight;
}

let timerInterval;
function startTimer(){
let seconds=0;
timerInterval=setInterval(()=>{
seconds++;
const mins=Math.floor(seconds/60);
const secs=seconds%60;
document.getElementById('liveTimer').textContent=
`${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;
},1000);
}

function stopTimer(){
if(timerInterval)clearInterval(timerInterval);
}

function generateCode(){
return Math.random().toString(36).substring(2,8).toUpperCase();
}

function getCatIcon(cat){
const icons={education:'üìö',discussion:'üí¨',qa:'‚ùì',music:'üéµ',tech:'üíª',news:'üì∞',art:'üé®',gaming:'üéÆ'};
return icons[cat]||'üéôÔ∏è';
}

// Theme toggle
document.querySelectorAll('.theme-option').forEach(el=>el.addEventListener('click',function(){
document.querySelectorAll('.theme-option').forEach(e=>e.classList.remove('active'));
this.classList.add('active');
document.documentElement.setAttribute('data-theme',this.dataset.theme);
}));

window.toggleMute=()=>{
const icon=document.getElementById('muteIcon');
const label=document.getElementById('muteLabel');
if(icon.textContent==='üé§'){
icon.textContent='üîá';
label.textContent='Mut√©';
}else{
icon.textContent='üé§';
label.textContent='Micro';
}
};
    </script>
</body>
</html>
