<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SIS Live Audio üéôÔ∏è</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>

<!-- ===== AUTH SECTION ===== -->
<div class="section active" id="authSection">
    <div class="auth-container">
        <div class="auth-logo">
            <div class="logo-circle">
                <svg width="52" height="52" viewBox="0 0 24 24" fill="none">
                    <rect x="9" y="2" width="6" height="11" rx="3" fill="white"/>
                    <path d="M5 10a7 7 0 0 0 14 0" stroke="white" stroke-width="2" stroke-linecap="round"/>
                    <line x1="12" y1="17" x2="12" y2="21" stroke="white" stroke-width="2" stroke-linecap="round"/>
                    <line x1="8" y1="21" x2="16" y2="21" stroke="white" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </div>
            <div class="logo-waves">
                <span></span><span></span><span></span>
            </div>
        </div>
        <h1 class="auth-title">SIS Live Audio</h1>
        <p class="auth-subtitle">Plateforme audio live ¬∑ B√©nin üáßüáØ</p>
        
        <div class="auth-tabs">
            <button class="auth-tab active" data-tab="login">Connexion</button>
            <button class="auth-tab" data-tab="register">Inscription</button>
        </div>
        
        <form class="auth-form" id="loginForm">
            <div class="input-group">
                <svg class="input-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/>
                </svg>
                <input type="email" class="auth-input" id="loginEmail" placeholder="Email" autocomplete="email">
            </div>
            <div class="input-group">
                <svg class="input-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                </svg>
                <input type="password" class="auth-input" id="loginPassword" placeholder="Mot de passe" autocomplete="current-password">
            </div>
            <button type="submit" class="btn-primary">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/>
                </svg>
                Se connecter
            </button>
            <button type="button" class="btn-ghost" id="anonymousLoginBtn">
                üë§ Continuer en tant qu'invit√©
            </button>
        </form>
        
        <form class="auth-form hidden" id="registerForm">
            <div class="photo-upload-zone" id="photoUploadZone">
                <div class="photo-preview" id="photoPreview">
                    <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
                    </svg>
                    <span>Photo</span>
                </div>
                <input type="file" id="photoInput" accept="image/*" hidden>
            </div>
            <div class="input-group">
                <svg class="input-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
                </svg>
                <input type="text" class="auth-input" id="regName" placeholder="Nom complet" autocomplete="name">
            </div>
            <div class="input-group">
                <svg class="input-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/>
                </svg>
                <input type="email" class="auth-input" id="regEmail" placeholder="Email" autocomplete="email">
            </div>
            <div class="input-group">
                <svg class="input-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                </svg>
                <input type="password" class="auth-input" id="regPassword" placeholder="Mot de passe (6+)" autocomplete="new-password">
            </div>
            <button type="submit" class="btn-primary">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/>
                </svg>
                Cr√©er mon compte
            </button>
            <button type="button" class="btn-ghost" id="anonymousRegBtn">
                üë§ Continuer en tant qu'invit√©
            </button>
        </form>
        <div class="auth-error hidden" id="authError"></div>
    </div>
</div>

<!-- ===== EXPLORE SECTION ===== -->
<div class="section" id="exploreSection">
    <header class="app-header">
        <div class="header-brand">
            <div class="header-logo">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
                    <rect x="9" y="2" width="6" height="11" rx="3" fill="currentColor"/>
                    <path d="M5 10a7 7 0 0 0 14 0" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <line x1="12" y1="17" x2="12" y2="21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <line x1="8" y1="21" x2="16" y2="21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </div>
            <span class="header-name">SIS Live</span>
        </div>
        <div class="header-actions">
            <button class="header-btn" id="themeToggle">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                </svg>
            </button>
            <button class="header-btn pos-rel" id="notifBtn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                    <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                </svg>
                <span class="badge hidden" id="notifBadge">0</span>
            </button>
            <div class="user-avatar" id="userAvatar"></div>
            <button class="header-btn" id="logoutBtn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9"/>
                </svg>
            </button>
        </div>
    </header>

    <nav class="tabs-nav">
        <button class="tab active" data-tab="lives">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3" fill="currentColor"/>
            </svg>
            Lives
        </button>
        <button class="tab" data-tab="stats">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/>
            </svg>
            Stats
        </button>
    </nav>

    <div class="content">
        <div class="pane active" id="livesPane">
            <div class="lives-grid" id="livesGrid"></div>
            <div class="empty-state hidden" id="emptyLives">
                <div class="empty-icon">üéôÔ∏è</div>
                <p>Aucun live en cours</p>
                <span>Sois le premier √† d√©marrer !</span>
            </div>
        </div>
        
        <!-- STATS PANE - D√âTAILL√â -->
        <div class="pane" id="statsPane">
            <!-- Stats Cards -->
            <div class="stats-cards">
                <div class="stat-card stat-card-primary">
                    <div class="stat-icon">üí∞</div>
                    <div class="stat-value" id="statRevenue">0</div>
                    <div class="stat-label">FCFA gagn√©s</div>
                    <div class="stat-trend" id="revenueTrend"></div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üéôÔ∏è</div>
                    <div class="stat-value" id="statLives">0</div>
                    <div class="stat-label">Lives cr√©√©s</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚è±Ô∏è</div>
                    <div class="stat-value" id="statMinutes">0</div>
                    <div class="stat-label">Minutes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üë•</div>
                    <div class="stat-value" id="statListeners">0</div>
                    <div class="stat-label">Auditeurs</div>
                </div>
            </div>

            <!-- Revenus D√©taill√©s -->
            <div class="revenue-details">
                <h3 class="section-title">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                    </svg>
                    D√©tails des revenus
                </h3>
                
                <div class="revenue-breakdown">
                    <div class="revenue-item">
                        <div class="revenue-item-left">
                            <span class="revenue-icon">üéÅ</span>
                            <div>
                                <div class="revenue-item-label">Cadeaux re√ßus</div>
                                <div class="revenue-item-sublabel" id="giftsCount">0 cadeaux</div>
                            </div>
                        </div>
                        <div class="revenue-item-value" id="giftsRevenue">0 FCFA</div>
                    </div>

                    <div class="revenue-item">
                        <div class="revenue-item-left">
                            <span class="revenue-icon">üíé</span>
                            <div>
                                <div class="revenue-item-label">Cadeau le plus cher</div>
                                <div class="revenue-item-sublabel" id="topGift">Aucun</div>
                            </div>
                        </div>
                        <div class="revenue-item-value" id="topGiftValue">0 FCFA</div>
                    </div>

                    <div class="revenue-item">
                        <div class="revenue-item-left">
                            <span class="revenue-icon">üìä</span>
                            <div>
                                <div class="revenue-item-label">Revenu moyen/live</div>
                                <div class="revenue-item-sublabel" id="avgRevenueLives">0 lives</div>
                            </div>
                        </div>
                        <div class="revenue-item-value" id="avgRevenue">0 FCFA</div>
                    </div>

                    <div class="revenue-item">
                        <div class="revenue-item-left">
                            <span class="revenue-icon">üèÜ</span>
                            <div>
                                <div class="revenue-item-label">Meilleur live</div>
                                <div class="revenue-item-sublabel" id="bestLiveDate">Aucun</div>
                            </div>
                        </div>
                        <div class="revenue-item-value" id="bestLiveRevenue">0 FCFA</div>
                    </div>

                    <div class="revenue-item revenue-item-highlight">
                        <div class="revenue-item-left">
                            <span class="revenue-icon">üíµ</span>
                            <div>
                                <div class="revenue-item-label">Commission plateforme (10%)</div>
                                <div class="revenue-item-sublabel">‚Üí +229 01 96 92 73 22</div>
                            </div>
                        </div>
                        <div class="revenue-item-value" id="platformCommission">0 FCFA</div>
                    </div>
                </div>

                <!-- Cadeaux par type -->
                <h3 class="section-title" style="margin-top: 24px">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 12 20 22 4 22 4 12"/><rect x="2" y="7" width="20" height="5"/><line x1="12" y1="22" x2="12" y2="7"/>
                    </svg>
                    Cadeaux par type
                </h3>
                <div class="gifts-breakdown" id="giftsBreakdown"></div>
            </div>

            <!-- Charts -->
            <div class="charts">
                <div class="chart-card">
                    <h3>√âvolution revenus (30 jours)</h3>
                    <canvas id="revenueChart"></canvas>
                </div>
                <div class="chart-card">
                    <h3>R√©partition cadeaux</h3>
                    <canvas id="giftsChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <button class="fab" id="createLiveBtn" title="D√©marrer un live">
        <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <rect x="9" y="2" width="6" height="11" rx="3"/><path d="M5 10a7 7 0 0 0 14 0"/><line x1="12" y1="17" x2="12" y2="21"/><line x1="8" y1="21" x2="16" y2="21"/>
        </svg>
    </button>
</div>

<!-- ===== LIVE ROOM SECTION ===== -->
<div class="section" id="liveRoomSection">
    <div class="live-header">
        <button class="btn-back" id="leaveLiveBtn">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <path d="M19 12H5M5 12l7 7M5 12l7-7"/>
            </svg>
        </button>
        <div class="live-info">
            <h2 id="liveTitle">Live Room</h2>
            <div class="live-meta">
                <span class="badge-live"><span class="live-dot"></span>EN DIRECT</span>
                <span class="live-listeners">üë• <span id="listenerCount">0</span></span>
                <span class="live-timer">‚è±Ô∏è <span id="liveTimer">00:00</span></span>
            </div>
        </div>
        <div class="live-header-actions">
            <button class="btn-icon" id="shareLiveBtn" title="Partager">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/>
                    <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
                </svg>
            </button>
            <button class="btn-icon" id="menuBtn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="5" r="1.5" fill="currentColor"/><circle cx="12" cy="12" r="1.5" fill="currentColor"/><circle cx="12" cy="19" r="1.5" fill="currentColor"/>
                </svg>
            </button>
        </div>
    </div>

    <div class="stage" id="stage"></div>

    <div class="live-controls">
        <button class="ctrl-btn" id="muteBtn">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/>
            </svg>
            <span>Micro</span>
        </button>
        <button class="ctrl-btn ctrl-gift" id="sendGiftBtn">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20 12 20 22 4 22 4 12"/><rect x="2" y="7" width="20" height="5"/><line x1="12" y1="22" x2="12" y2="7"/>
                <path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"/><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"/>
            </svg>
            <span>Cadeau</span>
        </button>
        <button class="ctrl-btn ctrl-hand" id="raiseHandBtn">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 11V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v0M14 10V4a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v2M10 10.5V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v8"/>
                <path d="M18 8a2 2 0 1 1 4 0v6a8 8 0 0 1-8 8h-2c-2.8 0-4.5-.86-5.99-2.34l-3.6-3.6a2 2 0 0 1 2.83-2.82L7 15"/>
            </svg>
            <span>Main</span>
        </button>
        <button class="ctrl-btn ctrl-end" id="endLiveBtn">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>
            </svg>
            <span>Quitter</span>
        </button>
    </div>

    <div class="live-bottom">
        <div class="chat-tabs">
            <button class="chat-tab active" data-tab="chat">üí¨ Chat</button>
            <button class="chat-tab" data-tab="participants">üë• Participants</button>
        </div>
        <div class="tab-content">
            <div class="chat-pane active" id="chatPane">
                <div class="messages" id="messages"></div>
                <div class="reactions">
                    <button class="reaction-btn" data-emoji="üëè">üëè</button>
                    <button class="reaction-btn" data-emoji="‚ù§Ô∏è">‚ù§Ô∏è</button>
                    <button class="reaction-btn" data-emoji="üî•">üî•</button>
                    <button class="reaction-btn" data-emoji="üòÇ">üòÇ</button>
                </div>
                <div class="chat-input-wrapper">
                    <input type="text" class="chat-input" id="chatInput" placeholder="√âcrire un message..." maxlength="280">
                    <button class="btn-send" id="sendBtn">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="chat-pane" id="participantsPane">
                <div class="participants-list" id="participantsList"></div>
            </div>
        </div>
    </div>
</div>

<div id="modalsContainer"></div>
<div id="toastContainer"></div>
<div id="giftsAnimationContainer"></div>

<script type="module">
// Import Firebase
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signInAnonymously, onAuthStateChanged, signOut, updateProfile, EmailAuthProvider, linkWithCredential } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
import { getFirestore, collection, addDoc, getDocs, getDoc, doc, setDoc, updateDoc, query, where, orderBy, limit, Timestamp, increment, writeBatch } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';
import { getDatabase, ref as rtRef, push as rtPush, onValue, set as rtSet, off } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';

// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyBZoVJaCQlDZQut98gYK-Y85IRudSTNbNg",
  authDomain: "sisliveaudio.firebaseapp.com",
  databaseURL: "https://sisliveaudio-default-rtdb.firebaseio.com",
  projectId: "sisliveaudio",
  storageBucket: "sisliveaudio.firebasestorage.app",
  messagingSenderId: "987019026451",
  appId: "1:987019026451:web:3c1632e417765377b01fe6",
  measurementId: "G-33BE2GRRKP"
};

const fbApp = initializeApp(firebaseConfig);
const auth = getAuth(fbApp);
const db = getFirestore(fbApp);
const rtdb = getDatabase(fbApp);

// Agora Config
const AGORA_APP_ID = '64a6d3b2b6324eaa9991690bf361e4e3';
const PLATFORM_PHONE = '+22901969273222';
const COMMISSION_RATE = 0.10;

const GIFTS = {
  pain: { emoji: 'ü•ñ', name: 'Pain', price: 100 },
  cafe: { emoji: '‚òï', name: 'Caf√©', price: 200 },
  biere: { emoji: 'üç∫', name: 'Bi√®re', price: 500 },
  fleur: { emoji: 'üåª', name: 'Fleur', price: 1000 },
  diamant: { emoji: 'üíé', name: 'Diamant', price: 5000 }
};

// State
const state = {
  currentUser: null,
  currentLiveId: null,
  currentRole: null,
  liveStartTime: null,
  liveTimer: null,
  isDarkMode: localStorage.getItem('sis_dark') === '1',
  agoraClient: null,
  localTrack: null,
  isMuted: false
};

// Utils
function $(id) { return document.getElementById(id); }
function showToast(msg, ms = 3000) {
  const c = $('toastContainer');
  const t = document.createElement('div');
  t.className = 'toast';
  t.textContent = msg;
  c.appendChild(t);
  requestAnimationFrame(() => {
    requestAnimationFrame(() => t.classList.add('show'));
  });
  setTimeout(() => {
    t.classList.remove('show');
    setTimeout(() => t.remove(), 300);
  }, ms);
}
function showSection(id) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  $(id)?.classList.add('active');
}
let _loadEl = null;
function showLoading(msg = 'Chargement...') {
  if (_loadEl) return;
  _loadEl = document.createElement('div');
  _loadEl.className = 'loading-overlay';
  _loadEl.innerHTML = `<div class="loading-spinner"></div><p>${msg}</p>`;
  document.body.appendChild(_loadEl);
}
function hideLoading() { _loadEl?.remove(); _loadEl = null; }
function genCode(n = 6) {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  return Array.from({length: n}, () => chars[Math.floor(Math.random() * chars.length)]).join('');
}
function fmtTime(sec) {
  const m = Math.floor(sec / 60), s = sec % 60;
  return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}
function fmtNum(n) { return n >= 1000 ? (n/1000).toFixed(1)+'k' : String(n); }

// Dark mode
if (state.isDarkMode) document.body.classList.add('dark-mode');
$('themeToggle')?.addEventListener('click', () => {
  state.isDarkMode = !state.isDarkMode;
  document.body.classList.toggle('dark-mode', state.isDarkMode);
  localStorage.setItem('sis_dark', state.isDarkMode ? '1' : '0');
  showToast(state.isDarkMode ? 'üåô Mode sombre' : '‚òÄÔ∏è Mode clair');
});

// Tabs
document.querySelectorAll('.auth-tab').forEach(t => {
  t.addEventListener('click', () => {
    document.querySelectorAll('.auth-tab').forEach(x => x.classList.remove('active'));
    t.classList.add('active');
    const tab = t.dataset.tab;
    $('loginForm')?.classList.toggle('hidden', tab !== 'login');
    $('registerForm')?.classList.toggle('hidden', tab !== 'register');
  });
});

document.querySelectorAll('.tab').forEach(t => {
  t.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
    t.classList.add('active');
    document.querySelectorAll('.pane').forEach(p => p.classList.remove('active'));
    $(`${t.dataset.tab}Pane`)?.classList.add('active');
    if (t.dataset.tab === 'stats') loadStats();
  });
});

document.querySelectorAll('.chat-tab').forEach(t => {
  t.addEventListener('click', () => {
    document.querySelectorAll('.chat-tab').forEach(x => x.classList.remove('active'));
    t.classList.add('active');
    document.querySelectorAll('.chat-pane').forEach(p => p.classList.remove('active'));
    $(`${t.dataset.tab}Pane`)?.classList.add('active');
  });
});

// Photo upload
$('photoUploadZone')?.addEventListener('click', () => $('photoInput')?.click());
$('photoInput')?.addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (ev) => {
    const img = document.createElement('img');
    img.src = ev.target.result;
    const prev = $('photoPreview');
    prev.innerHTML = '';
    prev.appendChild(img);
    prev.dataset.photo = ev.target.result;
  };
  reader.readAsDataURL(file);
});

// Auth
$('loginForm')?.addEventListener('submit', async (e) => {
  e.preventDefault();
  const email = $('loginEmail').value.trim();
  const password = $('loginPassword').value;
  if (!email || !password) return showToast('‚ö†Ô∏è Remplis les champs');
  try {
    showLoading('Connexion...');
    await signInWithEmailAndPassword(auth, email, password);
    hideLoading();
  } catch (err) {
    hideLoading();
    const msgs = {
      'auth/user-not-found': '‚ùå Email introuvable',
      'auth/wrong-password': '‚ùå Mot de passe incorrect',
      'auth/invalid-email': '‚ùå Email invalide'
    };
    showToast(msgs[err.code] || '‚ùå Erreur de connexion');
    console.error(err);
  }
});

$('registerForm')?.addEventListener('submit', async (e) => {
  e.preventDefault();
  const name = $('regName').value.trim();
  const email = $('regEmail').value.trim();
  const password = $('regPassword').value;
  if (!name || !email || !password) return showToast('‚ö†Ô∏è Remplis tous les champs');
  if (password.length < 6) return showToast('‚ö†Ô∏è Mot de passe trop court (6+)');
  try {
    showLoading('Cr√©ation...');
    const cred = await createUserWithEmailAndPassword(auth, email, password);
    const user = cred.user;
    let photoURL = null;
    const photoData = $('photoPreview')?.dataset.photo;
    if (photoData) {
      photoURL = photoData;
      localStorage.setItem(`sis_photo_${user.uid}`, photoURL);
    }
    await updateProfile(user, { displayName: name });
    await setDoc(doc(db, 'users', user.uid), {
      displayName: name,
      email,
      photoURL: photoURL || null,
      isAnonymous: false,
      totalEarnings: 0,
      totalLives: 0,
      createdAt: Timestamp.now()
    });
    hideLoading();
    showToast('‚úÖ Compte cr√©√© ! Bienvenue ' + name);
  } catch (err) {
    hideLoading();
    const msgs = {
      'auth/email-already-in-use': '‚ùå Email d√©j√† utilis√©',
      'auth/invalid-email': '‚ùå Email invalide'
    };
    showToast(msgs[err.code] || '‚ùå Erreur d\'inscription');
    console.error(err);
  }
});

async function loginAnonymous() {
  try {
    showLoading('Connexion invit√©...');
    const cred = await signInAnonymously(auth);
    const user = cred.user;
    const guestName = `Invit√©${Math.floor(Math.random() * 9999)}`;
    await setDoc(doc(db, 'users', user.uid), {
      displayName: guestName,
      isAnonymous: true,
      createdAt: Timestamp.now(),
      totalEarnings: 0
    });
    hideLoading();
    showToast(`üë§ Connect√© en tant que ${guestName}`);
  } catch (err) {
    hideLoading();
    showToast('‚ùå Connexion anonyme impossible');
    console.error(err);
  }
}
$('anonymousLoginBtn')?.addEventListener('click', loginAnonymous);
$('anonymousRegBtn')?.addEventListener('click', loginAnonymous);

$('logoutBtn')?.addEventListener('click', async () => {
  if (state.currentLiveId) await leaveLive();
  await signOut(auth);
  state.currentUser = null;
  showToast('üëã D√©connect√©');
});

onAuthStateChanged(auth, async (user) => {
  if (user) {
    const localPhoto = localStorage.getItem(`sis_photo_${user.uid}`);
    state.currentUser = {
      uid: user.uid,
      email: user.email,
      displayName: user.displayName || `Invit√©${user.uid.slice(-4)}`,
      photoURL: localPhoto || user.photoURL,
      isAnonymous: user.isAnonymous
    };
    const av = $('userAvatar');
    if (av) {
      if (state.currentUser.photoURL) {
        av.innerHTML = `<img src="${state.currentUser.photoURL}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`;
      } else {
        av.textContent = state.currentUser.displayName.charAt(0).toUpperCase();
      }
    }
    showSection('exploreSection');
    loadLives();
    if (user.isAnonymous) showAnonymousBanner();
  } else {
    state.currentUser = null;
    showSection('authSection');
    removeAnonymousBanner();
  }
});

function showAnonymousBanner() {
  if ($('anonBanner')) return;
  const banner = document.createElement('div');
  banner.id = 'anonBanner';
  banner.className = 'anonymous-banner';
  banner.innerHTML = `
    <div class="anonymous-banner-inner">
      <span>üë§ Vous √™tes en mode invit√©</span>
      <button class="btn-convert" id="convertBtn">Cr√©er un compte</button>
    </div>`;
  document.body.appendChild(banner);
  $('convertBtn')?.addEventListener('click', showConvertModal);
}
function removeAnonymousBanner() { $('anonBanner')?.remove(); }

function showConvertModal() {
  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.innerHTML = `
    <div class="modal-content">
      <div class="modal-header">
        <h3>Cr√©er votre compte</h3>
        <button class="modal-close" id="closeConvertModal">√ó</button>
      </div>
      <p style="font-size:14px;color:var(--text-muted);margin-bottom:20px">Conservez votre historique !</p>
      <div style="display:flex;flex-direction:column;gap:12px" id="convertFormInner">
        <div class="input-group">
          <input type="text" class="auth-input" id="convName" placeholder="Nom complet" style="padding-left:16px">
        </div>
        <div class="input-group">
          <input type="email" class="auth-input" id="convEmail" placeholder="Email" style="padding-left:16px">
        </div>
        <div class="input-group">
          <input type="password" class="auth-input" id="convPwd" placeholder="Mot de passe (6+)" style="padding-left:16px">
        </div>
        <button class="btn-primary" id="doConvertBtn">Cr√©er mon compte</button>
      </div>
    </div>`;
  document.body.appendChild(overlay);
  requestAnimationFrame(() => requestAnimationFrame(() => overlay.classList.add('active')));
  $('closeConvertModal')?.addEventListener('click', () => {
    overlay.classList.remove('active');
    setTimeout(() => overlay.remove(), 300);
  });
  $('doConvertBtn')?.addEventListener('click', async () => {
    const name = $('convName').value.trim();
    const email = $('convEmail').value.trim();
    const pwd = $('convPwd').value;
    if (!name || !email || !pwd) return showToast('‚ö†Ô∏è Remplis tous les champs');
    if (pwd.length < 6) return showToast('‚ö†Ô∏è Mot de passe trop court');
    try {
      showLoading('Conversion...');
      const credential = EmailAuthProvider.credential(email, pwd);
      await linkWithCredential(auth.currentUser, credential);
      await updateProfile(auth.currentUser, { displayName: name });
      await updateDoc(doc(db, 'users', auth.currentUser.uid), {
        displayName: name,
        email,
        isAnonymous: false,
        updatedAt: Timestamp.now()
      });
      hideLoading();
      overlay.classList.remove('active');
      setTimeout(() => overlay.remove(), 300);
      removeAnonymousBanner();
      showToast('üéâ Compte cr√©√© ! Bienvenue ' + name);
    } catch (err) {
      hideLoading();
      if (err.code === 'auth/email-already-in-use') showToast('‚ùå Email d√©j√† utilis√©');
      else showToast('‚ùå Erreur de conversion');
      console.error(err);
    }
  });
}

// Agora
async function initAgoraClient() {
  if (typeof AgoraRTC === 'undefined') {
    await new Promise((res, rej) => {
      const s = document.createElement('script');
      s.src = 'https://download.agora.io/sdk/release/AgoraRTC_N-4.20.2.js';
      s.onload = res;
      s.onerror = rej;
      document.head.appendChild(s);
    });
  }
  return AgoraRTC.createClient({ mode: 'rtc', codec: 'vp8' });
}

async function joinAgoraChannel(channelName, uid) {
  try {
    state.agoraClient = await initAgoraClient();
    state.agoraClient.on('user-published', async (remoteUser, mediaType) => {
      await state.agoraClient.subscribe(remoteUser, mediaType);
      if (mediaType === 'audio') remoteUser.audioTrack.play();
    });
    state.agoraClient.on('user-unpublished', (remoteUser, mediaType) => {
      if (mediaType === 'audio') remoteUser.audioTrack?.stop();
    });
    await state.agoraClient.join(AGORA_APP_ID, channelName, null, uid);
    state.localTrack = await AgoraRTC.createMicrophoneAudioTrack({
      encoderConfig: { sampleRate: 48000, stereo: true, bitrate: 128 },
      ANS: true,
      AEC: true
    });
    await state.agoraClient.publish([state.localTrack]);
    state.agoraClient.enableAudioVolumeIndicator();
    state.agoraClient.on('volume-indicator', (volumes) => {
      volumes.forEach(({ uid: vUid, level }) => {
        const el = document.querySelector(`[data-uid="${vUid}"]`);
        if (el) el.classList.toggle('speaking', level > 8);
      });
      if (state.localTrack) {
        const myEl = document.querySelector(`[data-uid="${uid}"]`);
        if (myEl) {
          const vol = state.localTrack.getVolumeLevel ? Math.round(state.localTrack.getVolumeLevel() * 100) : 0;
          myEl.classList.toggle('speaking', vol > 8);
        }
      }
    });
    console.log('‚úÖ Agora joined');
    showToast('üéôÔ∏è Micro activ√© !');
  } catch (err) {
    console.error('Agora error:', err);
    if (err.name === 'NotAllowedError' || err.message?.includes('Permission')) {
      showToast('‚ö†Ô∏è Autorise le micro !');
    } else {
      showToast('‚ö†Ô∏è Probl√®me audio');
    }
  }
}

async function leaveAgoraChannel() {
  try {
    state.localTrack?.stop();
    state.localTrack?.close();
    state.localTrack = null;
    await state.agoraClient?.leave();
    state.agoraClient = null;
  } catch (e) { console.error(e); }
}

// Lives
async function loadLives() {
  const grid = $('livesGrid');
  const empty = $('emptyLives');
  if (!grid) return;
  try {
    const q = query(collection(db, 'lives'), where('status', '==', 'active'), orderBy('createdAt', 'desc'), limit(30));
    const snap = await getDocs(q);
    const lives = [];
    snap.forEach(d => lives.push({ id: d.id, ...d.data() }));
    if (lives.length === 0) {
      empty?.classList.remove('hidden');
      grid.innerHTML = '';
      return;
    }
    empty?.classList.add('hidden');
    grid.innerHTML = lives.map(live => {
      const initial = (live.hostName || '?').charAt(0).toUpperCase();
      const photo = live.hostPhoto ? `<img src="${live.hostPhoto}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">` : initial;
      return `
      <div class="live-card" onclick="joinLive('${live.id}')">
        <div class="live-card-header">
          <div class="live-card-avatar">${photo}</div>
          <span class="live-card-badge">LIVE</span>
        </div>
        <div class="live-card-body">
          <div class="live-card-title">${live.title || 'Live Audio'}</div>
          <div class="live-card-host">@${live.hostName || 'H√¥te'}</div>
          <div class="live-card-stats">
            <span>üë• ${live.listenerCount || 0}</span>
            ${live.isPrivate ? '<span>üîí</span>' : ''}
          </div>
        </div>
      </div>`;
    }).join('');
  } catch (err) { console.error(err); }
}

$('createLiveBtn')?.addEventListener('click', showCreateLiveModal);

function showCreateLiveModal() {
  if (!state.currentUser) return showToast('‚ö†Ô∏è Connecte-toi');
  if (state.currentUser.isAnonymous) return showToast('‚ö†Ô∏è Cr√©e un compte pour d√©marrer un live');
  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.innerHTML = `
    <div class="modal-content">
      <div class="modal-header">
        <h3>üéôÔ∏è D√©marrer un live</h3>
        <button class="modal-close" id="closeCreateModal">√ó</button>
      </div>
      <div style="display:flex;flex-direction:column;gap:14px">
        <input type="text" class="auth-input" id="liveTitle" placeholder="Titre du live..." style="padding-left:16px">
        <label style="display:flex;align-items:center;gap:10px;font-size:14px;cursor:pointer">
          <input type="checkbox" id="livePrivate" style="width:18px;height:18px">
          üîí Live priv√© (code d'acc√®s)
        </label>
        <button class="btn-primary" id="doCreateLiveBtn">D√©marrer</button>
      </div>
    </div>`;
  document.body.appendChild(overlay);
  requestAnimationFrame(() => requestAnimationFrame(() => overlay.classList.add('active')));
  $('closeCreateModal')?.addEventListener('click', () => {
    overlay.classList.remove('active');
    setTimeout(() => overlay.remove(), 300);
  });
  $('doCreateLiveBtn')?.addEventListener('click', async () => {
    const title = $('liveTitle').value.trim() || 'Live Audio';
    const isPrivate = $('livePrivate').checked;
    const code = isPrivate ? genCode(6) : null;
    overlay.classList.remove('active');
    setTimeout(() => overlay.remove(), 300);
    await createLive(title, isPrivate, code);
  });
}

async function createLive(title, isPrivate, code) {
  try {
    showLoading('Cr√©ation...');
    const liveData = {
      title,
      hostId: state.currentUser.uid,
      hostName: state.currentUser.displayName,
      hostPhoto: state.currentUser.photoURL || null,
      status: 'active',
      isPrivate,
      accessCode: code,
      listenerCount: 1,
      createdAt: Timestamp.now(),
      stats: { peakListeners: 1, hostRevenue: 0, gifts: {} }
    };
    const docRef = await addDoc(collection(db, 'lives'), liveData);
    hideLoading();
    if (isPrivate && code) showToast(`üîí Code: ${code}`, 6000);
    await enterLive(docRef.id, 'host', title);
  } catch (err) {
    hideLoading();
    showToast('‚ùå Erreur cr√©ation live');
    console.error(err);
  }
}

window.joinLive = async function(liveId) {
  try {
    const liveDoc = await getDoc(doc(db, 'lives', liveId));
    if (!liveDoc.exists()) return showToast('‚ùå Live introuvable');
    const live = liveDoc.data();
    if (live.isPrivate && live.hostId !== state.currentUser.uid) {
      const code = prompt('üîí Code d\'acc√®s:');
      if (code?.toUpperCase() !== live.accessCode) return showToast('‚ùå Code incorrect');
    }
    const role = live.hostId === state.currentUser.uid ? 'host' : 'listener';
    await enterLive(liveId, role, live.title);
  } catch (err) {
    showToast('‚ùå Impossible de rejoindre');
    console.error(err);
  }
};

async function enterLive(liveId, role, title) {
  state.currentLiveId = liveId;
  state.currentRole = role;
  state.liveStartTime = Date.now();
  $('liveTitle').textContent = title;
  showSection('liveRoomSection');
  state.liveTimer = setInterval(() => {
    const elapsed = Math.floor((Date.now() - state.liveStartTime) / 1000);
    const timerEl = $('liveTimer');
    if (timerEl) timerEl.textContent = fmtTime(elapsed);
  }, 1000);
  if (role === 'host') {
    await joinAgoraChannel(liveId, state.currentUser.uid.slice(-8));
    addSpeakerToStage(state.currentUser, 'host');
  } else {
    await joinAgoraChannel(liveId, state.currentUser.uid.slice(-8));
    if (state.localTrack) {
      await state.localTrack.setMuted(true);
      state.isMuted = true;
    }
  }
  listenChat(liveId);
  listenParticipants(liveId);
  await rtSet(rtRef(rtdb, `lives/${liveId}/participants/${state.currentUser.uid}`), {
    name: state.currentUser.displayName,
    role,
    joinedAt: Date.now()
  });
  updateControlsForRole(role);
  showToast(role === 'host' ? 'üéôÔ∏è Live d√©marr√© !' : 'üëã Tu as rejoint le live');
}

function addSpeakerToStage(user, role) {
  const stage = $('stage');
  if (!stage) return;
  const div = document.createElement('div');
  div.className = 'speaker-item';
  div.id = `speaker_${user.uid}`;
  const initial = user.displayName.charAt(0).toUpperCase();
  const photoHtml = user.photoURL
    ? `<img src="${user.photoURL}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`
    : initial;
  div.innerHTML = `
    <div class="speaker-avatar" data-uid="${user.uid.slice(-8)}">${photoHtml}</div>
    <span class="speaker-name">${user.displayName}</span>
    <span class="speaker-role">${role === 'host' ? 'üëë' : 'üéôÔ∏è'}</span>`;
  stage.appendChild(div);
}

function updateControlsForRole(role) {
  const raiseBtn = $('raiseHandBtn');
  const endBtn = $('endLiveBtn');
  if (role === 'host') {
    raiseBtn?.classList.add('hidden');
  } else {
    if (endBtn) endBtn.querySelector('span').textContent = 'Quitter';
  }
}

$('leaveLiveBtn')?.addEventListener('click', () => leaveLive());
$('endLiveBtn')?.addEventListener('click', () => leaveLive());

async function leaveLive() {
  if (!state.currentLiveId) return;
  clearInterval(state.liveTimer);
  await rtSet(rtRef(rtdb, `lives/${state.currentLiveId}/participants/${state.currentUser?.uid}`), null);
  if (state.currentRole === 'host') {
    await updateDoc(doc(db, 'lives', state.currentLiveId), {
      status: 'ended',
      endedAt: Timestamp.now()
    });
  }
  await leaveAgoraChannel();
  off(rtRef(rtdb, `lives/${state.currentLiveId}/messages`));
  off(rtRef(rtdb, `lives/${state.currentLiveId}/participants`));
  state.currentLiveId = null;
  state.currentRole = null;
  const stage = $('stage');
  if (stage) stage.innerHTML = '';
  const messages = $('messages');
  if (messages) messages.innerHTML = '';
  showSection('exploreSection');
  setTimeout(loadLives, 500);
  showToast('üëã Live quitt√©');
}

$('muteBtn')?.addEventListener('click', async () => {
  if (!state.localTrack) return showToast('‚ö†Ô∏è Micro non disponible');
  state.isMuted = !state.isMuted;
  await state.localTrack.setMuted(state.isMuted);
  const btn = $('muteBtn');
  const span = btn?.querySelector('span');
  if (state.isMuted) {
    btn?.classList.add('muted');
    if (span) span.textContent = 'Activ√©';
    showToast('üîá Micro coup√©');
  } else {
    btn?.classList.remove('muted');
    if (span) span.textContent = 'Micro';
    showToast('üéôÔ∏è Micro actif');
  }
});

// Chat
function listenChat(liveId) {
  const chatRef = rtRef(rtdb, `lives/${liveId}/messages`);
  onValue(chatRef, (snap) => {
    const msgs = $('messages');
    if (!msgs) return;
    msgs.innerHTML = '';
    snap.forEach(child => {
      const m = child.val();
      const div = document.createElement('div');
      div.className = 'message-item';
      const initial = (m.name || '?').charAt(0).toUpperCase();
      const photoHtml = m.photoURL
        ? `<img src="${m.photoURL}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`
        : initial;
      if (m.type === 'reaction') {
        div.innerHTML = `
          <div class="msg-avatar">${photoHtml}</div>
          <div class="msg-content"><span class="msg-name">${m.name}</span><span class="msg-reaction">${m.text}</span></div>`;
      } else {
        div.innerHTML = `
          <div class="msg-avatar">${photoHtml}</div>
          <div class="msg-content"><div class="msg-name">${m.name}</div><div class="msg-text">${m.text}</div></div>`;
      }
      msgs.appendChild(div);
    });
    msgs.scrollTop = msgs.scrollHeight;
  });
}

let msgCooldown = 0;
async function sendChatMessage(text, type = 'chat') {
  if (!state.currentLiveId || !state.currentUser) return;
  const now = Date.now();
  if (now - msgCooldown < 1000) return showToast('‚è±Ô∏è Attends 1 seconde');
  msgCooldown = now;
  await rtPush(rtRef(rtdb, `lives/${state.currentLiveId}/messages`), {
    uid: state.currentUser.uid,
    name: state.currentUser.displayName,
    photoURL: state.currentUser.photoURL || null,
    text,
    type,
    ts: Date.now()
  });
}

$('sendBtn')?.addEventListener('click', () => {
  const input = $('chatInput');
  const val = input?.value.trim();
  if (!val) return;
  sendChatMessage(val);
  input.value = '';
});

$('chatInput')?.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    const val = e.target.value.trim();
    if (val) { sendChatMessage(val); e.target.value = ''; }
  }
});

document.querySelectorAll('.reaction-btn').forEach(btn => {
  btn.addEventListener('click', () => sendChatMessage(btn.dataset.emoji, 'reaction'));
});

// Participants
function listenParticipants(liveId) {
  const partRef = rtRef(rtdb, `lives/${liveId}/participants`);
  onValue(partRef, (snap) => {
    let count = 0;
    const list = $('participantsList');
    if (list) list.innerHTML = '';
    snap.forEach(child => {
      count++;
      const p = child.val();
      if (list) {
        const div = document.createElement('div');
        div.className = 'participant-item';
        const initial = (p.name || '?').charAt(0).toUpperCase();
        div.innerHTML = `
          <div class="participant-avatar">${initial}</div>
          <div class="participant-info">
            <div class="participant-name">${p.name || 'Invit√©'}</div>
            <div class="participant-role">${p.role === 'host' ? 'üëë H√¥te' : p.role === 'speaker' ? 'üéôÔ∏è Speaker' : 'üëÇ Auditeur'}</div>
          </div>`;
        list.appendChild(div);
      }
    });
    const countEl = $('listenerCount');
    if (countEl) countEl.textContent = count;
  });
}

// STATS D√âTAILL√âES
async function loadStats() {
  if (!state.currentUser) return;
  try {
    const q = query(collection(db, 'lives'), where('hostId', '==', state.currentUser.uid));
    const snap = await getDocs(q);
    
    let lives = 0, minutes = 0, listeners = 0;
    let totalRevenue = 0, giftsTotal = 0;
    const giftMap = {};
    const byDay = {};
    let bestLive = { revenue: 0, title: '', date: null };
    
    snap.forEach(d => {
      const l = d.data();
      lives++;
      
      if (l.endedAt && l.createdAt) {
        minutes += Math.floor((l.endedAt.seconds - l.createdAt.seconds) / 60);
      }
      
      listeners += l.stats?.peakListeners || 0;
      
      const liveRevenue = l.stats?.hostRevenue || 0;
      totalRevenue += liveRevenue;
      
      if (liveRevenue > bestLive.revenue) {
        bestLive = {
          revenue: liveRevenue,
          title: l.title || 'Live Audio',
          date: l.createdAt
        };
      }
      
      if (l.stats?.gifts) {
        Object.entries(l.stats.gifts).forEach(([k, v]) => {
          giftMap[k] = (giftMap[k] || 0) + v;
          giftsTotal += v;
        });
      }
      
      if (l.createdAt) {
        const dt = new Date(l.createdAt.seconds * 1000);
        const day = `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')}`;
        byDay[day] = (byDay[day] || 0) + liveRevenue;
      }
    });
    
    // Stats cards
    if ($('statRevenue')) $('statRevenue').textContent = totalRevenue.toLocaleString();
    if ($('statLives')) $('statLives').textContent = lives;
    if ($('statMinutes')) $('statMinutes').textContent = minutes;
    if ($('statListeners')) $('statListeners').textContent = listeners;
    
    // Trend
    const trend = totalRevenue > 1000 ? '+üìà' : totalRevenue > 0 ? '‚úÖ' : '';
    if ($('revenueTrend')) $('revenueTrend').textContent = trend;
    
    // D√©tails revenus
    if ($('giftsCount')) $('giftsCount').textContent = `${giftsTotal} cadeau${giftsTotal > 1 ? 'x' : ''}`;
    if ($('giftsRevenue')) $('giftsRevenue').textContent = `${totalRevenue.toLocaleString()} FCFA`;
    
    // Top cadeau
    let topGift = { name: 'Aucun', value: 0 };
    Object.entries(giftMap).forEach(([k, count]) => {
      const gift = GIFTS[k];
      if (gift) {
        const val = gift.price * count;
        if (val > topGift.value) {
          topGift = { name: gift.emoji + ' ' + gift.name, value: val };
        }
      }
    });
    if ($('topGift')) $('topGift').textContent = topGift.name;
    if ($('topGiftValue')) $('topGiftValue').textContent = `${topGift.value.toLocaleString()} FCFA`;
    
    // Moyenne
    const avg = lives > 0 ? Math.round(totalRevenue / lives) : 0;
    if ($('avgRevenueLives')) $('avgRevenueLives').textContent = `${lives} live${lives > 1 ? 's' : ''}`;
    if ($('avgRevenue')) $('avgRevenue').textContent = `${avg.toLocaleString()} FCFA`;
    
    // Meilleur live
    if ($('bestLiveDate')) {
      if (bestLive.date) {
        const dt = new Date(bestLive.date.seconds * 1000);
        $('bestLiveDate').textContent = dt.toLocaleDateString('fr-FR');
      } else {
        $('bestLiveDate').textContent = 'Aucun';
      }
    }
    if ($('bestLiveRevenue')) $('bestLiveRevenue').textContent = `${bestLive.revenue.toLocaleString()} FCFA`;
    
    // Commission plateforme
    const commission = Math.round(totalRevenue * COMMISSION_RATE);
    if ($('platformCommission')) $('platformCommission').textContent = `${commission.toLocaleString()} FCFA`;
    
    // Cadeaux par type
    const giftsBreakdown = $('giftsBreakdown');
    if (giftsBreakdown) {
      giftsBreakdown.innerHTML = Object.entries(giftMap).map(([key, count]) => {
        const gift = GIFTS[key];
        if (!gift) return '';
        const value = gift.price * count;
        return `
          <div class="gift-breakdown-item">
            <span class="gift-breakdown-emoji">${gift.emoji}</span>
            <div class="gift-breakdown-info">
              <div class="gift-breakdown-name">${gift.name}</div>
              <div class="gift-breakdown-count">${count}√ó ${gift.price.toLocaleString()} FCFA</div>
            </div>
            <div class="gift-breakdown-value">${value.toLocaleString()} FCFA</div>
          </div>`;
      }).join('') || '<p style="text-align:center;color:var(--text-muted);padding:20px">Aucun cadeau re√ßu</p>';
    }
    
    // Chart revenus
    const ctx1 = $('revenueChart');
    if (ctx1) {
      if (ctx1._chart) ctx1._chart.destroy();
      const labels = Object.keys(byDay).sort().slice(-30);
      const values = labels.map(k => byDay[k]);
      ctx1._chart = new Chart(ctx1, {
        type: 'line',
        data: {
          labels: labels.map(l => l.slice(5)),
          datasets: [{
            label: 'Revenus (FCFA)',
            data: values,
            borderColor: '#667eea',
            backgroundColor: 'rgba(102,126,234,.1)',
            tension: .4,
            fill: true
          }]
        },
        options: { responsive: true, plugins: { legend: { display: false } } }
      });
    }
    
    // Chart cadeaux
    const ctx2 = $('giftsChart');
    if (ctx2 && Object.keys(giftMap).length > 0) {
      if (ctx2._chart) ctx2._chart.destroy();
      const labels = Object.keys(giftMap).map(k => GIFTS[k]?.emoji || k);
      const values = Object.values(giftMap);
      ctx2._chart = new Chart(ctx2, {
        type: 'doughnut',
        data: {
          labels,
          datasets: [{
            data: values,
            backgroundColor: ['#D4A574','#8B4513','#FFD700','#FF69B4','#667eea']
          }]
        },
        options: { responsive: true }
      });
    }
    
  } catch (err) { console.error(err); }
}

// Cadeaux
$('sendGiftBtn')?.addEventListener('click', showGiftsModal);
function showGiftsModal() {
  if (!state.currentLiveId) return;
  if (state.currentUser.isAnonymous) return showToast('‚ö†Ô∏è Cr√©e un compte pour envoyer des cadeaux');
  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.innerHTML = `
    <div class="modal-content">
      <div class="modal-header">
        <h3>üéÅ Envoyer un cadeau</h3>
        <button class="modal-close" id="closeGiftModal">√ó</button>
      </div>
      <div class="gifts-panel">
        ${Object.entries(GIFTS).map(([key, g]) => `
          <div class="gift-item" data-gift="${key}" onclick="selectGift('${key}')">
            <div class="gift-emoji">${g.emoji}</div>
            <div class="gift-name">${g.name}</div>
            <div class="gift-price">${g.price.toLocaleString()} FCFA</div>
          </div>`).join('')}
      </div>
      <div id="giftConfirmArea" class="hidden" style="margin-top:16px">
        <div style="background:var(--bg-secondary);border-radius:12px;padding:14px;margin-bottom:14px;font-size:13px">
          <div style="display:flex;justify-content:space-between;margin-bottom:6px">
            <span>Artiste re√ßoit</span><strong id="hostAmount">0 FCFA</strong>
          </div>
          <div style="display:flex;justify-content:space-between;color:var(--text-muted)">
            <span>Plateforme (10%)</span><span id="platAmount">0 FCFA</span>
          </div>
        </div>
        <label style="display:flex;align-items:center;gap:10px;font-size:14px;cursor:pointer;margin-bottom:12px;padding:10px;background:var(--bg-secondary);border-radius:8px">
          <input type="checkbox" id="giftAnonymous" style="width:18px;height:18px">
          <div>
            <div style="font-weight:600">üï∂Ô∏è Envoyer en mode anonyme</div>
            <div style="font-size:11px;color:var(--text-muted)">Ton nom ne sera pas affich√© dans le chat</div>
          </div>
        </label>
        <div class="input-group" style="margin-bottom:12px">
          <input type="tel" class="auth-input" id="giftPhone" placeholder="Num√©ro MTN : 01 96 XX XX XX" style="padding-left:16px">
        </div>
        <div id="operatorBadge" style="font-size:12px;color:var(--text-muted);margin-bottom:12px"></div>
        <button class="btn-primary" id="confirmGiftBtn">‚úÖ Payer et envoyer</button>
      </div>
    </div>`;
  document.body.appendChild(overlay);
  requestAnimationFrame(() => requestAnimationFrame(() => overlay.classList.add('active')));
  $('closeGiftModal')?.addEventListener('click', () => {
    overlay.classList.remove('active');
    setTimeout(() => overlay.remove(), 300);
  });
  $('giftPhone')?.addEventListener('input', (e) => {
    const num = e.target.value.replace(/\D/g,'');
    const badge = $('operatorBadge');
    if (!badge) return;
    const prefix = num.slice(0, 4);
    const mtn = ['0196','0197','0161','0162','0166','0167'];
    const moov = ['0190','0191','0194','0195','0198','0199'];
    if (mtn.some(p => prefix.startsWith(p.slice(0,4)))) {
      badge.innerHTML = 'üì± <strong style="color:#FFCC00">MTN Mobile Money</strong>';
    } else if (moov.some(p => prefix.startsWith(p.slice(0,4)))) {
      badge.innerHTML = 'üì± <strong style="color:#0066CC">Moov Money</strong>';
    } else {
      badge.textContent = num.length >= 4 ? '‚ùì Op√©rateur non reconnu' : '';
    }
  });
}

let selectedGift = null;
window.selectGift = function(key) {
  selectedGift = key;
  document.querySelectorAll('.gift-item').forEach(el => el.classList.toggle('selected', el.dataset.gift === key));
  const g = GIFTS[key];
  const host = Math.round(g.price * 0.9);
  const platform = g.price - host;
  $('hostAmount').textContent = host.toLocaleString() + ' FCFA';
  $('platAmount').textContent = platform.toLocaleString() + ' FCFA';
  $('giftConfirmArea')?.classList.remove('hidden');
  $('confirmGiftBtn')?.onclick = async () => {
    const phone = $('giftPhone')?.value.replace(/\s/g,'');
    if (!phone || phone.length < 8) return showToast('‚ö†Ô∏è Entre ton num√©ro MTN');
    const isAnonymous = $('giftAnonymous')?.checked || false;
    await processGiftPayment(key, phone, isAnonymous);
    document.querySelector('.modal-overlay')?.classList.remove('active');
    setTimeout(() => document.querySelector('.modal-overlay')?.remove(), 300);
  };
};

async function processGiftPayment(giftKey, phone, isAnonymous) {
  const gift = GIFTS[giftKey];
  const hostAmt = Math.round(gift.price * (1 - COMMISSION_RATE));
  const platAmt = gift.price - hostAmt;
  showLoading(`Paiement ${gift.emoji} ${gift.name}...`);
  try {
    await addDoc(collection(db, 'transactions'), {
      liveId: state.currentLiveId,
      senderId: state.currentUser.uid,
      senderName: state.currentUser.displayName,
      isAnonymous: isAnonymous,
      recipientId: null,
      giftType: giftKey,
      giftEmoji: gift.emoji,
      totalAmount: gift.price,
      hostAmount: hostAmt,
      platformCommission: platAmt,
      payerPhone: phone,
      status: 'pending',
      createdAt: Timestamp.now()
    });
    const walletRef = doc(db, 'platform', 'PLATFORM_WALLET');
    try {
      await updateDoc(walletRef, {
        totalCommissions: increment(platAmt),
        [`commissions.${giftKey}`]: increment(platAmt),
        withdrawalPhone: PLATFORM_PHONE,
        lastUpdated: Timestamp.now()
      });
    } catch {
      await setDoc(walletRef, {
        totalCommissions: platAmt,
        commissions: { [giftKey]: platAmt },
        withdrawalPhone: PLATFORM_PHONE,
        lastUpdated: Timestamp.now()
      });
    }
    hideLoading();
    launchGiftAnimation(gift.emoji);
    const senderName = isAnonymous ? 'Anonyme' : state.currentUser.displayName;
    await sendChatMessage(`Un cadeau vient d'√™tre envoy√© par ${senderName}`, 'gift');
    showToast(`${gift.emoji} ${gift.name} envoy√© ! Merci üí∞`);
  } catch (err) {
    hideLoading();
    showToast('‚ùå Erreur paiement');
    console.error(err);
  }
}

function launchGiftAnimation(emoji) {
  const container = $('giftsAnimationContainer');
  if (!container) return;
  for (let i = 0; i < 5; i++) {
    setTimeout(() => {
      const el = document.createElement('div');
      el.className = 'gift-anim';
      el.textContent = emoji;
      el.style.left = Math.random() * 80 + 10 + '%';
      el.style.bottom = '60px';
      container.appendChild(el);
      setTimeout(() => el.remove(), 2600);
    }, i * 200);
  }
}

// Partage
$('shareLiveBtn')?.addEventListener('click', () => {
  if (!state.currentLiveId) return;
  showShareModal(state.currentLiveId, $('liveTitle')?.textContent || 'Live');
});

function showShareModal(liveId, title) {
  const url = `${window.location.origin}${window.location.pathname}?live=${liveId}`;
  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.innerHTML = `
    <div class="modal-content">
      <div class="modal-header">
        <h3>üîó Partager ce live</h3>
        <button class="modal-close" id="closeShareModal">√ó</button>
      </div>
      <p style="font-size:14px;font-weight:600;text-align:center;margin-bottom:16px">${title}</p>
      <div class="share-link-box">
        <input type="text" value="${url}" readonly id="shareLinkInput">
        <button class="btn-copy" id="copyLinkBtn">Copier</button>
      </div>
      <div class="share-grid">
        <button class="share-btn whatsapp" onclick="shareTo('whatsapp','${url}','${title}')">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884"/></svg>
          WhatsApp
        </button>
        <button class="share-btn telegram" onclick="shareTo('telegram','${url}','${title}')">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg>
          Telegram
        </button>
        <button class="share-btn facebook" onclick="shareTo('facebook','${url}','${title}')">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
          Facebook
        </button>
        <button class="share-btn twitter" onclick="shareTo('twitter','${url}','${title}')">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/></svg>
          Twitter
        </button>
      </div>
    </div>`;
  document.body.appendChild(overlay);
  requestAnimationFrame(() => requestAnimationFrame(() => overlay.classList.add('active')));
  $('closeShareModal')?.addEventListener('click', () => {
    overlay.classList.remove('active');
    setTimeout(() => overlay.remove(), 300);
  });
  $('copyLinkBtn')?.addEventListener('click', () => {
    navigator.clipboard.writeText(url);
    showToast('‚úÖ Lien copi√© !');
  });
}

window.shareTo = function(platform, url, title) {
  const text = `Rejoins-moi sur SIS Live Audio : ${title}`;
  const urls = {
    whatsapp: `https://wa.me/?text=${encodeURIComponent(text+' '+url)}`,
    telegram: `https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent(text)}`,
    facebook: `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`,
    twitter: `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`
  };
  window.open(urls[platform], '_blank', 'width=600,height=400');
};

// Init
window.addEventListener('DOMContentLoaded', () => {
  console.log('üöÄ SIS Live Audio v2.0 loaded');
  const params = new URLSearchParams(window.location.search);
  const liveId = params.get('live');
  if (liveId && state.currentUser) {
    setTimeout(() => window.joinLive(liveId), 1000);
  }
});

console.log('‚úÖ SIS Live Audio script charg√©');
</script>
</body>
</html>
