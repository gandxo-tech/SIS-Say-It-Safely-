<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIS Live Audio - Webinaires & Conf√©rences</title>
    <link rel="icon" href="https://i.ibb.co/tGCTMvk/logo.png">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
</head>
<body>

<!-- AUTH SECTION -->
<div class="section active" id="authSection">
    <div class="auth-container">
        <img src="https://i.ibb.co/tGCTMvk/logo.png" class="auth-logo" alt="SIS">
        <h1 class="auth-title"><span class="gradient-text">SIS Live Audio</span></h1>
        <p class="auth-subtitle">Webinaires & Conf√©rences en direct</p>
        
        <div class="auth-tabs">
            <button class="auth-tab active" id="loginTab">Connexion</button>
            <button class="auth-tab" id="registerTab">Inscription</button>
        </div>
        
        <form class="auth-form" id="loginForm">
            <input type="email" class="auth-input" placeholder="Email" required>
            <input type="password" class="auth-input" placeholder="Mot de passe" required>
            <button type="submit" class="btn-auth">Se connecter</button>
        </form>
        
        <form class="auth-form hidden" id="registerForm">
            <input type="text" class="auth-input" id="registerName" placeholder="Nom complet" required>
            <input type="email" class="auth-input" placeholder="Email" required>
            <input type="password" class="auth-input" placeholder="Mot de passe (6+ car.)" required>
            <button type="submit" class="btn-auth">S'inscrire</button>
        </form>
        
        <div class="error-msg hidden" id="authError"></div>
    </div>
</div>

<!-- EXPLORE SECTION -->
<div class="section" id="exploreSection">
    <header class="app-header">
        <div class="header-left">
            <img src="https://i.ibb.co/tGCTMvk/logo.png" class="header-logo" alt="SIS">
            <h1 class="header-title">Live Audio</h1>
        </div>
        <div class="header-right">
            <button class="header-btn" id="refreshBtn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M1 4v6h6M23 20v-6h-6"/>
                    <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/>
                </svg>
            </button>
            <button class="header-btn" id="logoutBtn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9"/>
                </svg>
            </button>
        </div>
    </header>
    
    <div class="container">
        <div class="section-header">
            <h2 class="section-title">üî¥ Lives en Direct</h2>
            <span class="badge-count" id="liveCount">0</span>
        </div>
        <div class="lives-grid" id="liveLivesGrid">
            <div class="empty-state">
                <div class="empty-icon">üéôÔ∏è</div>
                <p>Aucun live en cours</p>
            </div>
        </div>
        
        <div class="section-header">
            <h2 class="section-title">üìÖ Lives Programm√©s</h2>
            <span class="badge-count" id="scheduledCount">0</span>
        </div>
        <div class="lives-grid" id="scheduledLivesGrid">
            <div class="empty-state">
                <div class="empty-icon">üìÖ</div>
                <p>Aucun live programm√©</p>
            </div>
        </div>
    </div>
    
    <button class="fab" id="createLiveBtn">+</button>
</div>

<!-- CREATE WIZARD -->
<div class="section" id="createSection">
    <div class="wizard-container">
        <div class="wizard-header">
            <button class="back-btn" id="wizardBackBtn">‚Üê</button>
            <h1 class="wizard-title">Cr√©er un Live</h1>
        </div>
        
        <div class="wizard-progress">
            <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
            <div class="progress-steps">
                <div class="progress-step active">1</div>
                <div class="progress-step">2</div>
                <div class="progress-step">3</div>
                <div class="progress-step">4</div>
            </div>
        </div>
        
        <!-- Step 1 -->
        <div class="wizard-step active" id="step1">
            <h2 class="step-title">Informations</h2>
            <input type="text" class="form-input" id="liveTitle" placeholder="Titre *" maxlength="100">
            <textarea class="form-textarea" id="liveDesc" placeholder="Description" maxlength="500"></textarea>
            <select class="form-select" id="liveCategory">
                <option value="tech">üíª Technologie</option>
                <option value="education">üìö √âducation</option>
                <option value="music">üéµ Musique</option>
                <option value="discussion">üí¨ Discussion</option>
                <option value="qa">‚ùì Q&A</option>
            </select>
            <button class="btn-next" onclick="validateStep1()">Suivant ‚Üí</button>
        </div>
        
        <!-- Step 2 -->
        <div class="wizard-step" id="step2">
            <h2 class="step-title">Planification</h2>
            <div class="timing-options">
                <div class="timing-card selected" id="timingNow">
                    <div class="timing-icon">üî¥</div>
                    <h3>Maintenant</h3>
                </div>
                <div class="timing-card" id="timingLater">
                    <div class="timing-icon">üìÖ</div>
                    <h3>Programmer</h3>
                </div>
            </div>
            <div id="scheduleInputs" class="hidden">
                <input type="datetime-local" class="form-input" id="scheduleTime">
            </div>
            <div class="wizard-actions">
                <button class="btn-back" onclick="goToStep(1)">‚Üê Retour</button>
                <button class="btn-next" onclick="goToStep(3)">Suivant ‚Üí</button>
            </div>
        </div>
        
        <!-- Step 3 -->
        <div class="wizard-step" id="step3">
            <h2 class="step-title">Confidentialit√©</h2>
            <div class="privacy-options">
                <div class="privacy-card selected" id="privacyPublic">
                    <div class="privacy-icon">üåç</div>
                    <h3>Public</h3>
                </div>
                <div class="privacy-card" id="privacyPrivate">
                    <div class="privacy-icon">üîí</div>
                    <h3>Priv√©</h3>
                </div>
            </div>
            <div id="codeSection" class="hidden">
                <div class="code-display">
                    <div class="code-value" id="accessCode"></div>
                    <button class="btn-copy" onclick="copyCode()">üìã Copier</button>
                </div>
            </div>
            <div id="calendarSection" class="hidden" style="text-align:center;margin:20px 0;">
                <button class="btn-calendar" onclick="downloadCalendar()">üìÖ Ajouter au calendrier</button>
                <p style="font-size:12px;color:var(--text-secondary);margin-top:8px;">Rappels : 15 min et 1h avant</p>
            </div>
            <div class="wizard-actions">
                <button class="btn-back" onclick="goToStep(2)">‚Üê Retour</button>
                <button class="btn-next" onclick="goToStep(4)">Suivant ‚Üí</button>
            </div>
        </div>
        
        <!-- Step 4 -->
        <div class="wizard-step" id="step4">
            <h2 class="step-title">Confirmation</h2>
            <div class="summary-card">
                <h3 id="summaryTitle">Titre</h3>
                <p id="summaryDesc">Description</p>
                <div id="summaryDetails"></div>
            </div>
            <div class="wizard-actions">
                <button class="btn-back" onclick="goToStep(3)">‚Üê Modifier</button>
                <button class="btn-create" onclick="createLive()">üöÄ Cr√©er</button>
            </div>
        </div>
    </div>
</div>

<!-- LIVE ROOM -->
<div class="section" id="liveRoomSection">
    <div class="live-header">
        <button class="live-back-btn" onclick="leaveLive()">‚Üê</button>
        <div class="live-header-center">
            <h2 id="liveRoomTitle">Titre</h2>
            <span class="badge-live"><span class="dot"></span>EN DIRECT</span>
        </div>
        <button class="live-menu-btn" onclick="openMenu()">‚ãÆ</button>
    </div>
    
    <div class="stage" id="stage"></div>
    
    <div class="live-stats">
        <div class="stat-item">üë• <span id="listenerCount">0</span></div>
        <div class="stat-item">‚è±Ô∏è <span id="liveTimer">00:00:00</span></div>
    </div>
    
    <div class="live-bottom">
        <div class="live-tabs">
            <button class="live-tab active" onclick="switchTab('chat')">üí¨ Chat</button>
            <button class="live-tab" onclick="switchTab('participants')">üë• Participants</button>
        </div>
        
        <div class="tab-content">
            <div class="tab-pane active" id="chatPane">
                <div class="chat-messages" id="chatMessages"></div>
                <div class="chat-reactions">
                    <button onclick="sendReaction('üëè')">üëè</button>
                    <button onclick="sendReaction('‚ù§Ô∏è')">‚ù§Ô∏è</button>
                    <button onclick="sendReaction('üî•')">üî•</button>
                    <button onclick="sendReaction('üòÇ')">üòÇ</button>
                </div>
                <div class="chat-input-row">
                    <input type="text" id="chatInput" placeholder="Message..." maxlength="280">
                    <button onclick="sendMessage()">‚û§</button>
                </div>
            </div>
            
            <div class="tab-pane" id="participantsPane">
                <div id="participantsList"></div>
            </div>
        </div>
    </div>
    
    <button class="btn-raise-hand" id="raiseHandBtn" onclick="raiseHand()">‚úã Lever la main</button>
</div>

<!-- CODE MODAL -->
<div class="modal" id="codeModal">
    <div class="modal-backdrop" onclick="closeCodeModal()"></div>
    <div class="modal-content">
        <h3>üîí Live Priv√©</h3>
        <p>Ce live n√©cessite un code d'acc√®s</p>
        <div class="code-inputs">
            <input type="text" class="code-input" id="code1" maxlength="1">
            <input type="text" class="code-input" id="code2" maxlength="1">
            <input type="text" class="code-input" id="code3" maxlength="1">
            <input type="text" class="code-input" id="code4" maxlength="1">
            <input type="text" class="code-input" id="code5" maxlength="1">
            <input type="text" class="code-input" id="code6" maxlength="1">
        </div>
        <div class="code-error hidden" id="codeError"></div>
        <div class="modal-actions">
            <button class="btn-secondary" onclick="closeCodeModal()">Annuler</button>
            <button class="btn-primary" onclick="submitCode()">Rejoindre</button>
        </div>
    </div>
</div>

<div id="toast"></div>
<div id="reactionsContainer"></div>

<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

:root {
    --primary: #667eea;
    --secondary: #764ba2;
    --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --bg-dark: #0f0f1e;
    --bg-surface: #1a1a2e;
    --bg-card: #252541;
    --text: #ffffff;
    --text-dim: #a0a0b8;
    --success: #10b981;
    --error: #ef4444;
    --warning: #f59e0b;
    --live-red: #ff3b30;
    --border: rgba(255, 255, 255, 0.1);
    --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    --radius: 16px;
}

body {
    font-family: 'Inter', sans-serif;
    background: var(--bg-dark);
    color: var(--text);
    min-height: 100vh;
}

h1, h2, h3 { font-family: 'Poppins', sans-serif; }
button { font-family: inherit; cursor: pointer; border: none; }
input, textarea, select { font-family: inherit; outline: none; }

.section { display: none; min-height: 100vh; }
.section.active { display: block; }
.hidden { display: none !important; }

/* AUTH */
.auth-container {
    max-width: 420px;
    margin: 80px auto;
    padding: 40px;
    background: var(--bg-surface);
    border-radius: 20px;
    box-shadow: var(--shadow);
}

.auth-logo { width: 80px; display: block; margin: 0 auto 24px; }
.auth-title { text-align: center; font-size: 32px; margin-bottom: 8px; }
.gradient-text {
    background: var(--gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}
.auth-subtitle { text-align: center; color: var(--text-dim); margin-bottom: 32px; }

.auth-tabs { display: flex; gap: 8px; margin-bottom: 24px; }
.auth-tab {
    flex: 1;
    padding: 12px;
    background: transparent;
    border: 2px solid var(--border);
    border-radius: 12px;
    color: var(--text-dim);
    font-weight: 600;
}
.auth-tab.active { background: var(--gradient); color: white; border-color: transparent; }

.auth-form { display: flex; flex-direction: column; gap: 12px; }
.auth-input {
    padding: 16px;
    background: var(--bg-card);
    border: 2px solid var(--border);
    border-radius: 12px;
    color: var(--text);
    font-size: 16px;
}
.auth-input:focus { border-color: var(--primary); }

.btn-auth {
    padding: 16px;
    background: var(--gradient);
    color: white;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    margin-top: 8px;
}

.error-msg {
    margin-top: 16px;
    padding: 12px;
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid var(--error);
    border-radius: 8px;
    color: var(--error);
    font-size: 14px;
    text-align: center;
}

/* HEADER */
.app-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    background: var(--bg-surface);
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    z-index: 100;
}

.header-left { display: flex; align-items: center; gap: 12px; }
.header-logo { width: 32px; height: 32px; }
.header-title { font-size: 20px; font-weight: 700; }
.header-right { display: flex; gap: 8px; }

.header-btn {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text);
    display: flex;
    align-items: center;
    justify-content: center;
}

/* CONTAINER */
.container { padding: 20px; max-width: 1200px; margin: 0 auto; }

.section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin: 24px 0 16px;
}

.section-title { font-size: 20px; font-weight: 700; }
.badge-count {
    background: var(--bg-card);
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 14px;
    font-weight: 600;
}

.lives-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 20px;
    margin-bottom: 40px;
}

.live-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    cursor: pointer;
    transition: all 0.3s;
}

.live-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow);
    border-color: var(--primary);
}

.card-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 16px;
}

.card-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    object-fit: cover;
}

.card-info { flex: 1; }
.card-host { font-weight: 600; font-size: 14px; }
.card-category { font-size: 12px; color: var(--text-dim); }
.card-title { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
.card-desc {
    font-size: 14px;
    color: var(--text-dim);
    margin-bottom: 16px;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.card-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.card-stats { display: flex; gap: 12px; font-size: 14px; color: var(--text-dim); }

.badge-live {
    background: var(--live-red);
    color: white;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 6px;
}

.dot {
    width: 6px;
    height: 6px;
    background: white;
    border-radius: 50%;
    animation: blink 1.5s infinite;
}

@keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

.badge-scheduled {
    background: var(--bg-surface);
    color: var(--text);
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
}

.badge-private {
    background: var(--warning);
    color: white;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
}

.empty-state {
    grid-column: 1 / -1;
    text-align: center;
    padding: 60px 20px;
    color: var(--text-dim);
}

.empty-icon { font-size: 64px; margin-bottom: 16px; }

.fab {
    position: fixed;
    bottom: 24px;
    right: 24px;
    width: 64px;
    height: 64px;
    border-radius: 50%;
    background: var(--gradient);
    color: white;
    font-size: 32px;
    box-shadow: 0 8px 24px rgba(102, 126, 234, 0.6);
    z-index: 999;
}

/* WIZARD */
.wizard-container { max-width: 600px; margin: 0 auto; padding: 20px; }
.wizard-header { display: flex; align-items: center; gap: 16px; margin-bottom: 24px; }
.back-btn {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text);
    font-size: 24px;
}
.wizard-title { font-size: 24px; font-weight: 700; }

.wizard-progress { margin-bottom: 32px; }
.progress-bar {
    height: 4px;
    background: var(--bg-card);
    border-radius: 2px;
    margin-bottom: 16px;
}
.progress-fill {
    height: 100%;
    background: var(--gradient);
    transition: width 0.4s;
    width: 25%;
}

.progress-steps { display: flex; justify-content: space-between; }
.progress-step {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--bg-card);
    color: var(--text-dim);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
}
.progress-step.active { background: var(--gradient); color: white; }

.wizard-step { display: none; }
.wizard-step.active { display: block; }

.step-title { font-size: 28px; font-weight: 700; margin-bottom: 24px; }

.form-input, .form-textarea, .form-select {
    width: 100%;
    padding: 16px;
    background: var(--bg-card);
    border: 2px solid var(--border);
    border-radius: 12px;
    color: var(--text);
    font-size: 16px;
    margin-bottom: 16px;
}
.form-input:focus, .form-textarea:focus, .form-select:focus { border-color: var(--primary); }
.form-textarea { resize: vertical; min-height: 100px; }

.timing-options, .privacy-options {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
    margin-bottom: 24px;
}

.timing-card, .privacy-card {
    padding: 24px;
    background: var(--bg-card);
    border: 2px solid var(--border);
    border-radius: var(--radius);
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
}

.timing-card:hover, .privacy-card:hover { border-color: var(--primary); }
.timing-card.selected, .privacy-card.selected {
    border-color: var(--primary);
    background: rgba(102, 126, 234, 0.1);
}

.timing-icon, .privacy-icon { font-size: 48px; margin-bottom: 12px; }

.code-display {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 24px;
    text-align: center;
    margin-bottom: 24px;
}

.code-value {
    font-size: 48px;
    font-weight: 700;
    font-family: 'Courier New', monospace;
    color: var(--primary);
    letter-spacing: 8px;
    margin-bottom: 16px;
}

.btn-copy, .btn-calendar {
    padding: 12px 24px;
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-size: 14px;
}

.wizard-actions {
    display: flex;
    gap: 12px;
    margin-top: 32px;
}

.btn-next, .btn-back, .btn-create {
    flex: 1;
    padding: 16px;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
}

.btn-next, .btn-create { background: var(--gradient); color: white; }
.btn-back { background: var(--bg-card); border: 1px solid var(--border); color: var(--text); }

.summary-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 24px;
    margin-bottom: 24px;
}

/* LIVE ROOM */
.live-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    background: var(--bg-surface);
    border-bottom: 1px solid var(--border);
}

.live-back-btn, .live-menu-btn {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text);
    font-size: 24px;
}

.live-header-center {
    flex: 1;
    text-align: center;
}

.stage {
    padding: 40px 20px;
    min-height: 40vh;
    display: flex;
    flex-wrap: wrap;
    gap: 24px;
    align-items: center;
    justify-content: center;
}

.speaker {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
}

.speaker-avatar {
    position: relative;
    width: 100px;
    height: 100px;
    border-radius: 50%;
}

.speaker-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border: 3px solid var(--border);
    border-radius: 50%;
}

.speaker-avatar.speaking img { border-color: var(--primary); }

.speaker-avatar.speaking::before,
.speaker-avatar.speaking::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    border: 3px solid var(--primary);
    border-radius: 50%;
}

.speaker-avatar.speaking::before { animation: wave 1.5s infinite; }
.speaker-avatar.speaking::after { animation: wave 1.5s infinite 0.75s; }

@keyframes wave {
    0% { width: 100%; height: 100%; opacity: 1; }
    100% { width: 180%; height: 180%; opacity: 0; }
}

.speaker-name { font-size: 13px; font-weight: 500; }
.speaker-role { font-size: 11px; color: var(--text-dim); }

.live-stats {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 24px;
    padding: 16px;
    background: var(--bg-card);
    margin: 0 20px;
    border-radius: 24px;
}

.stat-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 16px;
    font-weight: 600;
}

.live-bottom {
    background: var(--bg-surface);
    border-top: 1px solid var(--border);
    height: 400px;
    display: flex;
    flex-direction: column;
}

.live-tabs {
    display: flex;
    border-bottom: 1px solid var(--border);
}

.live-tab {
    flex: 1;
    padding: 16px;
    background: transparent;
    color: var(--text-dim);
    font-size: 14px;
    border-bottom: 2px solid transparent;
}

.live-tab.active {
    color: var(--primary);
    border-bottom-color: var(--primary);
}

.tab-content { flex: 1; overflow: hidden; }
.tab-pane { display: none; height: 100%; flex-direction: column; }
.tab-pane.active { display: flex; }

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
}

.chat-message {
    display: flex;
    gap: 12px;
    margin-bottom: 16px;
}

.message-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    object-fit: cover;
}

.message-content { flex: 1; }
.message-header {
    display: flex;
    gap: 8px;
    margin-bottom: 4px;
}
.message-author { font-size: 14px; font-weight: 600; }
.message-time { font-size: 11px; color: var(--text-dim); }
.message-text { font-size: 14px; }

.chat-reactions {
    display: flex;
    gap: 8px;
    padding: 12px 16px;
    border-top: 1px solid var(--border);
}

.chat-reactions button {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: transparent;
    border: 1px solid var(--border);
    font-size: 20px;
}

.chat-input-row {
    display: flex;
    gap: 8px;
    padding: 12px 16px;
    border-top: 1px solid var(--border);
}

#chatInput {
    flex: 1;
    padding: 10px 16px;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 20px;
    color: var(--text);
}

.chat-input-row button {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: var(--gradient);
    color: white;
}

.btn-raise-hand {
    position: fixed;
    bottom: 24px;
    left: 50%;
    transform: translateX(-50%);
    padding: 16px 32px;
    background: var(--gradient);
    color: white;
    border-radius: 24px;
    font-size: 16px;
    font-weight: 600;
    z-index: 998;
}

/* MODAL */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 10000;
    align-items: center;
    justify-content: center;
}

.modal.active { display: flex; }

.modal-backdrop {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
}

.modal-content {
    position: relative;
    max-width: 400px;
    width: 90%;
    background: var(--bg-surface);
    border-radius: var(--radius);
    padding: 24px;
}

.modal-content h3 {
    font-size: 20px;
    margin-bottom: 16px;
    text-align: center;
}

.modal-content p {
    text-align: center;
    color: var(--text-dim);
    margin-bottom: 24px;
}

.code-inputs {
    display: flex;
    gap: 8px;
    justify-content: center;
    margin-bottom: 16px;
}

.code-input {
    width: 50px;
    height: 60px;
    text-align: center;
    font-size: 24px;
    font-weight: 700;
    font-family: 'Courier New', monospace;
    background: var(--bg-card);
    border: 2px solid var(--border);
    border-radius: 12px;
    color: var(--text);
    text-transform: uppercase;
}

.code-input:focus { border-color: var(--primary); }

.code-error {
    text-align: center;
    color: var(--error);
    font-size: 14px;
    margin-bottom: 16px;
}

.modal-actions {
    display: flex;
    gap: 12px;
}

.btn-primary, .btn-secondary {
    flex: 1;
    padding: 14px;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
}

.btn-primary { background: var(--gradient); color: white; }
.btn-secondary { background: var(--bg-card); border: 1px solid var(--border); color: var(--text); }

/* TOAST */
#toast {
    position: fixed;
    bottom: 100px;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    background: var(--bg-card);
    color: var(--text);
    padding: 16px 32px;
    border-radius: 12px;
    box-shadow: var(--shadow);
    opacity: 0;
    transition: all 0.3s;
    z-index: 10001;
    border: 1px solid var(--border);
}

#toast.show {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
}

/* REACTIONS */
#reactionsContainer {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    height: 100vh;
    pointer-events: none;
    z-index: 9998;
}

.floating-reaction {
    position: absolute;
    font-size: 48px;
    animation: floatUp 3s ease-out forwards;
}

@keyframes floatUp {
    0% { bottom: 150px; opacity: 1; }
    100% { bottom: calc(100vh - 100px); opacity: 0; }
}

/* RESPONSIVE */
@media (max-width: 768px) {
    .auth-container { margin: 40px 20px; }
    .lives-grid { grid-template-columns: 1fr; }
    .timing-options, .privacy-options { grid-template-columns: 1fr; }
    .code-input { width: 42px; height: 52px; }
}
</style>

<script type="module">
// FIREBASE IMPORTS
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
import { 
    getAuth, 
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    onAuthStateChanged,
    signOut,
    updateProfile
} from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
import { 
    getFirestore,
    collection,
    doc,
    setDoc,
    getDoc,
    getDocs,
    query,
    where,
    orderBy,
    onSnapshot,
    Timestamp,
    updateDoc,
    deleteDoc
} from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';
import {
    getDatabase,
    ref as dbRef,
    set as dbSet,
    get as dbGet,
    update as dbUpdate,
    remove as dbRemove,
    push as dbPush,
    onValue,
    onChildAdded,
    onChildRemoved
} from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';

// FIREBASE CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyBqk3L_qkolD41H3yvHEzz4O-Sr15I-Tko",
      authDomain: "gandxoanonymous.firebaseapp.com",
      projectId: "gandxoanonymous",
      storageBucket: "gandxoanonymous.appspot.com",
      messagingSenderId: "836606625364",
      appId: "1:836606625364:web:7150571998131c41c0cfc1",
      measurementId: "G-97TCHJ33KW",
      databaseURL: "https://gandxoanonymous-default-rtdb.firebaseio.com"
    };

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const rtdb = getDatabase(app);

// GLOBAL STATE
let currentUser = null;
let currentLiveId = null;
let currentRole = 'listener';
let liveTimer = null;
let liveStartTime = null;
let pendingLiveId = null;

const wizardData = {
    title: '',
    description: '',
    category: 'tech',
    timing: 'now',
    scheduledTime: null,
    duration: 3600,
    isPublic: true,
    accessCode: '',
    settings: {
        chatEnabled: true,
        qaMode: false,
        allowHandRaise: true,
        showListenerCount: true
    }
};

let currentStep = 1;

// UTILITY FUNCTIONS
function showToast(msg) {
    const toast = document.getElementById('toast');
    toast.textContent = msg;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 3000);
}

function showError(msg) {
    const error = document.getElementById('authError');
    error.textContent = msg;
    error.classList.remove('hidden');
    setTimeout(() => error.classList.add('hidden'), 5000);
}

function showSection(id) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
}

function generateCode() {
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    let code = '';
    for (let i = 0; i < 6; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return code;
}

// AUTH TABS
document.getElementById('loginTab').onclick = () => {
    document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
    document.getElementById('loginTab').classList.add('active');
    document.getElementById('loginForm').classList.remove('hidden');
    document.getElementById('registerForm').classList.add('hidden');
};

document.getElementById('registerTab').onclick = () => {
    document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
    document.getElementById('registerTab').classList.add('active');
    document.getElementById('loginForm').classList.add('hidden');
    document.getElementById('registerForm').classList.remove('hidden');
};

// REGISTER
document.getElementById('registerForm').onsubmit = async (e) => {
    e.preventDefault();
    const form = e.target;
    const name = form[0].value.trim();
    const email = form[1].value.trim();
    const password = form[2].value;
    
    if (password.length < 6) {
        showError('Le mot de passe doit faire au moins 6 caract√®res');
        return;
    }
    
    try {
        const cred = await createUserWithEmailAndPassword(auth, email, password);
        await updateProfile(cred.user, { displayName: name });
        
        const photoURL = `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=667eea&color=fff&size=200`;
        
        await setDoc(doc(db, 'users', cred.user.uid), {
            uid: cred.user.uid,
            displayName: name,
            email: email,
            photoURL: photoURL,
            createdAt: Timestamp.now()
        });
        
        showToast('‚úÖ Compte cr√©√© avec succ√®s !');
    } catch (error) {
        console.error(error);
        let msg = 'Erreur lors de l\'inscription';
        if (error.code === 'auth/email-already-in-use') msg = 'Email d√©j√† utilis√©';
        if (error.code === 'auth/invalid-email') msg = 'Email invalide';
        showError(msg);
    }
};

// LOGIN
document.getElementById('loginForm').onsubmit = async (e) => {
    e.preventDefault();
    const form = e.target;
    const email = form[0].value.trim();
    const password = form[1].value;
    
    try {
        await signInWithEmailAndPassword(auth, email, password);
        showToast('‚úÖ Connexion r√©ussie !');
    } catch (error) {
        console.error(error);
        let msg = 'Email ou mot de passe incorrect';
        if (error.code === 'auth/user-not-found') msg = 'Compte inexistant';
        if (error.code === 'auth/wrong-password') msg = 'Mot de passe incorrect';
        showError(msg);
    }
};

// LOGOUT
document.getElementById('logoutBtn').onclick = async () => {
    if (confirm('Se d√©connecter ?')) {
        await signOut(auth);
        showToast('üëã D√©connect√©');
    }
};

// REFRESH
document.getElementById('refreshBtn').onclick = () => {
    loadLives();
    showToast('üîÑ Actualisation...');
};

// AUTH STATE
onAuthStateChanged(auth, async (user) => {
    if (user) {
        currentUser = user;
        
        const userDoc = await getDoc(doc(db, 'users', user.uid));
        if (!userDoc.exists()) {
            const name = user.displayName || user.email.split('@')[0];
            await setDoc(doc(db, 'users', user.uid), {
                uid: user.uid,
                displayName: name,
                email: user.email,
                photoURL: user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=667eea&color=fff`,
                createdAt: Timestamp.now()
            });
        }
        
        showSection('exploreSection');
        loadLives();
        
        console.log('‚úÖ User logged in:', user.email);
    } else {
        currentUser = null;
        showSection('authSection');
    }
});

// LOAD LIVES
async function loadLives() {
    // Lives en cours
    const liveQuery = query(
        collection(db, 'lives'),
        where('status', '==', 'live'),
        orderBy('startedAt', 'desc')
    );
    
    onSnapshot(liveQuery, (snapshot) => {
        const grid = document.getElementById('liveLivesGrid');
        grid.innerHTML = '';
        
        document.getElementById('liveCount').textContent = snapshot.size;
        
        if (snapshot.empty) {
            grid.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">üéôÔ∏è</div>
                    <p>Aucun live en cours</p>
                </div>
            `;
        } else {
            snapshot.forEach(doc => {
                const live = doc.data();
                grid.appendChild(createLiveCard(doc.id, live, true));
            });
        }
    });
    
    // Lives programm√©s
    const scheduledQuery = query(
        collection(db, 'lives'),
        where('status', '==', 'scheduled'),
        orderBy('scheduledAt', 'asc')
    );
    
    onSnapshot(scheduledQuery, (snapshot) => {
        const grid = document.getElementById('scheduledLivesGrid');
        grid.innerHTML = '';
        
        document.getElementById('scheduledCount').textContent = snapshot.size;
        
        if (snapshot.empty) {
            grid.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">üìÖ</div>
                    <p>Aucun live programm√©</p>
                </div>
            `;
        } else {
            snapshot.forEach(doc => {
                const live = doc.data();
                grid.appendChild(createLiveCard(doc.id, live, false));
            });
        }
    });
}

function createLiveCard(id, live, isLive) {
    const card = document.createElement('div');
    card.className = 'live-card';
    card.onclick = () => handleJoinLive(id, live);
    
    const listeners = live.stats?.currentListeners || 0;
    
    const scheduledDate = live.scheduledAt ? 
        new Date(live.scheduledAt.seconds * 1000).toLocaleDateString('fr-FR', {
            day: 'numeric',
            month: 'short',
            hour: '2-digit',
            minute: '2-digit'
        }) : '';
    
    card.innerHTML = `
        <div class="card-header">
            <img src="${live.hostPhoto}" class="card-avatar" alt="${live.hostName}">
            <div class="card-info">
                <div class="card-host">${live.hostName}</div>
                <div class="card-category">${live.category}</div>
            </div>
        </div>
        <h3 class="card-title">${live.title}</h3>
        <p class="card-desc">${live.description || 'Aucune description'}</p>
        <div class="card-footer">
            <div class="card-stats">
                ${isLive ? `üë• ${listeners}` : ''}
            </div>
            <div style="display:flex;gap:8px;align-items:center;">
                ${isLive ? 
                    '<span class="badge-live"><span class="dot"></span>EN DIRECT</span>' :
                    `<span class="badge-scheduled">üìÖ ${scheduledDate}</span>`
                }
                ${!live.isPublic ? '<span class="badge-private">üîí</span>' : ''}
            </div>
        </div>
    `;
    
    return card;
}

function handleJoinLive(id, live) {
    if (!live.isPublic) {
        showCodeModal(id);
    } else {
        joinLive(id);
    }
}

// CODE MODAL
function showCodeModal(liveId) {
    pendingLiveId = liveId;
    document.getElementById('codeModal').classList.add('active');
    document.getElementById('code1').focus();
}

window.closeCodeModal = function() {
    document.getElementById('codeModal').classList.remove('active');
    document.getElementById('codeError').classList.add('hidden');
    for (let i = 1; i <= 6; i++) {
        document.getElementById(`code${i}`).value = '';
    }
    pendingLiveId = null;
};

window.submitCode = async function() {
    const code = Array.from({length: 6}, (_, i) => 
        document.getElementById(`code${i+1}`).value
    ).join('').toUpperCase();
    
    if (code.length !== 6) {
        document.getElementById('codeError').textContent = '‚ùå Code incomplet';
        document.getElementById('codeError').classList.remove('hidden');
        return;
    }
    
    try {
        const liveDoc = await getDoc(doc(db, 'lives', pendingLiveId));
        
        if (liveDoc.exists()) {
            const live = liveDoc.data();
            if (live.accessCode === code) {
                closeCodeModal();
                joinLive(pendingLiveId);
            } else {
                document.getElementById('codeError').textContent = '‚ùå Code invalide';
                document.getElementById('codeError').classList.remove('hidden');
            }
        }
    } catch (error) {
        console.error('Error verifying code:', error);
        document.getElementById('codeError').textContent = '‚ùå Erreur de v√©rification';
        document.getElementById('codeError').classList.remove('hidden');
    }
};

// Code inputs auto-focus
for (let i = 1; i <= 6; i++) {
    const input = document.getElementById(`code${i}`);
    if (input) {
        input.oninput = () => {
            input.value = input.value.toUpperCase();
            if (input.value && i < 6) {
                document.getElementById(`code${i+1}`).focus();
            }
        };
        input.onkeydown = (e) => {
            if (e.key === 'Backspace' && !input.value && i > 1) {
                document.getElementById(`code${i-1}`).focus();
            }
        };
    }
}

// JOIN LIVE
async function joinLive(liveId) {
    currentLiveId = liveId;
    
    try {
        const liveDoc = await getDoc(doc(db, 'lives', liveId));
        if (!liveDoc.exists()) {
            showToast('‚ùå Live introuvable');
            return;
        }
        
        const live = liveDoc.data();
        
        if (live.hostId === currentUser.uid) {
            currentRole = 'host';
        } else {
            currentRole = 'listener';
        }
        
        await dbSet(dbRef(rtdb, `lives/${liveId}/listeners/${currentUser.uid}`), {
            name: currentUser.displayName,
            photo: currentUser.photoURL,
            joinedAt: Date.now()
        });
        
        const currentListeners = live.stats?.currentListeners || 0;
        await updateDoc(doc(db, 'lives', liveId), {
            'stats.currentListeners': currentListeners + 1,
            'stats.peakListeners': Math.max(currentListeners + 1, live.stats?.peakListeners || 0)
        });
        
        showSection('liveRoomSection');
        document.getElementById('liveRoomTitle').textContent = live.title;
        
        setupLiveListeners(liveId);
        startLiveTimer(live.startedAt);
        
        if (currentRole === 'host' || currentRole === 'speaker') {
            document.getElementById('raiseHandBtn').style.display = 'none';
        } else {
            document.getElementById('raiseHandBtn').style.display = 'block';
        }
        
        showToast('‚úÖ Vous avez rejoint le live !');
    } catch (error) {
        console.error('Error joining live:', error);
        showToast('‚ùå Erreur lors de la connexion');
    }
}

function setupLiveListeners(liveId) {
    onValue(dbRef(rtdb, `lives/${liveId}/speakers`), (snapshot) => {
        updateStage(snapshot.val() || {});
    });
    
    onValue(dbRef(rtdb, `lives/${liveId}/listeners`), (snapshot) => {
        const el = document.getElementById('listenerCount');
        if (el) el.textContent = snapshot.size;
    });
    
    onChildAdded(dbRef(rtdb, `lives/${liveId}/chat`), (snapshot) => {
        const message = snapshot.val();
        addChatMessage(message);
    });
    
    onChildAdded(dbRef(rtdb, `lives/${liveId}/reactions`), (snapshot) => {
        const reaction = snapshot.val();
        showFloatingReaction(reaction.emoji);
    });
}

function updateStage(speakers) {
    const stage = document.getElementById('stage');
    if (!stage) return;
    
    stage.innerHTML = '';
    
    if (!speakers || Object.keys(speakers).length === 0) {
        stage.innerHTML = '<div style="text-align:center;color:var(--text-dim);padding:40px;">En attente de speakers...</div>';
        return;
    }
    
    Object.entries(speakers).forEach(([userId, speaker]) => {
        const speakerEl = document.createElement('div');
        speakerEl.className = 'speaker';
        
        const avatarClass = speaker.isSpeaking ? 'speaker-avatar speaking' : 'speaker-avatar';
        const roleText = speaker.role === 'host' ? 'üëë H√¥te' : 'üé§ Speaker';
        
        speakerEl.innerHTML = `
            <div class="${avatarClass}">
                <img src="${speaker.photo || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(speaker.name)}" alt="${speaker.name}">
            </div>
            <div class="speaker-name">${speaker.name}</div>
            <div class="speaker-role">${roleText}</div>
        `;
        
        stage.appendChild(speakerEl);
    });
}

function startLiveTimer(startedAtTimestamp) {
    if (liveTimer) clearInterval(liveTimer);
    
    if (startedAtTimestamp && startedAtTimestamp.seconds) {
        liveStartTime = startedAtTimestamp.seconds * 1000;
    } else {
        liveStartTime = Date.now();
    }
    
    liveTimer = setInterval(() => {
        const elapsed = Date.now() - liveStartTime;
        const h = Math.floor(elapsed / 3600000).toString().padStart(2, '0');
        const m = Math.floor((elapsed % 3600000) / 60000).toString().padStart(2, '0');
        const s = Math.floor((elapsed % 60000) / 1000).toString().padStart(2, '0');
        
        const el = document.getElementById('liveTimer');
        if (el) el.textContent = `${h}:${m}:${s}`;
    }, 1000);
}

window.leaveLive = async function() {
    if (!confirm('Quitter le live ?')) return;
    
    try {
        if (liveTimer) clearInterval(liveTimer);
        
        if (currentLiveId && currentUser) {
            await dbRemove(dbRef(rtdb, `lives/${currentLiveId}/listeners/${currentUser.uid}`));
            
            const liveDoc = await getDoc(doc(db, 'lives', currentLiveId));
            if (liveDoc.exists()) {
                const live = liveDoc.data();
                const newCount = Math.max(0, (live.stats?.currentListeners || 1) - 1);
                await updateDoc(doc(db, 'lives', currentLiveId), {
                    'stats.currentListeners': newCount
                });
            }
        }
        
        showSection('exploreSection');
        currentLiveId = null;
        currentRole = 'listener';
    } catch (error) {
        console.error('Error leaving live:', error);
    }
};

// CREATE LIVE
document.getElementById('createLiveBtn').onclick = () => {
    showSection('createSection');
    resetWizard();
};

document.getElementById('wizardBackBtn').onclick = () => {
    if (currentStep === 1) {
        showSection('exploreSection');
    } else {
        goToStep(currentStep - 1);
    }
};

function resetWizard() {
    currentStep = 1;
    wizardData.title = '';
    wizardData.description = '';
    wizardData.category = 'tech';
    wizardData.timing = 'now';
    wizardData.scheduledTime = null;
    wizardData.duration = 3600;
    wizardData.isPublic = true;
    wizardData.accessCode = generateCode();
    wizardData.settings = {
        chatEnabled: true,
        qaMode: false,
        allowHandRaise: true,
        showListenerCount: true
    };
    
    document.getElementById('liveTitle').value = '';
    document.getElementById('liveDesc').value = '';
    document.getElementById('liveCategory').value = 'tech';
    
    goToStep(1);
}

window.goToStep = function(step) {
    currentStep = step;
    
    document.querySelectorAll('.wizard-step').forEach(s => s.classList.remove('active'));
    document.getElementById(`step${step}`).classList.add('active');
    
    document.querySelectorAll('.progress-step').forEach((s, i) => {
        if (i < step) s.classList.add('active');
        else s.classList.remove('active');
    });
    
    document.getElementById('progressFill').style.width = `${(step / 4) * 100}%`;
    
    if (step === 4) updateSummary();
};

window.validateStep1 = function() {
    const title = document.getElementById('liveTitle').value.trim();
    if (!title || title.length < 3) {
        showToast('‚ùå Le titre doit faire au moins 3 caract√®res');
        return;
    }
    wizardData.title = title;
    wizardData.description = document.getElementById('liveDesc').value.trim();
    wizardData.category = document.getElementById('liveCategory').value;
    goToStep(2);
};

document.getElementById('timingNow').onclick = () => {
    wizardData.timing = 'now';
    document.querySelectorAll('.timing-card').forEach(c => c.classList.remove('selected'));
    document.getElementById('timingNow').classList.add('selected');
    document.getElementById('scheduleInputs').classList.add('hidden');
    document.getElementById('calendarSection').classList.add('hidden');
};

document.getElementById('timingLater').onclick = () => {
    wizardData.timing = 'scheduled';
    document.querySelectorAll('.timing-card').forEach(c => c.classList.remove('selected'));
    document.getElementById('timingLater').classList.add('selected');
    document.getElementById('scheduleInputs').classList.remove('hidden');
    document.getElementById('calendarSection').classList.remove('hidden');
    
    const now = new Date();
    now.setMinutes(now.getMinutes() + 30);
    document.getElementById('scheduleTime').min = new Date().toISOString().slice(0, 16);
    document.getElementById('scheduleTime').value = now.toISOString().slice(0, 16);
};

document.getElementById('privacyPublic').onclick = () => {
    wizardData.isPublic = true;
    document.querySelectorAll('.privacy-card').forEach(c => c.classList.remove('selected'));
    document.getElementById('privacyPublic').classList.add('selected');
    document.getElementById('codeSection').classList.add('hidden');
};

document.getElementById('privacyPrivate').onclick = () => {
    wizardData.isPublic = false;
    wizardData.accessCode = generateCode();
    document.querySelectorAll('.privacy-card').forEach(c => c.classList.remove('selected'));
    document.getElementById('privacyPrivate').classList.add('selected');
    document.getElementById('codeSection').classList.remove('hidden');
    document.getElementById('accessCode').textContent = wizardData.accessCode;
};

window.copyCode = function() {
    navigator.clipboard.writeText(wizardData.accessCode);
    showToast('üìã Code copi√© !');
};

window.downloadCalendar = function() {
    const scheduleInput = document.getElementById("scheduleTime");
    const scheduleValue = scheduleInput ? scheduleInput.value : null;
    
    if (!scheduleValue) {
        showToast("‚ùå Veuillez choisir une date et heure");
        return;
    }
    
    const scheduledDate = new Date(scheduleValue);
    if (scheduledDate < new Date()) {
        showToast("‚ùå La date doit √™tre dans le futur");
        return;
    }
    
    const liveData = {
        liveId: "temp_" + Date.now(),
        title: document.getElementById("liveTitle").value || "Mon Live",
        description: document.getElementById("liveDesc").value || "",
        scheduledAt: { seconds: scheduledDate.getTime() / 1000 },
        isPublic: wizardData.isPublic,
        accessCode: wizardData.accessCode
    };
    generateICS(liveData);
};

function generateICS(liveData) {
    const startDate = new Date(liveData.scheduledAt.seconds * 1000);
    const endDate = new Date(startDate.getTime() + (wizardData.duration * 1000));
    
    const formatDate = (date) => {
        return date.toISOString().replace(/[-:]/g, "").split(".")[0] + "Z";
    };
    
    const liveUrl = `https://sis-say-it-safely-pi.vercel.app/sisliveaudio.html?live=${liveData.liveId}`;
    const description = `${liveData.description}\\n\\nRejoindre: ${liveUrl}${!liveData.isPublic ? "\\nCode: " + liveData.accessCode : ""}`;
    
    const ics = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//SIS//Live Audio//FR
BEGIN:VEVENT
UID:${liveData.liveId}@sis-live-audio
DTSTART:${formatDate(startDate)}
DTEND:${formatDate(endDate)}
SUMMARY:${liveData.title}
DESCRIPTION:${description}
LOCATION:SIS Live Audio
BEGIN:VALARM
TRIGGER:-PT15M
DESCRIPTION:Le live commence dans 15 minutes
END:VALARM
BEGIN:VALARM
TRIGGER:-PT1H
DESCRIPTION:Le live commence dans 1 heure
END:VALARM
END:VEVENT
END:VCALENDAR`;
    
    const blob = new Blob([ics], { type: "text/calendar;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = liveData.title.replace(/[^a-z0-9]/gi, "_") + ".ics";
    a.click();
    URL.revokeObjectURL(url);
    showToast("üìÖ √âv√©nement ajout√© au calendrier !");
}

function updateSummary() {
    document.getElementById('summaryTitle').textContent = wizardData.title;
    document.getElementById('summaryDesc').textContent = wizardData.description || 'Aucune description';
    
    const details = [];
    details.push(`üìÇ Cat√©gorie: ${wizardData.category}`);
    details.push(`${wizardData.timing === 'now' ? 'üî¥ D√©marre imm√©diatement' : 'üìÖ Programm√©'}`);
    details.push(`${wizardData.isPublic ? 'üåç Public' : 'üîí Priv√© (Code: ' + wizardData.accessCode + ')'}`);
    
    document.getElementById('summaryDetails').innerHTML = details.map(d => `<p>${d}</p>`).join('');
}

window.createLive = async function() {
    try {
        wizardData.title = document.getElementById('liveTitle').value.trim();
        wizardData.description = document.getElementById('liveDesc').value.trim();
        wizardData.category = document.getElementById('liveCategory').value;
        
        if (!wizardData.title) {
            showToast('‚ùå Titre requis');
            return;
        }
        
        if (wizardData.timing === 'scheduled') {
            const scheduleTime = document.getElementById('scheduleTime').value;
            if (!scheduleTime) {
                showToast('‚ùå Date/heure requise');
                return;
            }
            wizardData.scheduledTime = new Date(scheduleTime);
        }
        
        showToast('‚è≥ Cr√©ation en cours...');
        
        const liveId = `live_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        
        const liveData = {
            liveId,
            hostId: currentUser.uid,
            hostName: currentUser.displayName,
            hostPhoto: currentUser.photoURL,
            title: wizardData.title,
            description: wizardData.description,
            category: wizardData.category,
            isPublic: wizardData.isPublic,
            accessCode: wizardData.isPublic ? null : wizardData.accessCode,
            status: wizardData.timing === 'now' ? 'live' : 'scheduled',
            scheduledAt: wizardData.timing === 'scheduled' ? Timestamp.fromDate(wizardData.scheduledTime) : null,
            startedAt: wizardData.timing === 'now' ? Timestamp.now() : null,
            settings: wizardData.settings,
            stats: {
                currentListeners: 0,
                peakListeners: 0,
                totalMessages: 0
            },
            createdAt: Timestamp.now()
        };
        
        await setDoc(doc(db, 'lives', liveId), liveData);
        
        if (wizardData.timing === 'now') {
            await dbSet(dbRef(rtdb, `lives/${liveId}/speakers/${currentUser.uid}`), {
                role: 'host',
                name: currentUser.displayName,
                photo: currentUser.photoURL,
                isMuted: false,
                isSpeaking: false,
                joinedAt: Date.now()
            });
            
            showToast('‚úÖ Live cr√©√© ! D√©marrage...');
            setTimeout(() => joinLive(liveId), 1000);
        } else {
            showToast('‚úÖ Live programm√© avec succ√®s !');
            showSection('exploreSection');
        }
        
    } catch (error) {
        console.error('Error creating live:', error);
        showToast('‚ùå Erreur lors de la cr√©ation');
    }
};

// CHAT
window.switchTab = function(tab) {
    document.querySelectorAll('.live-tab').forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');
    
    document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
    if (tab === 'chat') {
        document.getElementById('chatPane').classList.add('active');
    } else {
        document.getElementById('participantsPane').classList.add('active');
    }
};

window.sendMessage = async function() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    
    if (!message || !currentLiveId) return;
    
    try {
        await dbPush(dbRef(rtdb, `lives/${currentLiveId}/chat`), {
            userId: currentUser.uid,
            userName: currentUser.displayName,
            userPhoto: currentUser.photoURL,
            message: message,
            timestamp: Date.now()
        });
        
        input.value = '';
    } catch (error) {
        console.error('Error sending message:', error);
    }
};

function addChatMessage(msg) {
    const messages = document.getElementById('chatMessages');
    if (!messages) return;
    
    const messageEl = document.createElement('div');
    messageEl.className = 'chat-message';
    
    const timeAgo = Math.floor((Date.now() - msg.timestamp) / 60000);
    const timeText = timeAgo < 1 ? "√Ä l'instant" : `${timeAgo} min`;
    
    messageEl.innerHTML = `
        <img src="${msg.userPhoto}" alt="${msg.userName}" class="message-avatar">
        <div class="message-content">
            <div class="message-header">
                <span class="message-author">${msg.userName}</span>
                <span class="message-time">${timeText}</span>
            </div>
            <div class="message-text">${msg.message}</div>
        </div>
    `;
    
    messages.appendChild(messageEl);
    messages.scrollTop = messages.scrollHeight;
}

window.sendReaction = async function(emoji) {
    if (!currentLiveId) return;
    
    try {
        await dbPush(dbRef(rtdb, `lives/${currentLiveId}/reactions`), {
            userId: currentUser.uid,
            emoji: emoji,
            timestamp: Date.now()
        });
    } catch (error) {
        console.error('Error sending reaction:', error);
    }
};

function showFloatingReaction(emoji) {
    const reaction = document.createElement('div');
    reaction.className = 'floating-reaction';
    reaction.textContent = emoji;
    reaction.style.left = Math.random() * 80 + 10 + '%';
    
    const container = document.getElementById('reactionsContainer');
    if (container) {
        container.appendChild(reaction);
        setTimeout(() => reaction.remove(), 3000);
    }
}

window.raiseHand = async function() {
    if (!currentLiveId) return;
    
    try {
        await dbSet(dbRef(rtdb, `lives/${currentLiveId}/handRaiseRequests/${currentUser.uid}`), {
            name: currentUser.displayName,
            photo: currentUser.photoURL,
            requestedAt: Date.now()
        });
        
        showToast('‚úã Demande envoy√©e !');
        document.getElementById('raiseHandBtn').textContent = '‚è≥ En attente...';
        document.getElementById('raiseHandBtn').disabled = true;
    } catch (error) {
        console.error('Error raising hand:', error);
    }
};

window.openMenu = function() {
    showToast('‚öôÔ∏è Menu - En d√©veloppement');
};

console.log('üéôÔ∏è SIS Live Audio - COMPLET ET FONCTIONNEL');
</script>
</body>
</html>
