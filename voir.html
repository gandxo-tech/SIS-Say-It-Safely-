<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>SIS ‚Äì Voir les messages</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root{
      --body-bg:#f6fbfd;
      --container-bg:#fff;
      --text-color:#333333;
      --accent-color:#0072b5;
      --secondary-accent-color:#1cc7e4;
      --accent-hover:#0056b3;
      --input-bg:#ffffff;
      --input-border:#1cc7e4;
      --msg-item-bg:#e5f9fc;
      --msg-item-hover-shadow: rgba(28,199,228,0.4);
      --no-msg-color:#d61616;
      --shadow-light: rgba(0,0,0,0.08);
      --download-btn-bg:#00bfff;
      --download-btn-hover:#0099cc;
      --container-max-width:440px;
      --gutter:20px;
      --radius:14px;
      --touch-size:44px;
    }
    body.dark-mode{
      --body-bg:#121822;
      --container-bg:#1a222c;
      --text-color:#f0f0f0;
      --accent-color:#5d9cec;
      --secondary-accent-color:#00fff7;
      --accent-hover:#4a80d4;
      --input-bg:#283340;
      --input-border:#303a4b;
      --msg-item-bg:#2b3743;
      --msg-item-hover-shadow: rgba(0,255,247,0.12);
      --no-msg-color:#ff8888;
      --shadow-light: rgba(0,0,0,0.16);
      --download-btn-bg:#00fff7;
      --download-btn-hover:#00b6b6;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background:var(--body-bg);
      color:var(--text-color);
      margin:0;
      padding:0;
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      transition:background 0.35s, color 0.35s;
      padding-top:84px;
    }
    .menu-container{
      position:fixed; top:16px; left:16px; z-index:1200; display:flex; flex-direction:column; gap:8px;
    }
    .mode-toggle-container{
      position:fixed; top:16px; right:16px; z-index:1200; display:flex; align-items:center; gap:8px;
    }
    .menu-toggle{
      display:flex; align-items:center; justify-content:center;
      width:var(--touch-size); height:var(--touch-size); background:var(--accent-color);
      border-radius:50%; cursor:pointer; box-shadow:0 6px 20px var(--shadow-light);
      border:none;
    }
    .menu-toggle .bar{ display:block; width:20px; height:2.5px; background:#fff; margin:3px 0; transition:transform .25s, opacity .25s; }
    .menu-toggle.active .bar:nth-child(1){ transform: translateY(7px) rotate(45deg); }
    .menu-toggle.active .bar:nth-child(2){ opacity:0; transform:scale(0); }
    .menu-toggle.active .bar:nth-child(3){ transform: translateY(-7px) rotate(-45deg); }
    .menu-links{
      position:fixed; top:64px; left:16px; width:220px; background:var(--container-bg);
      border-radius:12px; list-style:none; padding:8px 0; margin:0; box-shadow:0 10px 30px var(--shadow-light);
      transform-origin:top; transform:scaleY(0); transition:transform .22s, opacity .22s;
      opacity:0; z-index:1100;
    }
    .menu-links.active{ transform:scaleY(1); opacity:1; }
    .menu-links li a{ display:block; padding:12px 16px; color:var(--text-color); text-decoration:none; font-size:15px; }
    .menu-links li a:hover{ background:var(--msg-item-bg); }
    .mode-label { font-size: 0.9em; margin: 0 8px; }
    .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--input-border); transition: .4s; border-radius: 28px; }
    .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--secondary-accent-color); }
    input:checked + .slider:before { transform: translateX(22px); }
    .container{
      margin: 2vh auto;
      background:var(--container-bg);
      padding:28px;
      border-radius:var(--radius);
      width: calc(100% - (var(--gutter)*2));
      max-width:var(--container-max-width);
      box-shadow:0 12px 36px var(--shadow-light);
      display:flex; flex-direction:column; align-items:stretch; gap:12px;
      transition:all .3s;
    }
    h2{ color:var(--accent-color); margin:0 0 6px 0; font-size:1.15rem; text-align:center; }
    .description {font-size:1rem;text-align:center;color:var(--accent-color);margin-bottom:16px;}
    .pseudo-row {display:flex;align-items:center;gap:5px;}
    input[type="text"]{
      width:100%; padding:12px 14px; border-radius:10px; border:1px solid var(--input-border);
      background:var(--input-bg); color:var(--text-color); font-size:16px; text-align:center;
      transition:border-color .2s, background .2s;
    }
    input[type="text"]:focus{ outline:none; border-color:var(--secondary-accent-color); box-shadow:0 6px 18px rgba(0,0,0,0.04); }
    .clear-btn {
      background: transparent;
      border: none;
      color: var(--accent-color);
      font-size: 1.3em;
      cursor: pointer;
      padding: 0 6px;
      border-radius: 50%;
      transition: background 0.2s;
      line-height: 1;
      height: 32px;
      width:32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .clear-btn:hover {background: #e7faff;}
    button{
      background:var(--secondary-accent-color); color:var(--container-bg); border:none;
      padding:10px 14px; border-radius:10px; font-size:16px; cursor:pointer; align-self:center;
      transition:background .18s, transform .08s; min-width:140px;
    }
    button:hover{ background:var(--accent-hover); transform:translateY(-1px); }
    .msg-list{ margin-top:6px; width:100%; display:flex; flex-direction:column; gap:18px; }
    .msg-item{
      background:var(--msg-item-bg); padding:14px; border-radius:12px; color:var(--text-color);
      position:relative; border-left:4px solid var(--secondary-accent-color); transition:box-shadow .18s, background .25s;
      display:flex; flex-direction:column; gap:8px; word-break:break-word; white-space:pre-wrap;
    }
    .msg-item:hover{ box-shadow:0 10px 30px var(--msg-item-hover-shadow); }
    .msg-date{ color:var(--secondary-accent-color); font-size:13px; margin-left:auto; text-align:right; min-width:80px; }
    .msg-actions{ display:flex; justify-content:flex-end; gap:8px; margin-top:6px; }
    .download-msg-btn{
      background:var(--download-btn-bg); color:var(--container-bg); border:none; border-radius:8px;
      padding:8px 10px; font-size:13px; cursor:pointer; transition:background .18s; min-width:fit-content;
    }
    .download-msg-btn:hover{ background:var(--download-btn-hover); }
    .no-msg{ color:var(--no-msg-color); margin-top:8px; text-align:center; font-weight:600; }
    .menu-toggle:focus, .download-msg-btn:focus, button:focus, input:focus{ outline:3px solid rgba(0,140,200,0.12); outline-offset:2px; }
    @media (max-width:1024px){
      :root{ --container-max-width:520px; }
      .menu-links{ width:240px; left:12px; }
    }
    @media (max-width:768px){
      body{ padding-top:72px; }
      .container{ padding:18px; border-radius:12px; width:calc(100% - 24px); max-width:720px; gap:10px; }
      input[type="text"]{ font-size:15px; padding:10px; }
      button{ min-width:120px; font-size:15px; padding:10px 12px; }
      .menu-links{ left:10px; width:calc(100% - 20px); top:64px; border-radius:10px; }
      .menu-toggle{ width:46px; height:46px; }
      .mode-toggle-container{ top:12px; right:12px; gap:6px; }
      .msg-date{ font-size:12px; min-width:72px; }
    }
    @media (max-width:480px){
      body{ padding-top:72px; }
      .container{ padding:14px; border-radius:10px; width:calc(100% - 8px); gap:10px; }
      h2{ font-size:1.02rem; }
      .menu-links{ top:60px; left:8px; width:calc(100% - 16px); padding:8px; }
      .mode-label{ display:none; }
      .menu-toggle{ width:44px; height:44px; }
      .download-msg-btn{ padding:8px 10px; font-size:13px; }
      .msg-item{ padding:12px; border-radius:10px; }
    }
  </style>
</head>
<body>
  <div class="menu-container">
    <button class="menu-toggle" aria-expanded="false" aria-controls="menu-links" aria-label="Ouvrir le menu">
      <span class="bar"></span>
      <span class="bar"></span>
      <span class="bar"></span>
    </button>
    <ul class="menu-links" id="menu-links">
      <li><a href="index.html">Accueil</a></li>
      <li><a href="avis.html">√Ä propos</a></li>
    </ul>
  </div>

  <div class="mode-toggle-container">
    <span class="mode-label">Clair</span>
    <label class="switch">
      <input type="checkbox" id="mode-toggle-checkbox" aria-label="Mode sombre/clair">
      <span class="slider"></span>
    </label>
    <span class="mode-label">Sombre</span>
  </div>

  <div class="container" role="main">
    <h2>üì¨ Mes messages re√ßus</h2>
    <p class="description">
      Entre ton pseudo exact pour voir tous les messages anonymes envoy√©s √† toi.<br>
      Tu pourras aussi t√©l√©charger chaque message en image.
    </p>
    <div class="pseudo-row">
      <input type="text" id="pseudo" placeholder="Ton pseudo exact" aria-label="Pseudo exact">
      <button class="clear-btn" id="clearPseudo" title="Effacer le pseudo" aria-label="Effacer le pseudo" tabindex="0" type="button" style="display:none;">√ó</button>
    </div>
    <button id="voirBtn">Voir mes messages</button>
    <div class="msg-list" id="msgList"></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBqk3L_qkolD41H3yvHEzz4O-Sr15I-Tko",
      authDomain: "gandxoanonymous.firebaseapp.com",
      projectId: "gandxoanonymous",
      storageBucket: "gandxoanonymous.appspot.com",
      messagingSenderId: "836606625364",
      appId: "1:836606625364:web:7150571998131c41c0cfc1",
      measurementId: "G-97TCHJ33KW"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    document.getElementById('voirBtn').onclick = async () => {
      const pseudo = document.getElementById('pseudo').value.trim();
      const msgList = document.getElementById('msgList');
      msgList.innerHTML = "";

      if (!pseudo) { alert("Entre ton pseudo !"); return; }

      try {
        const q = query(collection(db, "messages"), where("to", "==", pseudo), orderBy("createdAt", "desc"));
        const snap = await getDocs(q);

        if (snap.empty) {
          msgList.innerHTML = `<div class="no-msg">Aucun message re√ßu pour ce pseudo...üôÖ‚Äç‚ôÇÔ∏èü§∑‚Äç‚ôÇÔ∏è</div>`;
        } else {
          snap.forEach(doc => {
            const d = doc.data();
            let dateTxt = d.createdAt && d.createdAt.toDate ? d.createdAt.toDate().toLocaleString() : "";
            const divId = `msg-${doc.id}`;
            msgList.innerHTML += `
              <div class="msg-item" id="${divId}">
                <div>${d.message}</div>
                <div class="msg-date">${dateTxt}</div>
                <div class="msg-actions">
                  <button class="download-msg-btn" data-msgid="${divId}">T√©l√©charger ce message (image)</button>
                </div>
              </div>
            `;
          });
        }
      } catch (e) {
        msgList.innerHTML = `<div class="no-msg">Erreur : ${e.message}</div>`;
      }
    };
  </script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const modeToggle = document.getElementById('mode-toggle-checkbox');
      const body = document.body;
      const menuToggle = document.querySelector('.menu-toggle');
      const menuLinks = document.querySelector('.menu-links');
      const pseudoInput = document.getElementById('pseudo');
      const clearBtn = document.getElementById('clearPseudo');

      // Mode sombre/claire
      function applyMode(isDarkMode) {
        if(isDarkMode) body.classList.add('dark-mode');
        else body.classList.remove('dark-mode');
      }
      const savedMode = localStorage.getItem('mode');
      if(savedMode === 'dark') { modeToggle.checked = true; applyMode(true); } else { applyMode(false); }
      modeToggle.addEventListener('change', () => {
        if(modeToggle.checked) { localStorage.setItem('mode','dark'); applyMode(true); }
        else { localStorage.setItem('mode','light'); applyMode(false); }
      });

      // Menu hamburger
      menuToggle.addEventListener('click', () => {
        const isExpanded = menuToggle.getAttribute('aria-expanded') === 'true';
        menuToggle.setAttribute('aria-expanded', !isExpanded);
        menuToggle.classList.toggle('active');
        menuLinks.classList.toggle('active');
        if(menuLinks.classList.contains('active')) menuLinks.querySelector('a').focus();
      });
      menuLinks.addEventListener('click', (e) => {
        if (e.target.tagName === 'A') {
          menuToggle.classList.remove('active');
          menuLinks.classList.remove('active');
          menuToggle.setAttribute('aria-expanded', 'false');
        }
      });

      // Download img SANS bouton dans le rendu html2canvas
      document.getElementById('msgList').addEventListener('click', async (e) => {
        const btn = e.target.closest('.download-msg-btn');
        if (!btn) return;
        const msgId = btn.dataset.msgid;
        const msgDiv = document.getElementById(msgId);
        if (!msgDiv) return;
        // Masque le bouton pour la capture
        btn.style.visibility = "hidden";
        setTimeout(() => {
          html2canvas(msgDiv).then(canvas => {
            btn.style.visibility = "visible";
            const link = document.createElement('a');
            link.href = canvas.toDataURL('image/png');
            link.download = 'messageSIS.png';
            link.click();
          });
        }, 80); // petit d√©lai pour update DOM
      });

      // Effacer pseudo facilement
      pseudoInput.addEventListener('input', function() {
        clearBtn.style.display = this.value ? 'inline-flex' : 'none';
      });
      clearBtn.addEventListener('click', function() {
        pseudoInput.value = '';
        pseudoInput.focus();
        clearBtn.style.display = 'none';
      });
    });
</script>
</body>
</html>